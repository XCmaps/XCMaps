(()=>{var e,t={1903:()=>{},4394:()=>{},5358:(e,t,o)=>{var n={"./af":5177,"./af.js":5177,"./ar":1509,"./ar-dz":1488,"./ar-dz.js":1488,"./ar-kw":8676,"./ar-kw.js":8676,"./ar-ly":2353,"./ar-ly.js":2353,"./ar-ma":4496,"./ar-ma.js":4496,"./ar-ps":6947,"./ar-ps.js":6947,"./ar-sa":2682,"./ar-sa.js":2682,"./ar-tn":9756,"./ar-tn.js":9756,"./ar.js":1509,"./az":5533,"./az.js":5533,"./be":8959,"./be.js":8959,"./bg":7777,"./bg.js":7777,"./bm":4903,"./bm.js":4903,"./bn":1290,"./bn-bd":7357,"./bn-bd.js":7357,"./bn.js":1290,"./bo":1545,"./bo.js":1545,"./br":1470,"./br.js":1470,"./bs":4429,"./bs.js":4429,"./ca":7306,"./ca.js":7306,"./cs":6464,"./cs.js":6464,"./cv":3635,"./cv.js":3635,"./cy":4226,"./cy.js":4226,"./da":3601,"./da.js":3601,"./de":7853,"./de-at":6111,"./de-at.js":6111,"./de-ch":4697,"./de-ch.js":4697,"./de.js":7853,"./dv":708,"./dv.js":708,"./el":4691,"./el.js":4691,"./en-au":3872,"./en-au.js":3872,"./en-ca":8298,"./en-ca.js":8298,"./en-gb":6195,"./en-gb.js":6195,"./en-ie":6584,"./en-ie.js":6584,"./en-il":5543,"./en-il.js":5543,"./en-in":9033,"./en-in.js":9033,"./en-nz":9402,"./en-nz.js":9402,"./en-sg":3004,"./en-sg.js":3004,"./eo":2934,"./eo.js":2934,"./es":7650,"./es-do":838,"./es-do.js":838,"./es-mx":7730,"./es-mx.js":7730,"./es-us":6575,"./es-us.js":6575,"./es.js":7650,"./et":3035,"./et.js":3035,"./eu":3508,"./eu.js":3508,"./fa":119,"./fa.js":119,"./fi":527,"./fi.js":527,"./fil":5995,"./fil.js":5995,"./fo":2477,"./fo.js":2477,"./fr":5498,"./fr-ca":6435,"./fr-ca.js":6435,"./fr-ch":7892,"./fr-ch.js":7892,"./fr.js":5498,"./fy":7071,"./fy.js":7071,"./ga":1734,"./ga.js":1734,"./gd":217,"./gd.js":217,"./gl":7329,"./gl.js":7329,"./gom-deva":2124,"./gom-deva.js":2124,"./gom-latn":3383,"./gom-latn.js":3383,"./gu":5050,"./gu.js":5050,"./he":1713,"./he.js":1713,"./hi":3861,"./hi.js":3861,"./hr":6308,"./hr.js":6308,"./hu":609,"./hu.js":609,"./hy-am":7160,"./hy-am.js":7160,"./id":4063,"./id.js":4063,"./is":9374,"./is.js":9374,"./it":8383,"./it-ch":1827,"./it-ch.js":1827,"./it.js":8383,"./ja":3827,"./ja.js":3827,"./jv":9722,"./jv.js":9722,"./ka":1794,"./ka.js":1794,"./kk":7088,"./kk.js":7088,"./km":6870,"./km.js":6870,"./kn":4451,"./kn.js":4451,"./ko":3164,"./ko.js":3164,"./ku":8174,"./ku-kmr":6181,"./ku-kmr.js":6181,"./ku.js":8174,"./ky":8474,"./ky.js":8474,"./lb":9680,"./lb.js":9680,"./lo":5867,"./lo.js":5867,"./lt":5766,"./lt.js":5766,"./lv":9532,"./lv.js":9532,"./me":8076,"./me.js":8076,"./mi":1848,"./mi.js":1848,"./mk":306,"./mk.js":306,"./ml":3739,"./ml.js":3739,"./mn":9053,"./mn.js":9053,"./mr":6169,"./mr.js":6169,"./ms":3386,"./ms-my":2297,"./ms-my.js":2297,"./ms.js":3386,"./mt":7075,"./mt.js":7075,"./my":2264,"./my.js":2264,"./nb":2274,"./nb.js":2274,"./ne":8235,"./ne.js":8235,"./nl":2572,"./nl-be":3784,"./nl-be.js":3784,"./nl.js":2572,"./nn":4566,"./nn.js":4566,"./oc-lnc":9330,"./oc-lnc.js":9330,"./pa-in":9849,"./pa-in.js":9849,"./pl":4418,"./pl.js":4418,"./pt":9834,"./pt-br":8303,"./pt-br.js":8303,"./pt.js":9834,"./ro":4457,"./ro.js":4457,"./ru":2271,"./ru.js":2271,"./sd":1221,"./sd.js":1221,"./se":3478,"./se.js":3478,"./si":7538,"./si.js":7538,"./sk":5784,"./sk.js":5784,"./sl":6637,"./sl.js":6637,"./sq":6794,"./sq.js":6794,"./sr":5719,"./sr-cyrl":3322,"./sr-cyrl.js":3322,"./sr.js":5719,"./ss":6e3,"./ss.js":6e3,"./sv":1011,"./sv.js":1011,"./sw":748,"./sw.js":748,"./ta":1025,"./ta.js":1025,"./te":1885,"./te.js":1885,"./tet":8861,"./tet.js":8861,"./tg":6571,"./tg.js":6571,"./th":5802,"./th.js":5802,"./tk":9527,"./tk.js":9527,"./tl-ph":9231,"./tl-ph.js":9231,"./tlh":1052,"./tlh.js":1052,"./tr":5096,"./tr.js":5096,"./tzl":9846,"./tzl.js":9846,"./tzm":1765,"./tzm-latn":7711,"./tzm-latn.js":7711,"./tzm.js":1765,"./ug-cn":8414,"./ug-cn.js":8414,"./uk":6618,"./uk.js":6618,"./ur":158,"./ur.js":158,"./uz":7609,"./uz-latn":2475,"./uz-latn.js":2475,"./uz.js":7609,"./vi":1135,"./vi.js":1135,"./x-pseudo":4051,"./x-pseudo.js":4051,"./yo":2218,"./yo.js":2218,"./zh-cn":2648,"./zh-cn.js":2648,"./zh-hk":1632,"./zh-hk.js":1632,"./zh-mo":1541,"./zh-mo.js":1541,"./zh-tw":304,"./zh-tw.js":304};function i(e){var t=a(e);return o(t)}function a(e){if(!o.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}i.keys=function(){return Object.keys(n)},i.resolve=a,e.exports=i,i.id=5358},8109:(e,t,o)=>{"use strict";console.log("L.Control.Layers.Tree has been loaded!"),function(e){if(void 0===e)throw new Error("Leaflet must be included first");e.Control.Layers.Tree=e.Control.Layers.extend({options:{closedSymbol:"+",openedSymbol:"&minus;",spaceSymbol:" ",selectorBack:!1,namedToggle:!1,collapseAll:"",expandAll:"",labelIsSelector:"both"},_initClassesNames:function(){this.cls={children:"leaflet-layerstree-children",childrenNopad:"leaflet-layerstree-children-nopad",hide:"leaflet-layerstree-hide",closed:"leaflet-layerstree-closed",opened:"leaflet-layerstree-opened",space:"leaflet-layerstree-header-space",pointer:"leaflet-layerstree-header-pointer",header:"leaflet-layerstree-header",neverShow:"leaflet-layerstree-nevershow",node:"leaflet-layerstree-node",name:"leaflet-layerstree-header-name",label:"leaflet-layerstree-header-label",selAllCheckbox:"leaflet-layerstree-sel-all-checkbox"}},initialize:function(t,o,n){this._scrollTop=0,this._initClassesNames(),this._baseTree=null,this._overlaysTree=null,e.Util.setOptions(this,n),e.Control.Layers.prototype.initialize.call(this,null,null,n),this._setTrees(t,o)},setBaseTree:function(e){return this._setTrees(e)},setOverlayTree:function(e){return this._setTrees(void 0,e)},addBaseLayer:function(e,t){throw"addBaseLayer is disabled"},addOverlay:function(e,t){throw"addOverlay is disabled"},removeLayer:function(e){throw"removeLayer is disabled"},collapse:function(){return this._scrollTop=this._sect().scrollTop,e.Control.Layers.prototype.collapse.call(this)},expand:function(){e.Control.Layers.prototype.expand.call(this),this._sect().scrollTop=this._scrollTop},onAdd:function(t){function o(e){e._layersTreeName&&(i.innerHTML=e._layersTreeName)}var n=e.Control.Layers.prototype.onAdd.call(this,t);if(this.options.namedToggle){var i=this._container.getElementsByClassName("leaflet-control-layers-toggle")[0];e.DomUtil.addClass(i,"leaflet-layerstree-named-toggle"),t.eachLayer((function(e){o(e)})),t.on("baselayerchange",(function(e){o(e.layer)}),this)}return n},expandTree:function(e){var t=e?this._overlaysList:this._baseLayersList;return t&&this._applyOnTree(t,!1),this._localExpand()},collapseTree:function(e){var t=e?this._overlaysList:this._baseLayersList;return t&&this._applyOnTree(t,!0),this._localExpand()},expandSelected:function(t){function o(t){var i=t.parentElement;if(i){if(e.DomUtil.hasClass(i,n.cls.children)&&!e.DomUtil.hasClass(t,n.cls.childrenNopad)&&e.DomUtil.removeClass(i,a),e.DomUtil.hasClass(i,n.cls.node)){var r=i.getElementsByClassName(n.cls.header)[0];n._applyOnTree(r,!1)}o(i)}}var n=this,i=t?this._overlaysList:this._baseLayersList;if(!i)return this;for(var a=this.cls.hide,r=this._layerControlInputs||i.getElementsByTagName("input"),s=0;s<r.length;s++){var l=r[s];this._getLayer&&!!this._getLayer(l.layerId).overlay!=!!t||l.checked&&o(l.parentElement.parentElement.parentElement.parentElement)}return this._localExpand()},_sect:function(){return this._section||this._form},_setTrees:function(e,t){var o=0;function n(e,t,i){return e&&e.layer&&(i||(e.layer._layersTreeName=e.name||e.label),t[o++]=e.layer),e&&e.children&&e.children.length&&e.children.forEach((function(e){n(e,t,i)})),t}function i(e){return Array.isArray(e)?{noShow:!0,children:e}:e}this._layerControlInputs&&(this._layerControlInputs=[]);for(var a=0;a<this._layers.length;++a)this._layers[a].layer.off("add remove",this._onLayerChange,this);this._layers=[],void 0!==e&&(this._baseTree=i(e)),void 0!==t&&(this._overlaysTree=i(t));var r=n(this._baseTree,{});for(var s in r)this._addLayer(r[s],s);var l=n(this._overlaysTree,{},!0);for(var c in l)this._addLayer(l[c],c,!0);return this._map?this._update():this},_localExpand:function(){if(this._map&&e.DomUtil.hasClass(this._container,"leaflet-control-layers-expanded")){var t=this._sect().scrollTop;this.expand(),this._sect().scrollTop=t,this._scrollTop=t}return this},_applyOnTree:function(t,o){[{cls:this.cls.children,hide:o},{cls:this.cls.opened,hide:o},{cls:this.cls.closed,hide:!o}].forEach((function(o){for(var n=t.getElementsByClassName(o.cls),i=0;i<n.length;i++){var a=n[i];e.DomUtil.hasClass(a,this.cls.childrenNopad)||(o.hide?e.DomUtil.addClass(a,this.cls.hide):e.DomUtil.removeClass(a,this.cls.hide))}}),this)},_addItem:function(e){},_update:function(){return this._container?(e.Control.Layers.prototype._update.call(this),this._addTreeLayout(this._baseTree,!1),this._addTreeLayout(this._overlaysTree,!0),this._localExpand()):this},_addTreeLayout:function(e,t){if(e){var o=t?this._overlaysList:this._baseLayersList;this._expandCollapseAll(t,this.options.collapseAll,this.collapseTree),this._expandCollapseAll(t,this.options.expandAll,this.expandTree),this._iterateTreeLayout(e,o,t,[],e.noShow),this._checkDisabledLayers&&this._checkDisabledLayers()}},_expandCollapseAll:function(t,o,n,i){var a=t?this._overlaysList:this._baseLayersList;if(i=i||this,o){var r=document.createElement("div");r.className="leaflet-layerstree-expand-collapse",a.appendChild(r),r.innerHTML=o,r.tabIndex=0,e.DomEvent.on(r,"click keydown",(function(e){"keydown"===e.type&&32!==e.keyCode||(r.blur(),n.call(i,t),this._localExpand())}),this)}},_iterateTreeLayout:function(t,o,n,i,a){if(t)if(t.html){_("div","leaflet-layerstree-html-container",o).innerHTML=t.html}else{var r,s=_("div",this.cls.header,o),l=_("span"),c=_("span"),d=_("span",this.cls.closed,l,this.options.closedSymbol),p=_("span",this.cls.opened,l,this.options.openedSymbol),m=_("span",this.cls.space,null,this.options.spaceSymbol);this.options.selectorBack?(l.insertBefore(m,d),s.appendChild(c),s.appendChild(l)):(l.appendChild(m),s.appendChild(l),s.appendChild(c)),t.selectAllCheckbox&&((r=this._createCheckboxElement(!1)).className+=" "+this.cls.selAllCheckbox);var h=this.cls.hide;if(t.children){var u=_("div",this.cls.children,o),f=t.layer?l:s;e.DomUtil.addClass(f,this.cls.pointer),f.tabIndex=0,e.DomEvent.on(f,"click keydown",(function(t){this._preventClick||"keydown"===t.type&&32!==t.keyCode||(f.blur(),e.DomUtil.hasClass(p,h)?(e.DomUtil.addClass(d,h),e.DomUtil.removeClass(p,h),e.DomUtil.removeClass(u,h)):(e.DomUtil.removeClass(d,h),e.DomUtil.addClass(p,h),e.DomUtil.addClass(u,h)),this._localExpand())}),this),r&&i.splice(0,0,o),t.children.forEach((function(e){var t=_("div",this.cls.node,u);this._iterateTreeLayout(e,t,n,i)}),this),r&&i.splice(0,1)}else e.DomUtil.addClass(l,this.cls.neverShow);var y,g=_(t.layer&&("both"===this.options.labelIsSelector||n&&"overlay"===this.options.labelIsSelector||!n&&"base"===this.options.labelIsSelector)?"label":"span",this.cls.label,c);if(t.layer){var w,b=this._map.hasLayer(t.layer),v=n?t.radioGroup:"leaflet-base-layers_"+e.Util.stamp(this);v?w=this._createRadioElement(v,b):S(w=this._createCheckboxElement(b),this),this._layerControlInputs&&this._layerControlInputs.push(w),w.layerId=e.Util.stamp(t.layer),e.DomEvent.on(w,"click",this._onInputClick,this),g.appendChild(w)}t.selectAllCheckbox&&(g.appendChild(r),("string"==typeof(y=t.selectAllCheckbox)||y instanceof String)&&(r.title=t.selectAllCheckbox),e.DomEvent.on(r,"click",(function(e){e.stopPropagation(),D(r.checked,this)}),this),k(o),S(r,this)),_("span",this.cls.name,g,t.label),e.DomUtil.addClass(t.collapsed?p:d,h),t.collapsed&&u&&e.DomUtil.addClass(u,h),a&&(e.DomUtil.addClass(s,this.cls.neverShow),e.DomUtil.addClass(u,this.cls.childrenNopad));var L=t.eventedClasses;L instanceof Array||(L=[L]);for(var C=0;C<L.length;C++){var x=L[C];if(x&&x.className){var T=o.querySelector("."+x.className);T&&e.DomEvent.on(T,x.event||"click",function(e){return function(n){n.stopPropagation();var i,a=(i=e)&&"[object Function]"==={}.toString.call(i)?e(n,o,t,this._map):e;null!=a&&D(a,this)}}(x.selectAll),this)}}}function _(t,o,n,i){var a=e.DomUtil.create(t,o,n);return i&&(a.innerHTML=i),a}function k(e){var t=e.querySelector("input[type=checkbox]"),o=!0,n=!0,i=e.querySelectorAll("input[type=checkbox]");[].forEach.call(i,(function(e){e===t||(e.indeterminate?(o=!1,n=!1):e.checked?n=!1:e.checked||(o=!1))})),o?(t.indeterminate=!1,t.checked=!0):n?(t.indeterminate=!1,t.checked=!1):(t.indeterminate=!0,t.checked=!1)}function S(t,o){i.forEach((function(n){e.DomEvent.on(t,"click",(function(e){k(n)}),o)}),o)}function D(e,t){for(var n=o.getElementsByTagName("input"),i=0;i<n.length;i++){var a=n[i];"checkbox"===a.type&&(a.checked=e,a.indeterminate=!1)}t._onInputClick()}},_createCheckboxElement:function(e){var t=document.createElement("input");return t.type="checkbox",t.className="leaflet-control-layers-selector",t.defaultChecked=e,t}}),e.control.layers.tree=function(t,o,n){return new e.Control.Layers.Tree(t,o,n)}}(L),console.log("L.Control.Layers.Tree has been loaded!"),L.ResponsivePopup=L.Popup.extend({options:{hasTip:!0},_initLayout:function(){var e="leaflet-popup",t=this._container=L.DomUtil.create("div",e+" "+(this.options.className||"")+" leaflet-zoom-animated"),o=this._wrapper=L.DomUtil.create("div",e+"-content-wrapper",t);if(this._contentNode=L.DomUtil.create("div",e+"-content",o),L.DomEvent.disableClickPropagation(t),L.DomEvent.disableScrollPropagation(this._contentNode),L.DomEvent.on(t,"contextmenu",L.DomEvent.stopPropagation),this._tipContainer=L.DomUtil.create("div",e+"-tip-container",t),this.options.hasTip||(this._tipContainer.style.visibility="hidden"),this._tip=L.DomUtil.create("div",e+"-tip",this._tipContainer),this.options.closeButton){var n=this._closeButton=L.DomUtil.create("a",e+"-close-button",t);n.setAttribute("role","button"),n.setAttribute("aria-label","Close popup"),n.href="#close",n.innerHTML='<span aria-hidden="true">&#215;</span>',L.DomEvent.on(n,"click",(function(e){L.DomEvent.preventDefault(e),this.close()}),this)}},_updatePosition:function(){if(this._map){var e=this._map.latLngToLayerPoint(this._latlng),t=this._map.layerPointToContainerPoint(e),o=this._container.offsetWidth,n=this._container.offsetHeight,i=L.point(this.options.autoPanPadding),a=L.point(this.options.autoPanPaddingTopLeft||i),r=L.point(this.options.autoPanPaddingBottomRight||i),s=this._map.getSize(),l=this._getAnchor(),c=L.point(this.options.offset),d=12,p=Math.abs(c.x),m=Math.abs(c.y);this.options.hasTip&&(p+=11,m+=11,L.DomUtil.removeClass(this._container,"leaflet-resp-popup-north"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-south"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-east"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-west"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-north-east"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-north-west"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-south-east"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-south-west"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-east-north"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-east-south"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-west-north"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-west-south"));var h=!0,u=!0,f=!0,y=!0,g=!1;t.y+l.y-m-n-Math.abs(a.y)<0&&(h=!1),t.y+l.y+m+n+Math.abs(r.y)>s.y&&(u=!1),t.x+l.x-p-o-Math.abs(a.x)<0&&(f=!1),t.x+l.x+p+o+Math.abs(r.x)>s.x&&(y=!1);var w=o/2-l.x,b=n/2-l.y;if(h||u){var v=t.x+l.x-o/2,C=t.x+l.x+o/2;v<Math.abs(a.x)&&(w=o/2-l.x-Math.abs(a.x)+v),C>s.x-Math.abs(r.x)&&(w=o/2-l.x+C-s.x+Math.abs(r.x))}if(f||y){var x=t.y+l.y-n/2,T=t.y+l.y+n/2;x<Math.abs(a.y)&&(b=n/2-l.y-Math.abs(a.y)+x),T>s.y-Math.abs(r.y)&&(b=n/2-l.y+T-s.y+Math.abs(r.y))}if(h)g=e.subtract(L.point(w,-l.y+n+m,!0)),this.options.hasTip&&(t.x+l.x<a.x+d+11?(g.x=e.x+l.x,L.DomUtil.addClass(this._container,"leaflet-resp-popup-north-east"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left="0px"):t.x+l.x>s.x-r.x-d-11?(g.x=e.x+l.x-o,L.DomUtil.addClass(this._container,"leaflet-resp-popup-north-west"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left=o+"px"):(L.DomUtil.addClass(this._container,"leaflet-resp-popup-north"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left=e.x+l.x-g.x+"px"));else if(f)g=e.subtract(L.point(-l.x+o+p,b,!0)),this.options.hasTip&&(t.y+l.y<a.y+d+11?(g.y=e.y+l.y,L.DomUtil.addClass(this._container,"leaflet-resp-popup-west-south"),this._tipContainer.style.top="0px",this._tipContainer.style.left=o+"px"):t.y+l.y>s.y-r.y-d-11?(g.y=e.y+l.y-n,L.DomUtil.addClass(this._container,"leaflet-resp-popup-west-north"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left=o+"px"):(L.DomUtil.addClass(this._container,"leaflet-resp-popup-west"),this._tipContainer.style.top=e.y+l.y-g.y+"px",this._tipContainer.style.left=o+"px"));else if(u)g=e.subtract(L.point(w,-l.y-m,!0)),this.options.hasTip&&(t.x+l.x<a.x+d+11?(g.x=e.x+l.x,L.DomUtil.addClass(this._container,"leaflet-resp-popup-south-east"),this._tipContainer.style.top="0px",this._tipContainer.style.left="0px"):t.x+l.x>s.x-r.x-d-11?(g.x=e.x+l.x-o,L.DomUtil.addClass(this._container,"leaflet-resp-popup-south-west"),this._tipContainer.style.top="0px",this._tipContainer.style.left=o+"px"):(L.DomUtil.addClass(this._container,"leaflet-resp-popup-south"),this._tipContainer.style.top="0px",this._tipContainer.style.left=e.x+l.x-g.x+"px"));else if(y)g=e.subtract(L.point(-l.x-p,b,!0)),this.options.hasTip&&(t.y+l.y<a.y+d+11?(g.y=e.y+l.y,L.DomUtil.addClass(this._container,"leaflet-resp-popup-east-south"),this._tipContainer.style.top="0px",this._tipContainer.style.left="0px"):t.y+l.y>s.y-r.y-d-11?(g.y=e.y+l.y-n,L.DomUtil.addClass(this._container,"leaflet-resp-popup-east-north"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left="0px"):(L.DomUtil.addClass(this._container,"leaflet-resp-popup-east"),this._tipContainer.style.top=e.y+l.y-g.y+"px",this._tipContainer.style.left="0px"));else{g=(e=this._map.latLngToLayerPoint(this._map.getCenter())).subtract(L.point(o/2,n/2)),this.options.hasTip}t.x<0||t.y<0||t.x>s.x||(t.y,s.y),o-Math.abs(a.x)-Math.abs(r.x)>s.x||(Math.abs(a.y),Math.abs(r.y),s.y),L.DomUtil.setPosition(this._container,g)}}}),L.responsivePopup=function(e,t){return new L.ResponsivePopup(e,t)},"object"==typeof exports&&"undefined"!=typeof module&&(exports.responsivePopup=L.responsivePopup,exports.ResponsivePopup=L.ResponsivePopup);const n=L.Control.extend({onAdd:function(e){var t=L.DomUtil.create("div","info-control leaflet-bar leaflet-control"),o=L.DomUtil.create("a","leaflet-control-button",t);o.href="#";var n=L.DomUtil.create("img","info-control-icon",o);n.src="assets/images/info.png",n.alt="Information",n.style.width="24px",n.style.height="24px",n.style.padding="4px",L.DomEvent.disableClickPropagation(t);let i=null,a=null,r=null,s=null,l=null,c=null,d=null,p=null,m=!1;const h={home:'\n                <h3>About XCmaps</h3>\n                <p>XCmaps is a non-commercial project that brings together various data sources for para- and hang-gliders, providing valuable insights for the community.</p>\n\n                <h3>Contact</h3>\n                <p>You can reach out to us via the Feedback form below or by <a href="mailto:info@XCmaps.com" target="_blank">email</a>.</p>\n                <p>If you‚Äôd like to report an issue, such as a bug or a feature request, please visit our <a href="https://github.com/XCmaps/XCmaps" target="_blank">GitHub</a> project page.</p>\n                <p>To stay up-to date on latest updates, please follow us on <a href="https://facebook.com/xcmaps" target="_blank">Facebook</a> or <a href="https://github.com/XCmaps/XCmaps" target="_blank">GitHub</a>.</p>\n\n                <p>If you enjoy our content, consider buying us a landing beer! Your support helps keep this service running, as we cover real costs for servers, storage, AI models, and data sources.<br>It‚Äôs simple: the more funding we receive, the faster we can roll out new features!</p>\n                <p><a href="https://buymeacoffee.com/XCmaps" target="_blank" class="donation-button"> üç∫ Buy us a Landing Beer</a></p>\n\n                <h3>Features</h3>\n                <ul>\n                  <li><strong>Weather Stations:</strong> Wind, Gusts, Direction, Temp and Camera if available</li>\n                  <li><strong>Rain Viewer:</strong> Radar and Satellite, past 60 min + 20 min forecast</li>\n                  <li><strong>Thermals:</strong> kk7 thermal map</li>\n                  <li><strong>Spots:</strong> Para- and Hangliding take-off and Landing Zones (¬© <a href="https://paraglidingspots.com" target="_blank">paraglidingspots.com</a>)</li>\n                  <li><strong>Airspaces:</strong> Xcontest Airspaces & Activations, filter for today and the next 6 days and lowest floor level</li>\n                  <li><strong>Obstacles:</strong> OSM based obstacles from Xcontest</li>\n                  <li><strong>Locate and Track:</strong> Locate and Track your position using the Locate Control</li>\n                </ul>\n\n                <h3>Credits</h3>\n                <ul>\n                  <li><strong>Base Maps:</strong> <a href="https://www.jawg.io" target="_blank">Jawg.io</a>, <a href="https://openstreetmap.org" target="_blank">OpenStreetMap</a>, <a href="https://xcontest.org" target="_blank">XContest</a>, <a href="https://maptiler.com" target="_blank">MapTiler</a></li>\n                  <li><strong>Weather Stations:</strong> <a href="https://github.com/winds-mobi" target="_blank">winds.mobi</a> by Yann Savary and additional data sources</li>\n                  <li><strong>Airspaces & Obstacles:</strong> <a href="https://xcontest.org" target="_blank">XContest</a>, <a href="https://openaip.net" target="_blank">OpenAIP</a></li>\n                  <li><strong>Take-off and Landing Spots:</strong> ¬© <a href="https://paraglidingspots.com" target="_blank">paraglidingspots.com</a> by Karsten Ehlers</li>\n                  <li><strong>Rain Viewer:</strong> <a href="https://www.rainviewer.com" target="_blank">rainviewer</a></li>\n                  <li><strong>Thermals:</strong> <a href="https://thermal.kk7.ch" target="_blank">thermal.kk7</a> by Michi von K√§nel</li>\n                  <li>and many more open source libraries, projects, and artwork</li>\n                </ul>\n\n                <h3>License and Code</h3>\n                <p>As some integrations are licensed under CC BY-NC-SA 4.0, XCmaps applied the same level and is licensed under a <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.</a></p>\n            ',privacy:'\n                <h3>XCmaps Privacy Policy</h3>\n                <p>At XCmaps (referred to as "we", "us" or "our" in this policy), we understand the importance of protecting your personal data. This privacy policy explains how we collect, use, share and store information when you access our website at XCmaps.com, which is operated by us, and any other services provided by flyXC (collectively referred to as the "Services").</p>\n                <p>You acknowledge that this Privacy Policy is part of our Site Terms of Use, and by accessing or using our site, you agree to be bound by all of its terms and conditions. If you do not agree to these terms, please do not access or use this site.</p>\n                <p>We reserve the right to change this Privacy Policy at any time. Such changes, modifications, additions or deletions shall be effective immediately upon notice thereof, which may be given by means including, but not limited to issuing an email to the email address listed by registered users and posting the revised Policy on this page. You acknowledge and agree that it is your responsibility to maintain a valid email address as a registered user, review this site and this Policy periodically and to be aware of any modifications. Your continued use of the site after such modifications will constitute your: (a) acknowledgment of the modified Policy; and (b) agreement to abide and be bound by the modified Policy.</p>\n                <h4>1. Information We Collect</h4>\n                <p>We collect two types of information: Personal Data and Non-Personal Data.</p>\n                <p><strong>A) Personal Data:</strong> This includes data that can be used to directly or indirectly identify you, such as your name, location, email address, and other similar information. You are not required to provide the personal data that we have requested, but if you choose not to do so, in many cases we will not be able to provide you with our products or services, and/or respond to any queries or requests you may have.</p>\n                <p><strong>B) Non-Personal Data:</strong> This includes information that cannot identify a specific individual, such as browser types, operating systems, and the pages viewed while navigating through the Services. We collect this data using cookies and other similar technologies.</p>\n                <h4>2. How We Collect Information</h4>\n                <p>We may obtain Personal Data from you when you:</p>\n                <ul><li>Register on our website or application;</li><li>Submit an inquiry through the Services;</li><li>Communicate with us via email, phone, or other means</li></ul>\n                <p>We do not collect any Personally Identifiable Information about you unless you voluntarily provide it to us. You provide certain Personally Identifiable Information to us when you register your account.</p>\n                <p>We collect your registered tracker positions continuously and use that to display your position on the map for up to 48 hours. By signing up for XCmaps and registering your tracker devices, you acknowledge and agree that your tracker devices location will be displayed and viewable via our services.</p>\n                <p>For safety purpose, we keep an archive of the last 30 days for the live tracks. The archive is not publicly accessible.</p>\n                <p>We reserve the right to use any track uploaded on our services. i.e. to derive heat maps of thermal locations.</p>\n                <h4>3. How We Use Information</h4>\n                <p>We use your information to:</p>\n                <ul><li>Provide and improve our products and services;</li><li>Respond to requests, inquiries, and comments;</li><li>Analyze usage trends and preferences;</li><li>Comply with legal obligations;</li><li>Enforce our terms of service;</li><li>Protect the rights, property, or safety of XCmaps, our users, or others.</li></ul>\n                <h4>4. How We Share Information</h4>\n                <p>We may share your information:</p>\n                <ul><li>With third parties who provide services on our behalf;</li><li>In response to legal process;</li><li>To investigate suspected fraud or potential threats to the security of our Services;</li><li>In connection with an acquisition, merger, or sale of assets;</li><li>When we have your explicit consent.</li></ul>\n                <h4>5. How We Store Information</h4>\n                <p>We store your information on secure servers that are protected by appropriate physical, technical, and organizational measures designed to prevent unauthorized access, loss, misuse, disclosure, alteration, and destruction. However, no electronic transmission or storage of data is completely secure, so we cannot guarantee the absolute security of this information.</p>\n                <h4>6. Your Rights</h4>\n                <p>You have certain rights regarding your Personal Data, subject to local law. These include the right to request access, correction, erasure, restriction, portability, and objection to processing of your Personal Data. You can exercise these rights by contacting us using the details provided in this policy.</p>\n                <h4>7. Children\'s Privacy</h4>\n                <p>Our Services are not directed at children under 16 years old. If you learn that a child has provided us with their information without consent, please contact us immediately so we can take appropriate action.</p>\n                <h4>8. Changes to This Policy</h4>\n                <p>We may update our privacy policy from time to time. When we make significant changes, we will notify you by posting a notice on our website or through other communication channels. We encourage you to review this page periodically for the latest information on our privacy practices.</p>\n                <h4>9. Contact Information</h4>\n                <p>If you have any questions about this Privacy Policy, please contact us at: info@XCmaps.com</p>\n            ',terms:'\n                <h3>XCmaps Terms and Conditions</h3>\n                <p>This website, XCmaps.com (the "Website"), provides various data sources for para- and hang-gliders, providing valuable insights for the community.</p>\n                <p>By using the Website, you agree to these terms and conditions (the "Terms") and acknowledge that they constitute a legally binding contract between you and XCmaps. If you do not agree to these Terms, please do not use the Website. We reserve the right to modify or update these Terms at any time without prior notice. Your continued use of the Website after any changes indicates your acceptance of the new terms and conditions. Therefore, we recommend that you review these Terms regularly for any changes.</p>\n\n                <h4>1. Purpose of the Website</h4>\n                <p>The purpose of the Website is to enhance safety and education in free flight sports such as paragliding and hang gliding. The Website provides users with access to various features, including:</p>\n                <ul>\n                  <li><strong>Weather Stations:</strong> Wind, Gusts, Direction, Temp and Camera if available</li>\n                  <li><strong>Rain Viewer:</strong> Radar and Satellite incl. forecast</li>\n                  <li><strong>Thermals:</strong> kk7 thermal map</li>\n                  <li><strong>Spots:</strong> Para- and Hangliding take-off and Landing Zones (¬© <a href="https://paraglidingspots.com" target="_blank">paraglidingspots.com</a>)</li>\n                  <li><strong>Airspaces:</strong> Xcontest Airspaces & Activations, filter for today and the next 6 days</li>\n                  <li><strong>Obstacles:</strong> OSM based obstacles from Xcontest</li>\n                </ul>\n\n                <h4>2. Data Collection and Use</h4>\n                <p>XCmaps does not collect data from its users.</p>\n                <p>XCmaps does not sell, rent, or otherwise share your personal information with any third parties, except as required by law or as necessary to protect the rights, property, or safety of XCmaps, its employees, users, or others. XCmaps may also disclose your data if it is involved in a merger, acquisition, or sale of all or part of its assets.</p>\n\n                <h4>3. Ownership and Intellectual Property Rights</h4>\n                <p>The Website, including but not limited to its design, layout, content, graphics, images, audio, video, and code, is owned by XCmaps and protected by copyright laws and international intellectual property rights. You may not reproduce, modify, distribute, sell, or otherwise use any part of the Website without the prior written consent of XCmaps.</p>\n\n                <h4>4. Disclaimer of Warranties and Liability</h4>\n                <p>The Website is provided "as is" and "as available". XCmaps disclaims all warranties, express or implied, including but not limited to warranties of merchantability, fitness for a particular purpose, title, non-infringement, and security. XCmaps does not guarantee that the Website will be error-free, uninterrupted, or accessible at all times. XCmaps is not responsible for any losses, damages, or expenses arising from your use of the Website, including but not limited to direct, indirect, special, incidental, consequential, or punitive damages. XCmaps also disclaims any liability for any actions taken by you or others based on the information provided by the Website, which may be inaccurate, incomplete, or outdated.</p>\n\n                <h4>5. Indemnification</h4>\n                <p>You agree to indemnify and hold harmless XCmaps, its officers, directors, employees, agents, licensors, and suppliers from any claims, actions, demands, liabilities, costs, damages, and expenses (including reasonable attorneys\' fees) arising from your use of the Website or your violation of these Terms.</p>\n\n                <h4>6. Applicable Law and Dispute Resolution</h4>\n                <p>These Terms shall be governed by and construed in accordance with the laws of France, without giving effect to any principles of conflicts of law. Any disputes arising out of or in connection with these Terms or your use of the Website shall be subject to the exclusive jurisdiction of the courts of England and Wales.</p>\n\n                <h4>7. Entire Agreement</h4>\n                <p>These Terms constitute the entire agreement between you and XCmaps regarding your use of the Website and supersede any prior agreements, understandings, or representations, whether written or oral. If any provision of these Terms is found to be unenforceable or invalid, that provision shall be limited or eliminated to the minimum extent necessary so that these Terms shall otherwise remain in full force and effect and enforceable.</p>\n                <p>By using the Website, you acknowledge that you have read, understood, and agreed to these Terms. If you do not agree to these Terms, please do not use the Website.</p>\n            '};function u(){const e=L.DomUtil.create("div","info-popup-container");s=L.DomUtil.create("div","info-popup-header",e);const t=L.DomUtil.create("div","info-popup-header-left",s),o=L.DomUtil.create("img","info-popup-logo",t);o.src="assets/images/XCmapsLogo.png",o.alt="XCmaps Logo",c=L.DomUtil.create("div","info-popup-breadcrumbs",t);const n=L.DomUtil.create("div","info-popup-header-right",s),i=L.DomUtil.create("a","social-icon",n);i.href="https://facebook.com/xcmaps",i.target="_blank";const a=L.DomUtil.create("img","",i);a.src="assets/images/facebook.png",a.alt="Facebook";const d=L.DomUtil.create("a","social-icon",n);d.href="https://github.com/XCmaps/XCmaps",d.target="_blank";const p=L.DomUtil.create("img","",d);p.src="assets/images/github.svg",p.alt="GitHub";return L.DomUtil.create("span","info-popup-close",n).innerHTML="&times;",r=L.DomUtil.create("div","info-popup-content",e),l=L.DomUtil.create("div","info-popup-footer d-flex justify-content-between align-items-center",e),l.innerHTML='\n                <div class="footer-links">\n                    <a href="#" data-section="privacy">Privacy Policy</a>\n                    <a href="#" data-section="terms">Terms and Conditions</a>\n                </div>\n                <div class="d-flex align-items-center">\n                    <div id="info-feedback-message" class="text-start" style="margin-right: 10px;"></div>\n                    <button class="btn btn-primary btn-sm me-2 info-popup-feedback-btn">Feedback</button>\n                    <button class="btn btn-dark btn-sm info-popup-footer-close">Close</button>\n                </div>\n            ',g("home"),L.DomEvent.on(e,"click",v),e}function f(){!function(){if(m)return;i=L.DomUtil.create("div","info-modal-overlay",document.body),i.style.display="none",a=L.DomUtil.create("div","info-modal-content",i);const e=u();a.appendChild(e);const t=a.querySelector(".info-popup-close");t&&L.DomEvent.on(t,"click",y),L.DomEvent.on(i,"click",(e=>{e.target===i&&y()})),m=!0}(),g("home"),i&&(i.style.display="flex"),e&&(e.dragging.disable(),e.touchZoom.disable(),e.doubleClickZoom.disable(),e.scrollWheelZoom.disable(),e.boxZoom.disable(),e.keyboard.disable(),e.tap&&e.tap.disable(),L.DomUtil.addClass(e.getContainer(),"modal-open"))}function y(){b(!1),i&&(i.style.display="none"),e&&(e.dragging.enable(),e.touchZoom.enable(),e.doubleClickZoom.enable(),e.scrollWheelZoom.enable(),e.boxZoom.enable(),e.keyboard.enable(),e.tap&&e.tap.enable(),L.DomUtil.removeClass(e.getContainer(),"modal-open"))}function g(e){if(r&&c&&l)if(b(!1),h[e]){if(r.innerHTML=h[e],l.style.display="home"===e?"flex":"none",c.innerHTML="","home"!==e){c.innerHTML='<a href="#" data-section="home" class="breadcrumb-link">Home</a> / ';const t=L.DomUtil.create("span","breadcrumb-current",c);"privacy"===e?t.innerText="Privacy Policy":"terms"===e&&(t.innerText="Terms and Conditions")}r.scrollTop=0}else console.error("Unknown section:",e)}async function w(e){if(!l)return;if(e.preventDefault(),!p)return;const t=new FormData;t.append("subject","General XCmaps Info Feedback"),t.append("feedbackText",p.querySelector("#infoFeedbackText").value),t.append("userName",p.querySelector("#infoUserName").value),t.append("userEmail",p.querySelector("#infoUserEmail").value),d&&d.files.forEach((e=>{e.status!==Dropzone.ADDED&&e.status!==Dropzone.QUEUED||t.append("images",e)}));try{const e=await fetch("/api/send-feedback",{method:"POST",body:t}),o=await e.json();b(!1);const n=l.querySelector("#info-feedback-message");n&&(n.textContent=o.success?o.message||"Feedback submitted!":o.error||"Submission error.",n.className=o.success?"text-start text-success":"text-start text-danger"),c&&""!==c.innerHTML||(l.style.display="flex")}catch(e){console.error("Submission error:",e),b(!0);const t=l.querySelector("#info-feedback-message");t&&(t.textContent="Network error during submission.",t.className="text-start text-danger")}}function b(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!r)return;const t=r.querySelector("#infoFeedbackFormHtml");if(t&&t.remove(),p=null,d&&("function"==typeof d.destroy&&d.destroy(),d=null),e&&l){const e=l.querySelector("#info-feedback-message");e&&(e.textContent=""),c&&""!==c.innerHTML?l.style.display="none":l.style.display="flex"}}function v(e){let t=e.target;if(l&&l.contains(t)&&t.classList.contains("info-popup-footer-close")){if(L.DomEvent.stopPropagation(e),i&&"none"!==i.style.display)y();else if("function"==typeof window.closeFullscreenInfo){const e=document.getElementById("fullScreenInfo");e&&e.classList.contains("visible")&&window.closeFullscreenInfo()}return}if(l&&l.contains(t)&&t.classList.contains("info-popup-feedback-btn"))return L.DomEvent.stopPropagation(e),void function(){if(!r||!l)return;b(!1);const e=l.querySelector("#info-feedback-message");e&&(e.textContent="",e.className="text-start"),l.style.display="none",r.insertAdjacentHTML("beforeend",'\n                <div id="infoFeedbackFormHtml" class="feedback-modal">\n                    <h5>Feedback for XCmaps</h5>\n                     <form id="infoFeedbackForm">\n                        <div class="form-group mb-2">\n                            <label for="infoFeedbackText">Feedback / Correction / Comment:</label>\n                            <textarea id="infoFeedbackText" class="form-control" required style="height: 100px;"></textarea>\n                        </div>\n                        <div class="form-group mb-2">\n                            <label>Upload Images (optional):</label>\n                            <div id="infoDropzoneFeedback" class="dropzone mt-1 border-dashed rounded-2 min-h-0 dz-clickable"></div>\n                        </div>\n                        <div class="form-group d-flex justify-content-between mb-2">\n                            <div style="width: 48%;">\n                                <label for="infoUserName">Name:</label>\n                                <input type="text" id="infoUserName" class="form-control" required>\n                            </div>\n                            <div style="width: 48%;">\n                                <label for="infoUserEmail">E-Mail:</label>\n                                <input type="email" id="infoUserEmail" class="form-control" required>\n                                <small class="text-danger d-none" id="infoEmailError">Please enter a valid email address.</small>\n                            </div>\n                        </div>\n                        <button type="submit" class="btn btn-sm btn-success me-2">Submit</button>\n                        <button type="button" class="btn btn-sm btn-secondary info-feedback-cancel-btn">Cancel</button>\n                    </form>\n                </div>\n             '),p=r.querySelector("#infoFeedbackFormHtml");try{d=new Dropzone("#infoDropzoneFeedback",{url:"/api/send-feedback",autoProcessQueue:!1,maxFiles:5,maxFilesize:10,acceptedFiles:"image/*",addRemoveLinks:!0,dictDefaultMessage:"Drop files or click here",clickable:!0,init:function(){}})}catch(e){console.error("Dropzone init failed.",e)}const t=p?.querySelector("#infoFeedbackForm"),o=p?.querySelector(".info-feedback-cancel-btn"),n=p?.querySelector("#infoUserEmail");t&&t.addEventListener("submit",w),o&&o.addEventListener("click",(()=>b(!0))),n&&n.addEventListener("input",(function(){const e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value),t=p?.querySelector("#infoEmailError");t&&t.classList.toggle("d-none",e)})),r.scrollTop=r.scrollHeight}();let o=0,n=t;for(;n&&n!==e.currentTarget&&!n.dataset.section&&o<3;)n=n.parentNode,o++;n&&n.dataset.section&&(L.DomEvent.preventDefault(e),L.DomEvent.stopPropagation(e),g(n.dataset.section))}return L.DomEvent.on(o,"click",(function(t){L.DomEvent.stop(t);if(i&&"none"!==i.style.display)return void y();const o=document.getElementById("fullScreenInfo"),n=o?.querySelector(".info-popup-container");o&&o.classList.contains("visible")&&n?"function"==typeof window.closeFullscreenInfo&&window.closeFullscreenInfo():window.innerWidth<768?function(){const t=u();L.popup({className:"info-popup",autoPan:!1}).setLatLng(e.getCenter()).setContent(t).openOn(e)}():f()})),t.onRemove=function(){i&&(i.remove(),i=null,m=!1),e&&L.DomUtil.removeClass(e.getContainer(),"modal-open")},t}}),i=n;var a=o(5093);o(4837);let r=null;function s(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getCenter(),t=`http://localhost:3000/api/airspaces?lat=${e.lat.toFixed(6)}&lng=${e.lng.toFixed(6)}&dist=200000&types=${encodeURIComponent([21].join(","))}`;fetch(t).then((e=>e.json())).then((e=>{window.airspaceGliding.clearLayers();const t=[];e.items.forEach((e=>{if((0!==e.type||4!==e.icaoClass)&&e.geometry&&"Polygon"===e.geometry.type){const o=e.geometry.coordinates[0].map((e=>[e[1],e[0]])),n=0===e.lowerLimit.value?"red":"green",i=(l[e.type],c[e.icaoClass],L.polygon(o,{color:n,weight:2,fillOpacity:.3}));t.push({polygon:i,data:e}),window.airspaceGliding.addLayer(i)}})),console.log(`Added ${t.length} airspaces to the map`),r&&window.map.off("click",r),r=function(e){if(!window.map.hasLayer(window.airspaceGliding))return;const o=e.latlng,n=[];if(t.forEach((e=>{let{polygon:t,data:i}=e;t.getBounds().contains(o)&&n.push(i)})),n.length>0){const e=n.map((e=>`\n            <b>${e.name}</b><br>\n            Type: ${l[e.type]||"Unknown"}<br>\n            ICAO Class: ${c[e.icaoClass]||"Unknown"}<br>\n            ‚Üß${e.lowerLimit.value} ${d(e.lowerLimit.unit)}  ‚Ü•${e.upperLimit.value} ${d(e.upperLimit.unit)}<br>\n          `)).join("<hr>");L.popup().setLatLng(o).setContent(e).openOn(window.map)}},window.map.on("click",r)})).catch((e=>console.error("Error fetching airspaces:",e)))}const l={0:"Other",1:"Restricted",2:"Danger (D)",3:"Prohibited (Parc reserve)",4:"Controlled Tower Region (CTR)",5:"Transponder Mandatory Zone (TMZ)",6:"Radio Mandatory Zone (RMZ)",7:"Terminal Maneuvering Area (TMA)",8:"Temporary Reserved Area (TRA)",9:"Temporary Segregated Area (TSA)",10:"Flight Information Region (FIR)",11:"Upper Flight Information Region (UIR)",12:"Air Defense Identification Zone (ADIZ)",13:"Airport Traffic Zone (ATZ)",14:"Military Airport Traffic Zone (MATZ)",15:"Airway",16:"Military Training Route (MTR)",17:"Alert Area",18:"Warning Area",19:"Protected Area",20:"Helicopter Traffic Zone (HTZ)",21:"Gliding Sector",22:"Transponder Setting (TRP)",23:"Traffic Information Zone (TIZ)",24:"Traffic Information Area (TIA)",25:"Military Training Area (MTA)",26:"Control Area (CTA)",27:"ACC Sector (ACC)",28:"Aerial Sporting Or Recreational Activity",29:"Low Altitude Overflight Restriction",30:"Military Route (MRT)",31:"TSA/TRA Feeding Route (TFR)",32:"VFR Sector",33:"FIS Sector",34:"Lower Traffic Area (LTA)",35:"Upper Traffic Area (UTA)"},c={0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",8:"Special Use Airspace (SUA)"};function d(e){return{1:"ft",6:"FL"}[e]||"Unknown"}window.fetchAirspacesGliding=s,document.addEventListener("map_initialized",(function(){console.log("Setting up airspace layer events"),window.map.on("overlayadd",(function(e){"Airspaces"!==e.name&&"Gliding"!==e.name&&"Notam"!==e.name||(console.log(`Overlay added: ${e.name}, fetching airspaces`),s())})),window.map.on("moveend",(function(){window.map.hasLayer(window.airspaceGliding)&&(console.log("Map moved, refreshing airspaces"),s())}))}));let p=null;function m(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getCenter(),t=`http://localhost:3000/api/airspaces?lat=${e.lat.toFixed(6)}&lng=${e.lng.toFixed(6)}&dist=200000&types=${encodeURIComponent([8,9].join(","))}`;fetch(t).then((e=>e.json())).then((e=>{window.airspaceNotam.clearLayers();const t=[];e.items.forEach((e=>{if((0!==e.type||4!==e.icaoClass)&&e.geometry&&"Polygon"===e.geometry.type){const o=e.geometry.coordinates[0].map((e=>[e[1],e[0]])),n=0===e.lowerLimit.value?"red":"blue",i=(h[e.type],u[e.icaoClass],L.polygon(o,{color:n,weight:2,fillOpacity:.3}));t.push({polygon:i,data:e}),window.airspaceNotam.addLayer(i)}})),console.log(`Added ${t.length} airspaces to the map`),p&&window.map.off("click",p),p=function(e){if(!window.map.hasLayer(window.airspaceNotam))return;const o=e.latlng,n=[];if(t.forEach((e=>{let{polygon:t,data:i}=e;t.getBounds().contains(o)&&n.push(i)})),n.length>0){const e=n.map((e=>`\n            <b>${e.name}</b><br>\n            Type: ${h[e.type]||"Unknown"}<br>\n            ICAO Class: ${u[e.icaoClass]||"Unknown"}<br>\n            ‚Üß${e.lowerLimit.value} ${f(e.lowerLimit.unit)}  ‚Ü•${e.upperLimit.value} ${f(e.upperLimit.unit)}<br>\n          `)).join("<hr>");L.popup().setLatLng(o).setContent(e).openOn(window.map)}},window.map.on("click",p)})).catch((e=>console.error("Error fetching airspaces:",e)))}const h={0:"Other",1:"Restricted",2:"Danger (D)",3:"Prohibited (Parc reserve)",4:"Controlled Tower Region (CTR)",5:"Transponder Mandatory Zone (TMZ)",6:"Radio Mandatory Zone (RMZ)",7:"Terminal Maneuvering Area (TMA)",8:"Temporary Reserved Area (TRA)",9:"Temporary Segregated Area (TSA)",10:"Flight Information Region (FIR)",11:"Upper Flight Information Region (UIR)",12:"Air Defense Identification Zone (ADIZ)",13:"Airport Traffic Zone (ATZ)",14:"Military Airport Traffic Zone (MATZ)",15:"Airway",16:"Military Training Route (MTR)",17:"Alert Area",18:"Warning Area",19:"Protected Area",20:"Helicopter Traffic Zone (HTZ)",21:"Gliding Sector",22:"Transponder Setting (TRP)",23:"Traffic Information Zone (TIZ)",24:"Traffic Information Area (TIA)",25:"Military Training Area (MTA)",26:"Control Area (CTA)",27:"ACC Sector (ACC)",28:"Aerial Sporting Or Recreational Activity",29:"Low Altitude Overflight Restriction",30:"Military Route (MRT)",31:"TSA/TRA Feeding Route (TFR)",32:"VFR Sector",33:"FIS Sector",34:"Lower Traffic Area (LTA)",35:"Upper Traffic Area (UTA)"},u={0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",8:"Special Use Airspace (SUA)"};function f(e){return{1:"ft",6:"FL"}[e]||"Unknown"}window.fetchAirspacesNotam=m,document.addEventListener("map_initialized",(function(){console.log("Setting up airspace layer events"),window.map.on("overlayadd",(function(e){"Airspaces"!==e.name&&"Gliding"!==e.name&&"Notam"!==e.name||(console.log(`Overlay added: ${e.name}, fetching airspaces`),m())})),window.map.on("moveend",(function(){window.map.hasLayer(window.airspaceNotam)&&(console.log("Map moved, refreshing airspaces"),m())}))}));var y=o(278),g=o(3807);let w,b=null,v=3e3,C=function(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}(),x=[];function T(e){const t=a.tz.guess();let o="";if(e.descriptions&&Array.isArray(e.descriptions)&&e.descriptions.length>0){const t=e=>e?e.replace(/([ABCDEFGQ]\))/g,"<br>$1"):"";o=`\n      <div class="airspace-descriptions" style="font-size: 0.8em;">\n          ${e.descriptions.map((e=>`${t(e.airdescription||"")} ${e.airlanguage?`(${e.airlanguage})`:""}`)).join("")}\n      </div>\n    `}let n="";e.activations&&Array.isArray(e.activations)&&e.activations.length>0&&(n=`\n      <div class="airspace-activations">\n        <b>Activations:</b><br>\n        ${e.activations.map((e=>{const o=a.utc(e[0]).tz(t),n=a.utc(e[1]).tz(t);return`${o.format("MMM D, HH:mm z")} - ${n.format("MMM D, HH:mm z")}`})).join("<br>")}\n      </div>\n    `);const i=(e,t)=>{if(!e)return t||"N/A";const o=e.type,n=e.height;if("FL"===o){return`${Math.round(.3048*n)}m (FL${n/100})`}if("AMSL"===o||"AGL"===o){return`${Math.round(.3048*n)}m`}return t||"N/A"},r=i(e.airlower_j,e.lowerLimit),s=i(e.airupper_j,e.upperLimit);a.tz(t).zoneAbbr(),a.tz(t).format("Z");return`\n    <div class="airspace-detail">\n      <b>${e.name} (${e.airspaceClass})</b><br>\n      <b>‚Üß </b>${r} - <b>‚Ü• </b>${s}<br>\n      ${o}\n      ${n}\n    </div>\n  `}function _(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getZoom();if(e<5)return console.log(`[AirspaceXC] Zoom level ${e} is below minimum (5), clearing layer and skipping fetch.`),window.airspaceXC&&window.airspaceXC.clearLayers(),void(x=[]);const t=window.map.getCenter(),o=(t.lat.toFixed(6),t.lng.toFixed(6),window.map.getBounds()),n=o.getNorthWest(),i=o.getSouthEast(),r=`/api/airspacesXCdb?startDate=${C}&nw_lat=${n.lat.toFixed(6)}&nw_lng=${n.lng.toFixed(6)}&se_lat=${i.lat.toFixed(6)}&se_lng=${i.lng.toFixed(6)}`;fetch(r).then((e=>e.json())).then((e=>{window.airspaceXC.clearLayers(),x=[],b&&(window.map.off("popupopen",b),b=null);const t=e.features||[],o=Intl.DateTimeFormat().resolvedOptions().timeZone,n=a.tz(C,"YYYY-MM-DD",o).startOf("day").utc().toDate();t.forEach((e=>{if(e.geometry&&"Polygon"===e.geometry.type){if(e.properties.name&&e.properties.name.startsWith("V00"))return;const t=function(e){if(!e)return null;switch(e.type){case"FL":case"AMSL":case"AGL":return.3048*e.height;default:return null}}(e.properties.airlower_j);if(null===t||t>v)return;let i=!1;if(e.properties.descriptions&&Array.isArray(e.properties.descriptions))for(const t of e.properties.descriptions){const e=(t.airdescription||"").match(/C\)\s*(\d{10})/);if(e&&e[1])try{const t=2e3+parseInt(e[1].substring(0,2)),o=parseInt(e[1].substring(2,4))-1,a=parseInt(e[1].substring(4,6)),r=parseInt(e[1].substring(6,8)),s=parseInt(e[1].substring(8,10));if(new Date(Date.UTC(t,o,a,r,s))<n){i=!0;break}}catch(e){console.error("Error parsing expiration date:",e)}}if(i)return;let r=!1;if(e.properties.activations&&Array.isArray(e.properties.activations)&&e.properties.activations.length>0){const t=a.tz(C,"YYYY-MM-DD",o).endOf("day").utc().toDate();for(const o of e.properties.activations){const e=new Date(o[0]),i=new Date(o[1]);if(e<=t&&i>=n){r=!0;break}}if(!r)return}if("R"===e.properties.airspaceClass){let t=!1;if(e.properties.descriptions&&Array.isArray(e.properties.descriptions))for(const o of e.properties.descriptions)if((o.airdescription||"").match(/C\)\s*(\d{10})/)){t=!0;break}if(!t&&!r)return}const s=e.geometry.coordinates[0].map((e=>[e[1],e[0]])),l=L.polygon(s,{color:e.properties.strokeColor||"blue",weight:e.properties.strokeWeight||2,fillColor:e.properties.fillColor||"blue",fillOpacity:e.properties.fillOpacity||.3});l.bindPopup(`<b>${e.properties.name}</b><br><i>Loading details...</i>`,{className:"airspace-popup"}),x.push({polygon:l,data:e.properties,geometry:e.geometry}),window.airspaceXC.addLayer(l)}})),b=function(e){const t=e.popup;if(!(t&&t.options&&t.options.className&&t.options.className.includes("airspace-popup")))return;const o=e.layer,n=t.getLatLng();if(!n)return;const i=[],a=y.zx([n.lng,n.lat]);if(x.forEach(((e,t)=>{let{data:o,geometry:n}=e;try{const e=y.n1(n.coordinates);g.m(a,e)&&i.push(o)}catch(e){console.error(`[AirspaceXC] Error checking point in polygon for index ${t}:`,e)}})),i.length>0){const e=i.map((e=>T(e))).join("<hr style='margin: 5px 0; border-top: 1px solid #ccc;'>");t.setContent(e)}else{const e=x.find((e=>e.polygon===o));e?t.setContent(T(e.data)):(console.error("[AirspaceXC popupopen Listener - Attempt 13] Could not find data for the opened layer!"),t.setContent("Error: Could not find airspace details."))}},window.map.on("popupopen",b),console.log("[AirspaceXC] popupopen listener attached to MAP.")})).catch((e=>console.error("Error fetching airspaces:",e)))}document.addEventListener("change",(function(e){if(!e.target||"airspaceLowerLimit"!==e.target.id&&"airspaceTime"!==e.target.id||window.map&&window.map._popup&&window.map.closePopup(),e.target&&"airspaceLowerLimit"===e.target.id){const t=parseInt(e.target.value,10);t!==v&&(v=t,clearTimeout(w),w=setTimeout((()=>{window.map.hasLayer(window.airspaceXC)&&_()}),300))}if(e.target&&"airspaceTime"===e.target.id){const t=e.target.value;t!==C&&(C=t,clearTimeout(w),w=setTimeout((()=>{window.map.hasLayer(window.airspaceXC)&&_()}),300))}})),window.fetchAirspacesXC=_;function k(e){return["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"][Math.round(e/22.5)%16]}function S(e){return e>=7&&e<=14?"LimeGreen":e>=15&&e<=24?"yellow":e>=25&&e<=30?"orange":e>=31&&e<=36?"red":e>36?"black":"Aquamarine"}function D(e){return e>=15&&e<=24?"LimeGreen":e>=25&&e<=32?"yellow":e>=33&&e<=38?"orange":e>=39&&e<=44?"red":e>44?"black":"Aquamarine"}function E(e){return"black"===e?"white":"black"}window.showTab=function(e,t){console.log("Switching to tab:",e),document.querySelectorAll(".tab-content").forEach((e=>{e.style.display="none"})),document.querySelectorAll(".tab").forEach((e=>{e.classList.remove("active")}));const o=document.getElementById(e);if(o?o.style.display="block":console.error("Tab not found:",e),t?t.classList.add("active"):console.error("Element is null or undefined"),e.startsWith("chart-")){const t=e.split("chart-")[1];console.log("Station ID:",t);const o=document.getElementById(`canvas-${t}`);o&&o.chartInstance&&o.chartInstance.resize()}},window.fetchWindStations=function(){if(!window.map||"function"!=typeof window.map.getBounds)return void console.error("Map not properly initialized");const e=window.map.getBounds(),t=e.getNorthWest().lat,o=e.getNorthWest().lng,n=e.getSouthEast().lat,i=e.getSouthEast().lng;fetch(`/api/wind-data-getCurrent?nwLat=${t}&nwLng=${o}&seLat=${n}&seLng=${i}`).then((e=>e.json())).then((e=>{if(!Array.isArray(e))throw new Error("Invalid data format received from API");windLayer.clearLayers(),console.log("Wind layers cleared"),e.forEach((e=>{const[t,o]=e.loc.coordinates,n=e.last["w-dir"],i=e.last["w-avg"],a=e.last["w-max"],r=(e.last.temp,k(n)),s=new Date(1e3*e.last._id).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),l=S(i),c=D(a),d=e.peak?"‚ñ≤":"‚ñº",p=e._id.includes("holfuy");let m="";p&&(m=e._id.split("-")[1]);const h=`\n          <svg width="30" height="30" viewBox="0 0 800 900" xmlns="http://www.w3.org/2000/svg">\n            <g transform="rotate(${n+90}, 400, 400)" stroke="${c}" stroke-width="60">\n              <path d="M203,391 L75,144 L738,391 L75,637 L203,391 Z" fill="${l}"/>\n            </g>\n            <text x="330" y="850" font-size="220" text-anchor="middle" fill="black" font-weight="bold">\n              ${d}${Math.round(i)} / ${Math.round(a)}\n            </text>\n          </svg>`,u=L.divIcon({className:"wind-arrow",html:h,iconSize:[30,30],iconAnchor:[12,15]}),f=L.marker([o,t],{icon:u}).addTo(windLayer);fetch(`https://winds.mobi/api/2.3/stations/${e._id}/historic/?duration=21000&keys=w-dir&keys=w-avg&keys=w-max&keys=temp`).then((e=>e.json())).then((t=>{const o=function(e){const t={};e.forEach((e=>{const o=new Date(1e3*e._id);o.setMinutes(10*Math.floor(o.getMinutes()/10)),o.setSeconds(0),o.setMilliseconds(0);const n=o.getTime();t[n]||(t[n]={count:0,wAvgSum:0,wMaxSum:0,wDirSum:0,tempSum:0,tempCount:0}),t[n].count++,t[n].wAvgSum+=e["w-avg"],t[n].wMaxSum+=e["w-max"],t[n].wDirSum+=e["w-dir"],void 0!==e.temp&&(t[n].tempSum+=e.temp,t[n].tempCount++)}));const o=Object.keys(t).map((e=>({_id:parseInt(e)/1e3,"w-avg":t[e].wAvgSum/t[e].count,"w-max":t[e].wMaxSum/t[e].count,"w-dir":t[e].wDirSum/t[e].count,temp:t[e].tempCount>0?t[e].tempSum/t[e].tempCount:void 0})));return o.sort(((e,t)=>t._id-e._id)),o}(t),l=Date.now()-18e6,c=o.filter((e=>1e3*e._id>=l)).slice(0,24);let d='<div class="table-responsive"><table class="wind-data-table table">\n              <thead>\n                <tr>\n                  <th>Wind (m/s)</th>\n                  <th>Gusts (m/s)</th>\n                  <th>Direction</th>\n                  <th>Temp C¬∞</th>\n                  <th>Time</th>\n                </tr>\n              </thead>\n              <tbody>';c.forEach((e=>{const t=new Date(1e3*e._id).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),o=k(e["w-dir"]);d+=`<tr>\n                <td class="wind-avg-cell" style="color: ${E(S(e["w-avg"]))}; background-color: ${S(e["w-avg"])};">\n                  ${e["w-avg"].toFixed(1)}\n                </td>\n                <td class="wind-max-cell" style="color: ${E(D(e["w-max"]))}; background-color: ${D(e["w-max"])};">\n                  ${e["w-max"].toFixed(1)}\n                </td>\n                <td style="white-space: nowrap;">\n                  <span class="wind-direction-arrow" style="transform: rotate(${e["w-dir"]+180}deg);">\n                      <i class="fa fa-long-arrow-up"></i>\n                  </span>\n                  &nbsp;&nbsp;${o}\n                </td>\n                <td>${void 0!==e.temp?e.temp.toFixed(1):"N/A"}</td>\n                <td>${t}</td>\n              </tr>`})),d+="</tbody></table></div>";const h=o.slice().reverse(),u=`\n              <div style="display: flex; gap: 1px; align-items: flex-end; max-width: 700px">\n                <div style="flex: 1;" class="wind-station-popup-content">\n                  <strong>${e.short}</strong><br><br>\n                  <tag-name>Wind Speed:&#9;&#9;${i} km/h<br></tag-name>\n                  <tag-name>Max Wind:&#9;&#9;${a} km/h<br></tag-name>\n                  <tag-name>Wind Direction:&#9;${n}¬∞ (${r})<br></tag-name>\n                  <tag-name>Last Update:&#9;&#9;${s}<br><br></tag-name>\n                </div>\n                ${p?`\n                  <div style="flex: 0 0 auto; width: 110px; margin-right: 15px; position: relative;">\n                    <iframe src="https://widget.holfuy.com/?station=${m}&su=km/h&t=C&lang=en&mode=rose&size=110"\n                      width="110"\n                      height="110"\n                      frameborder="0"\n                      scrolling="no"\n                      style="pointer-events: none;">\n                    </iframe>\n                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"></div>\n                  </div>\n                `:""}\n              </div>\n              \n              <div class="tab-container">\n                <div class="tab active" onclick="showTab('table-${e._id}', this)">Table</div>\n                <div class="tab" onclick="showTab('chart-${e._id}', this)">Chart</div>\n                <div class="tab" id="camera-tab-${e._id}" style="display: none;" onclick="showTab('camera-${e._id}', this)">Camera</div>\n              </div>\n              <div id="table-${e._id}" class="tab-content">\n                ${d}\n              </div>\n              <div id="chart-${e._id}" class="tab-content" style="display: none;">\n                <canvas id="canvas-${e._id}" width="400" height="200"></canvas>\n              </div>\n              <div id="camera-${e._id}" class="tab-content" style="display: none;">\n                <img id="camera-image-${e._id}" src="" alt="Camera Image" class="camera-image">\n              </div>\n            `;f.bindPopup(L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:700,minWidth:400,maxHeight:800}).setContent(u)),f.on("popupopen",(()=>{setTimeout((()=>{const t=document.getElementById(`canvas-${e._id}`);if(t){t.style.height="300px";const e=t.getContext("2d");if(e){const o=h.map((e=>({x:1e3*e._id,y:e["w-avg"]}))),n=h.map((e=>({x:1e3*e._id,y:e["w-max"]}))),i=new Chart(e,{type:"line",data:{datasets:[{label:"Wind Avg (km/h)",data:o,borderColor:"blue",fill:!1,pointRadius:3},{label:"Wind Max (km/h)",data:n,borderColor:"red",fill:!1,pointRadius:3}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{bottom:5}},scales:{x:{type:"time",time:{unit:"hour",displayFormats:{hour:"HH:mm"},tooltipFormat:"HH:mm"},grid:{drawBorder:!0},ticks:{autoSkip:!0,maxRotation:0,minRotation:0,padding:30}},y:{beginAtZero:!0,ticks:{stepSize:10,maxTicksLimit:10,font:{size:14}}}},plugins:{legend:{display:!1}}},plugins:[{id:"windDirectionArrows",afterDraw:e=>{const t=e.ctx,o=e.scales.x;t.save();const n=o.top+20;t.textAlign="center",t.textBaseline="middle",h.forEach((e=>{const i=o.getPixelForValue(1e3*e._id);t.save(),t.translate(i,n),t.rotate((e["w-dir"]+180)*Math.PI/180),t.font="extra-bold 12px 'Roboto', sans-serif",t.fillText("‚Üë",0,0),t.restore()})),t.restore()}}]});t.chartInstance=i}else console.error("Failed to get 2D context from canvas.")}else console.error("Canvas element not found.");const o=document.getElementById(`camera-tab-${e._id}`),n=document.getElementById(`camera-image-${e._id}`);if("holfuy-361"===e._id||"holfuy-362"===e._id||"holfuy-363"===e._id){console.log(`Handling special case for ${e._id}`);const t=document.createElement("div");t.classList.add("holfuy-container");const i=document.createElement("div");if(i.textContent="Loading webcam image...",i.classList.add("loading-text"),t.appendChild(i),!n.parentNode)return console.error("Cannot find parent of image element for replacement"),void(o.style.display="none");n.parentNode.replaceChild(t,n),o.style.display="block",console.log("Successfully replaced image with container");const a=document.createElement("div");a.textContent="Loading webcam image...",a.classList.add("loading-text"),t.innerHTML="",t.appendChild(a);let r="https://www.moselfalken.de/zeltingen-rachtig";"holfuy-362"===e._id?r="https://www.moselfalken.de/ockfen":"holfuy-363"===e._id&&(r="https://www.moselfalken.de/meerfeld");const s=`/api/proxy?imageUrl=${r}`;console.log(`[${e._id}] Fetching website HTML from: ${s}`),fetch(s).then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.text()})).then((o=>{const n=(new DOMParser).parseFromString(o,"text/html").querySelectorAll("picture");if(0===n.length)throw new Error("No picture elements found in HTML");let i=null;for(const e of n){const t=e.querySelector("img");if(t&&(t.src.includes("cam")||t.alt&&t.alt.includes("Webcam"))){i=e;break}}i||(i=n[0]);const a=i.querySelectorAll("source"),r=i.querySelector("img");let s="";if(a.length>0){const e=a[a.length-1].getAttribute("srcset");e&&(s=e.split(" ")[0])}if(!s&&r&&(s=r.getAttribute("src")),!s)throw new Error("Could not extract image URL from HTML");s.startsWith("/")?s="https://www.moselfalken.de"+s:s.startsWith("http")||(s="https://www.moselfalken.de/"+s),console.log(`[${e._id}] Extracted image URL: ${s}`);const l=`/api/proxy?imageUrl=${s}`,c=document.createElement("img");c.alt="Moselfalken Webcam",c.classList.add("webcam-image"),console.log(`[${e._id}] Setting image src to proxy: ${l}`),c.src=l,t.innerHTML="",t.appendChild(c)})).catch((t=>{console.error(`[${e._id}] Error fetching/parsing website or extracting image URL:`,t),o.style.display="none"}))}else{const e=`https://holfuy.com/en/takeit/cam/s${m}.jpg`,t=new Image;t.onload=function(){n.src=e,o.style.display="block"},t.onerror=function(){o.style.display="none"},t.src=e,setTimeout((()=>{t.complete&&0!==t.naturalWidth||(o.style.display="none")}),2e3)}}),500)}))})).catch((e=>console.error("Error fetching historical wind data:",e)))}))})).catch((e=>console.error("Error fetching wind station data:",e)))};let A=null,P=null;function I(){"undefined"!=typeof swiperc&&(window.innerWidth<576?($(".swiper2").css("height",""),$(".swiper2").css("width","320px"),$(".swiper2").css("padding-left",""),$(".swiper2").css("padding-top","30px"),$(".swiper2 > .swiper-wrapper").css("width",""),$(".swiper2 > .swiper-wrapper").css("height","100px"),swiperc.changeDirection("horizontal",!0)):(window.innerWidth<840?($(".swiper2").css("width",""),$(".swiper2").css("height","320px")):($(".swiper2").css("width",""),$(".swiper2").css("height","460px")),$(".swiper2").css("padding-top",""),$(".swiper2").css("padding-left","30px"),$(".swiper2 > .swiper-wrapper").css("height",""),$(".swiper2 > .swiper-wrapper").css("width","100px"),swiperc.changeDirection("vertical",!0)))}function j(e){const t={N:0,NNE:22.5,NE:45,ENE:67.5,E:90,ESE:112.5,SE:135,SSE:157.5,S:180,SSW:202.5,SW:225,WSW:247.5,W:270,WNW:292.5,NW:315,NNW:337.5};let o=[];return e.split(",").map((e=>e.trim())).forEach((e=>{let n=e.split("-").map((e=>e.trim()));if(1===n.length){let e=t[n[0]];void 0!==e&&o.push([e-22.5,e+22.5])}else if(2===n.length){let e=t[n[0]],i=t[n[1]];void 0!==e&&void 0!==i&&(i<e&&([e,i]=[i,e]),i-e>180&&([e,i]=[i,e]),o.push([e,i]))}})),o}async function M(e,t){try{const o=await fetch(`/api/places/${t}`),n=await o.json();if(n.error)return void console.error("Error fetching place details:",n.error);let i=/<center><b><a href="http:\/\/www\.paraglidingearth\.com\/index\.php\?site=\d+">More information on ParaglidingEarth<\/a><\/b><\/center>\n?/g,a=/<br>\n<b>Take off : <\/b><br>\n?/g,r=/H \d+(-\d+)? m(?:, |<br>)/g,s=/HD \d+ m(?:<br>| \/)/g,l=/\nrating \d+\/\d+(?:\n|<br>)*/gi,c=(n.properties.description||"").replace(i,"").replace(a,"").replace(r,"").replace(s,"").replace(l,"").trim();if(window.currentPlaceName=n.properties.name,window.currentPlaceId=n.properties.id,window.currentStrPlacemarkId=n.properties.strPlacemarkId,window.appConfig&&!0===window.appConfig.fullSpotsPopoup){console.log("Generating full spot popup (config enabled)");let t=`<span style="color: #0087F7;"><h5>${n.properties.name}</h5></span>\n                                <table style="border-collapse: collapse; width: 70%;">\n                                <tr>\n                                    <th style="text-align: left; vertical-align: top;">Type:</th>\n                                    <td style="text-align: left; vertical-align: top;">${n.properties.type}</td>\n                                </tr>\n                                <tr>\n                                    <th style="text-align: left; vertical-align: top;">Direction:</th>\n                                    <td style="text-align: left; vertical-align: top;">${n.properties.direction}</td>\n                                </tr>\n                                <tr>\n                                    <th style="text-align: left; vertical-align: top;">Rating:</th>\n                                    <td style="text-align: left; vertical-align: top;">${null!=n.properties.rating?n.properties.rating+"/6":" -"}</td>\n                                </tr>\n                                <tr>\n                                    <th style="text-align: left; vertical-align: top;">Height:</th>\n                                    <td style="text-align: left; vertical-align: top;">${null!=n.properties.height?n.properties.height:" -"}</td>\n                                </tr>\n                                <tr>\n                                    <th style="text-align: left; vertical-align: top;">Height difference:</th>\n                                    <td style="text-align: left; vertical-align: top;">${null!=n.properties.heightdifference?n.properties.heightdifference:" -"}</td>\n                                </tr>\n                                <tr>\n                                    <th style="text-align: left; vertical-align: top;">Last Update:</th>\n                                    <td style="text-align: left; vertical-align: top;">${n.properties.lastupdate}</td>\n                                </tr>\n                                </table><br>\n                                <b>Description:</b> <div class="spot-description">${c}</div><br>\n                                <b>¬© <a href="https://paraglidingspots.com" target="_blank">paraglidingspots.com</a></b>\n                                <div class="modal-footer d-flex justify-content-between">\n                                <div id="feedback-message" class="text-start"></div> \x3c!-- Message on the left --\x3e\n                                <div class="d-flex ms-auto">\n                                    <button class="btn btn-primary btn-sm me-2" onclick="showFeebackForm()">Feedback/Correction</button>\n                                    <button class="btn btn-dark btn-sm close-popup">Close</button>\n                                </div>\n                                </div>\n                                `;t+="<style>\n            /* Limit the height of the Swiper container */\n            .swiper-container {\n                max-height: 460px !important;\n                height: 460px !important;\n                overflow: hidden !important;\n            }\n\n            /* Ensure individual Swipers don't expand beyond this height */\n            .swiper, .swiper1, .swiper2 {\n                max-height: 460px !important;\n                height: 460px !important;\n                overflow: hidden !important;\n            }\n\n            /* Limit Swiper wrapper height */\n            .swiper-wrapper {\n                max-height: 460px !important;\n            }\n\n            /* Ensure Swiper slides don't stretch */\n            .swiper-slide {\n                max-height: 460px !important;\n                display: flex !important;\n                align-items: center !important; /* Keep images centered */\n                justify-content: center !important;\n            }\n\n            /* Prevent images from exceeding the swiper height */\n            .swiper-slide img {\n                max-height: 100% !important;\n                width: auto !important;\n            }\n            \n            /* Keep the overall popup size unchanged */\n            .leaflet-popup-content {\n                max-height: 780px !important; /* Keep original popup height */\n                overflow-y: auto; /* Allow scrolling inside the popup if needed */\n            }\n\n            .swiper-clear {\n                clear: both;\n                margin-bottom: 1px;\n            }\n            </style>";const o=document.getElementById("fullScreenInfo"),i=document.getElementById("fullscreen-content-area");if(o&&o.classList.contains("visible")&&i){console.log("Updating fullscreen info content area for spot (config enabled)");const e=o.querySelector("#default-fullscreen-close-btn"),n=o.querySelector("#default-fullscreen-footer");e&&e.remove(),n&&n.remove(),i.innerHTML=t}e.setPopupContent(t),setTimeout((()=>{let e=document.querySelector(".swiper1 .swiper-slide img");if(e){!function(e){let t,o;var n=!(e<4),i=!(e<5);t=new Swiper(".swiper1",{autoHeight:!0,direction:"horizontal",allowTouchMove:!1,mousewheel:!1,slidesPerView:1,loop:!1}),o=new Swiper(".swiper2",{direction:"vertical",allowTouchMove:!0,mousewheel:!0,slidesPerView:3,spaceBetween:10,loop:n,breakpoints:{840:{slidesPerView:4,loop:i}},scrollbar:{el:".swiper-scrollbar",hide:!1,draggable:!0},on:{click:function(){let e=this.clickedSlide.firstChild.id.substring(3)-1;t.slideTo(e,1)},transitionEnd:function(){let e=this.realIndex;t.slideTo(e,1)}}}),I()}(parseInt(e.id.replace(/\D/g,""),10)||1)}}),300),setTimeout((()=>{const t=document.getElementById("fullScreenInfo");let o=null;if(t&&t.classList.contains("visible"))o=t.querySelector("#fullscreen-content-area .close-popup"),o?(o.replaceWith(o.cloneNode(!0)),o=t.querySelector("#fullscreen-content-area .close-popup"),o.addEventListener("click",(function(){console.log("Fullscreen close button clicked"),window.closeFullscreenInfo()}))):console.error("Close button not found in fullscreen view");else{const t=e.getPopup()?.getElement();t&&(o=t.querySelector(".close-popup"),o?(o.replaceWith(o.cloneNode(!0)),o=t.querySelector(".close-popup"),o.addEventListener("click",(function(){console.log("Standard popup close button clicked"),window.map&&window.map.closePopup()}))):console.error("Close button not found in standard popup"))}}),350)}else{console.log("Generating simplified spot popup (config disabled)");const t=`\n                <div class="simplified-spot-popup" style="padding: 5px;">\n                    <span style="color: #0087F7;"><h5>${n.properties.name}</h5></span>\n                    <p style="font-size: 0.9em; margin-top: 10px;">\n                        All Spots are provided under the copyright of paraglidingspots.com.\n                        If you want to see the full details for this spot, please visit\n                        <a href="https://paraglidingspots.com/online/" target="_blank" rel="noopener noreferrer">https://paraglidingspots.com/online/</a>\n                    </p>\n                    <b>¬© <a href="https://paraglidingspots.com" target="_blank">paraglidingspots.com</a></b>\n                </div>\n            `;e.setPopupContent(t);const o=document.getElementById("fullScreenInfo");o&&o.classList.contains("visible")&&window.closeFullscreenInfo()}}catch(e){console.error("Error fetching place details:",e)}}function z(){P&&(P.remove(),P=null),A&&(A.destroy(),A=null);const e=document.getElementById("feedback-message");e&&(e.textContent="",e.classList.remove("text-success","text-danger"));const t=document.getElementById("fullScreenInfo"),o=t&&t.classList.contains("visible"),n=o?t.querySelector("#fullscreen-content-area"):document.querySelector(".leaflet-popup-content");if(!n)return void console.error("Could not find context element for feedback form.");let i=n.querySelector(".modal-footer");i&&(i.style.display="none");const a=`\n        <div id="feedbackFormHtml">\n            <div class="feedback-modal">\n                <span style="color: #0087F7;"><h5>Feedback for ${window.currentPlaceName}</h5></span>\n                <form id="feedbackForm">\n                    <div class="form-group">\n                        <label for="feedbackText">Feedback / Correction / Comment:</label>\n                        <textarea id="feedbackText" class="form-control" required style="height: 130px;"></textarea>\n                    </div>\n                    <div class="form-group">\n                        <label>Upload Images (optional):</label>\n                        <div id="dropzoneFeedback" class="dropzone mt-4 border-dashed rounded-2 min-h-0"></div>\n                    </div>\n                    <div class="form-group d-flex justify-content-between">\n                        <div style="width: 48%;">\n                            <label for="userName">Name:</label>\n                            <input type="text" id="userName" class="form-control" required>\n                        </div>\n                        <div style="width: 48%;">\n                            <label for="userEmail">E-Mail:</label>\n                            <input type="email" id="userEmail" class="form-control" required>\n                            <small class="text-danger d-none" id="emailError">Please enter a valid email address.</small>\n                        </div>\n                    </div>\n                    <button type="submit" class="btn btn-sm btn-success">Submit</button>\n                    <button type="button" class="btn btn-sm btn-secondary" onclick="cancelFeedback()">Cancel</button>\n                </form>\n            </div>\n        </div>\n    `;n?(n.insertAdjacentHTML("beforeend",a),P=n.querySelector("#feedbackFormHtml"),setTimeout((()=>{n&&(n.scrollTo({top:n.scrollHeight,behavior:"smooth"}),n.scrollTop=n.scrollHeight,o&&t&&(t.scrollTo({top:t.scrollHeight,behavior:"smooth"}),t.scrollTop=t.scrollHeight),setTimeout((()=>{const e=document.getElementById("feedbackText");e&&e.focus()}),100))}),200),A=new Dropzone("#dropzoneFeedback",{url:"/upload",autoProcessQueue:!1,maxFiles:5,maxFilesize:100,acceptedFiles:"image/*",addRemoveLinks:!1,dictDefaultMessage:"Drag & drop files here or click to upload",clickable:!0,init:function(){const e=this;this.on("addedfile",(function(t){const o=t.previewElement,n=document.createElement("img");n.src="/assets/images/imgdelete.png",n.alt="Delete",n.classList.add("delete-icon"),o.querySelector(".dz-image").appendChild(n),n.addEventListener("click",(function(o){o.preventDefault(),o.stopPropagation(),e.removeFile(t)}))})),this.on("removedfile",(function(e){console.log("File removed:",e.name)}))}}),document.getElementById("userEmail").addEventListener("input",(function(){const e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value);document.getElementById("emailError").classList.toggle("d-none",e)})),document.getElementById("feedbackForm").addEventListener("submit",(async function(e){e.preventDefault();const t=new FormData;t.append("name",window.currentPlaceName),t.append("id",window.currentPlaceId),t.append("strPlacemarkId",window.currentStrPlacemarkId),t.append("feedbackText",document.getElementById("feedbackText").value),t.append("userName",document.getElementById("userName").value),t.append("userEmail",document.getElementById("userEmail").value),A.files.forEach((e=>{t.append("images",e)}));try{const e=await fetch("/api/send-feedback",{method:"POST",body:t}),o=await e.json();P&&(P.remove(),P=null),A&&(A.destroy(),A=null);const i=n?n.querySelector("#feedback-message"):document.getElementById("feedback-message"),a=n?n.querySelector(".modal-footer"):document.querySelector(".modal-footer");i?o.success?(i.textContent=o.message||"Feedback submitted successfully!",i.classList.remove("text-danger"),i.classList.add("text-success")):(i.textContent=o.error||"An error occurred.",i.classList.remove("text-success"),i.classList.add("text-danger")):console.error("Feedback message div not found in context."),a?a.style.display="flex":console.error("Modal footer not found in context.")}catch(e){console.error("Submission error:",e);const t=n?n.querySelector(".modal-footer"):document.querySelector(".modal-footer");t&&(t.style.display="flex")}}))):console.error("Popup content not found!")}function U(){P&&(P.remove(),P=null),A&&(A.destroy(),A=null);const e=document.getElementById("fullScreenInfo"),t=e&&e.classList.contains("visible")?e.querySelector("#fullscreen-content-area"):document.querySelector(".leaflet-popup-content");if(t){let e=t.querySelector(".modal-footer");e&&(e.style.display="flex")}else{let e=document.querySelector(".modal-footer");e&&(e.style.display="flex")}}function F(){if(!window.map||!window.placesLayerPG)return console.error("Map or placesLayerPG is not defined. Retrying in 500ms..."),void setTimeout(F,500);console.log("Initializing PG spots module..."),window.showFeebackForm=z,window.cancelFeedback=U;const e=L.markerClusterGroup({disableClusteringAtZoom:9,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,maxClusterRadius:250,iconCreateFunction:function(e){return L.divIcon({html:`<div class="cluster-marker">${e.getChildCount()}</div>`,className:"pg-cluster-icon",iconSize:L.point(30,30)})}});window.placesLayerPG.addLayer(e);let t=null,o=null;function n(){window.map.hasLayer(window.placesLayerPG)?(o&&clearTimeout(o),o=setTimeout((()=>{t&&t.abort(),t=new AbortController;const o=t.signal,n=window.map.getBounds(),i=n.getNorthWest().lat,a=n.getNorthWest().lng,r=n.getSouthEast().lat,s=n.getSouthEast().lng;fetch(`/api/places?nw_lat=${i}&nw_lng=${a}&se_lat=${r}&se_lng=${s}&type=TO&type=TOW&type=TH`,{signal:o}).then((e=>e.json())).then((n=>{o.aborted||(e.clearLayers(),L.geoJSON(n,{pointToLayer:function(e,t){return L.marker(t,{icon:L.canvasIcon({iconSize:[50,50],iconAnchor:[15,15],drawIcon:function(t,o){if("icon"===o){var n=t.getContext("2d"),i=L.point(this.options.iconSize),a=L.point(i.x/2,i.y/2);n.clearRect(0,0,i.x,i.y);let o=j(e.properties.direction||"");n.beginPath(),o.forEach((e=>{let[t,o]=e;n.moveTo(a.x,a.y),n.arc(a.x,a.y,a.x,(t-90)*Math.PI/180,(o-90)*Math.PI/180,!1),n.lineTo(a.x,a.y)})),n.fillStyle="orange",n.fill(),n.closePath(),n.beginPath(),n.arc(a.x,a.y,a.x/4,0,2*Math.PI),n.fillStyle="green",n.fill(),n.closePath()}}})})},onEachFeature:function(t,o){if(t.properties){let e=`<b>${t.properties.name}</b><br>\n                                                    Type: ${t.properties.type}<br>\n                                                    Direction: ${t.properties.direction}<br>\n                                                    <i>Loading details...</i>`,n=L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:900,maxHeight:780}).setContent(e);o.bindPopup(n),o.on("popupopen",(async function(){await M(o,t.properties.id)}))}e.addLayer(o)}}),t=null)})).catch((e=>{"AbortError"!==e.name&&console.error("Error fetching PG places:",e)}))}),300)):console.log("PG layer not visible, skipping fetch")}window.fetchPlacesPG=n,window.map.hasLayer(window.placesLayerPG)&&n(),console.log("PG spots module initialized")}function R(){if(!window.map||!window.placesLayerHG)return console.error("Map or placesLayerHG is not defined. Retrying in 500ms..."),void setTimeout(R,500);console.log("Initializing HG spots module..."),window.showFeebackForm=z,window.cancelFeedback=U;const e=L.markerClusterGroup({disableClusteringAtZoom:9,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,maxClusterRadius:250,iconCreateFunction:function(e){return L.divIcon({html:`<div class="cluster-marker">${e.getChildCount()}</div>`,className:"hg-cluster-icon",iconSize:L.point(30,30)})}});window.placesLayerHG.addLayer(e);let t=null,o=null;function n(){o&&clearTimeout(o),o=setTimeout((()=>{t&&t.abort(),t=new AbortController;const o=t.signal,n=window.map.getBounds(),i=n.getNorthWest().lat,a=n.getNorthWest().lng,r=n.getSouthEast().lat,s=n.getSouthEast().lng;fetch(`/api/places?nw_lat=${i}&nw_lng=${a}&se_lat=${r}&se_lng=${s}&type=TO-HG&type=TOW-HG`,{signal:o}).then((e=>e.json())).then((n=>{o.aborted||(e.clearLayers(),L.geoJSON(n,{pointToLayer:function(e,t){return L.marker(t,{icon:L.canvasIcon({iconSize:[50,50],iconAnchor:[15,15],drawIcon:function(t,o){if("icon"===o){var n=t.getContext("2d"),i=L.point(this.options.iconSize),a=L.point(i.x/2,i.y/2);n.clearRect(0,0,i.x,i.y);let o=j(e.properties.direction||"");n.beginPath(),o.forEach((e=>{let[t,o]=e;n.moveTo(a.x,a.y),n.arc(a.x,a.y,a.x,(t-90)*Math.PI/180,(o-90)*Math.PI/180,!1),n.lineTo(a.x,a.y)})),n.fillStyle="orange",n.fill(),n.closePath(),n.beginPath(),n.arc(a.x,a.y,a.x/4,0,2*Math.PI),n.fillStyle="green",n.fill(),n.closePath()}}})})},onEachFeature:function(t,o){if(t.properties){let e=`<b>${t.properties.name}</b><br>\n                                                    Type: ${t.properties.type}<br>\n                                                    Direction: ${t.properties.direction}<br>\n                                                    <i>Loading details...</i>`,n=L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:900,maxHeight:780}).setContent(e);o.bindPopup(n),o.on("popupopen",(async function(){await M(o,t.properties.id)}))}e.addLayer(o)}}),t=null)})).catch((e=>{"AbortError"!==e.name&&console.error("Error fetching HG places:",e)}))}),300)}window.fetchPlacesHG=n,window.map.hasLayer(window.placesLayerHG)&&n(),console.log("PG spots module initialized")}function O(){if(!window.map||!window.placesLayerLZ)return void setTimeout(O,500);console.log("Initializing LZ spots module...");const e=L.markerClusterGroup({disableClusteringAtZoom:9,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,maxClusterRadius:250,iconCreateFunction:function(e){return L.divIcon({html:`<div class="cluster-marker">${e.getChildCount()}</div>`,className:"lz-cluster-icon",iconSize:L.point(30,30)})}});window.placesLayerLZ.addLayer(e);let t=null,o=null;function n(){o&&clearTimeout(o),o=setTimeout((()=>{t&&t.abort(),t=new AbortController;const o=t.signal,n=window.map.getBounds(),i=n.getNorthWest().lat,a=n.getNorthWest().lng,r=n.getSouthEast().lat,s=n.getSouthEast().lng;fetch(`/api/places?nw_lat=${i}&nw_lng=${a}&se_lat=${r}&se_lng=${s}&type=LZ`,{signal:o}).then((e=>e.json())).then((n=>{o.aborted||(e.clearLayers(),L.geoJSON(n,{pointToLayer:function(e,t){return L.marker(t,{icon:L.icon({iconUrl:"../assets/images/windsock.png",iconSize:[20,20],iconAnchor:[20,20]})})},onEachFeature:function(t,o){if(t.properties){let e=`<b>${t.properties.name}</b><br>\n                                                    Type: ${t.properties.type}<br>\n                                                    Direction: ${t.properties.direction}<br>\n                                                    <i>Loading details...</i>`,n=L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:900,maxHeight:780}).setContent(e);o.bindPopup(n),o.on("popupopen",(async function(){await M(o,t.properties.id)}))}e.addLayer(o)}}),t=null)})).catch((e=>{"AbortError"!==e.name&&console.error("Error fetching LZ places:",e)}))}),300)}window.fetchPlacesLZ=n,window.map.hasLayer(window.placesLayerLZ)&&n(),console.log("PG spots module initialized")}document.addEventListener("map_initialized",(function(){console.log("Map initialized event received in PG spots module"),setTimeout(F,100)})),setTimeout((()=>{window.mapInitialized&&(console.log("Backup initialization for PG spots module"),F())}),1e3),document.addEventListener("map_initialized",(function(){console.log("Map initialized event received in HG spots module"),setTimeout(R,100)})),setTimeout((()=>{window.mapInitialized&&(console.log("Backup initialization for HG spots module"),R())}),1e3),document.addEventListener("map_initialized",(function(){console.log("Map initialized event received in LZ spots module"),setTimeout(O,100)})),setTimeout((()=>{window.mapInitialized&&(console.log("Backup initialization for LZ spots module"),O())}),1e3);let N=null,W=L.layerGroup({attribution:'XContest&copy; <a href="https://xcontest.org">XContest</a>'});async function G(e){let t=await fetch(e);return await t.json()}window.obstacleLayer=W,window.fetchObstacles=function(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getBounds(),t=e.getNorthWest(),o=e.getSouthEast(),n=`/api/obstacles?nw_lat=${t.lat}&nw_lng=${t.lng}&se_lat=${o.lat}&se_lng=${o.lng}`;W.clearLayers(),fetch(n).then((e=>e.json())).then((e=>{const t=[];e.features.forEach((e=>{if("LineString"===e.geometry.type){const o=e.geometry.coordinates.map((e=>[e[1],e[0]])),n=L.polyline(o,{color:e.properties.strokeColor||"#ff0000",weight:e.properties.strokeWeight||2});t.push({polyline:n,data:e.properties}),n.addTo(W),n.bindPopup((()=>{const t=[];return e.properties.name&&t.push(`<b>${e.properties.name}</b>`),e.properties.type&&t.push(`Type: ${e.properties.type}`),e.properties.description&&t.push(`Description: ${e.properties.description}`),e.properties.maxAgl&&t.push(`Max AG: ${e.properties.maxAgl}m`),t.join("<br>")}),{className:"obstacle-popup"})}})),console.log(`Added ${t.length} obstacles to the map`),N&&window.map.off("click",N),N=function(e){if(!window.map.hasLayer(W))return;const o=e.latlng,n=[];if(t.forEach((e=>{let{polyline:t,data:i}=e;t.getBounds().contains(o)&&n.push(i)})),n.length>0){const e=n.map((e=>`\n            ${e.name?`<b>${e.name}</b><br>`:""}\n            ${e.type?`Type: ${e.type}<br>`:""}\n            ${e.description?`Description: ${e.description}<br>`:""}\n            ${e.maxAgl?`Max AG: ${e.maxAgl}m<br>`:""}\n          `)).join("<hr>");L.popup({className:"obstacle-popup"}).setLatLng(o).setContent(e).openOn(window.map)}},window.map.on("click",N)})).catch((e=>console.error("Error fetching obstacles:",e)))},L.TimeDimension.Layer.Rainviewer=L.TimeDimension.Layer.extend({initialize:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.attribution=t.attribution||"<a href='https://www.rainviewer.com/api.html' rel='noopener noreferrer' target='_blank'>RainViewer</a>",L.TimeDimension.Layer.prototype.initialize.call(this,L.tileLayer(""),t),this._endpoint=e,this._refreshInterval=this.options.refreshInterval||0,this._refreshTimer=null,this._metadata={},this._frames={},this._layers={},this._defaultTime=12,this._availableTimes=[],this._timeCacheBackward=this.options.cacheBackward||this.options.cache||0,this._timeCacheForward=this.options.cacheForward||this.options.cache||0,this._updateTimeDimension=this.options.updateTimeDimension||!0,this._updateTimeDimensionMode=this.options.updateTimeDimensionMode||"union",this._type=this.options.type||"radar",this._loaded=!1,G(this._endpoint).then((e=>{this._metadata=e,this._loaded=!0,this._map&&this._map.hasLayer(this)&&this._setAvailableTimes()})),this._baseLayer.on("load",function(){this._baseLayer.setLoaded(!0),this.fire("timeload",{time:this._defaultTime})}.bind(this))},onAdd:function(e){L.TimeDimension.Layer.prototype.onAdd.call(this,e),this._loaded&&this._setAvailableTimes(),this._refreshInterval>0&&!this._refreshTimer&&(this._refreshTimer=setInterval(this._refreshData.bind(this),this._refreshInterval))},onRemove:function(e){L.TimeDimension.Layer.prototype.onRemove.call(this,e),this._refreshTimer&&(clearInterval(this._refreshTimer),this._refreshTimer=null)},_setAvailableTimes(){if("radar"==this._type){[...this._metadata.radar.nowcast,...this._metadata.radar.past].forEach((e=>this._frames[1e3*e.time]=e))}else if("satellite"==this._type){this._metadata.satellite.infrared.forEach((e=>this._frames[1e3*e.time]=e))}this._availableTimes=L.TimeDimension.Util.sort_and_deduplicate(Object.keys(this._frames).map((e=>Number(e)))),this._updateCurrentTime=this._updateCurrentTime||this._timeDimension&&0==this._timeDimension.getAvailableTimes().length,this._timeDimension&&(this._updateTimeDimension||0==this._timeDimension.getAvailableTimes().length)&&this._timeDimension.setAvailableTimes(this._availableTimes,this._updateTimeDimensionMode),this._updateCurrentTime&&this._timeDimension&&this._availableTimes.length&&this._timeDimension.setCurrentTime(this._availableTimes[this._defaultTime])},_refreshData:async function(){console.log("Refreshing Rainviewer data ("+this._type+")...");try{const e=await G(this._endpoint);this._metadata=e,this._frames={},this._setAvailableTimes(),this._update(),console.log("Rainviewer data refreshed ("+this._type+").")}catch(e){console.error("Error refreshing Rainviewer data:",e)}},eachLayer:function(e,t){for(var o in this._layers)this._layers.hasOwnProperty(o)&&e.call(t,this._layers[o]);return L.TimeDimension.Layer.prototype.eachLayer.call(this,e,t)},_onNewTimeLoading:function(e){var t=this._getLayerForTime(e.time);this._map.hasLayer(t)||this._map.addLayer(t)},isReady:function(e){var t=this._getLayerForTime(e),o=this._map.getZoom();return!!(t.options.minZoom&&o<t.options.minZoom)||(!!(t.options.maxZoom&&o>t.options.maxZoom)||t.isLoaded())},_update:function(){if(this._map){var e=this._timeDimension.getCurrentTime(),t=this._getLayerForTime(e);null==this._currentLayer&&(this._currentLayer=t),this._map.hasLayer(t)?this._showLayer(t,e):this._map.addLayer(t)}},setOpacity:function(e){for(var t in L.TimeDimension.Layer.prototype.setOpacity.apply(this,arguments),this._layers)this._layers.hasOwnProperty(t)&&this._layers[t].setOpacity&&this._layers[t].setOpacity(e)},setZIndex:function(e){for(var t in L.TimeDimension.Layer.prototype.setZIndex.apply(this,arguments),this._layers)this._layers.hasOwnProperty(t)&&this._layers[t].setZIndex&&this._layers[t].setZIndex(e)},_unvalidateCache:function(){var e=this._timeDimension.getCurrentTime();for(var t in this._layers)e!=t&&this._layers.hasOwnProperty(t)&&(this._layers[t].setLoaded(!1),this._layers[t].redraw())},_evictCachedTimes:function(e,t){var o,n=this._getLoadedTimes(),i=String(this._currentTime),a=n.indexOf(i),r=[];t>-1&&((o=a-t)>0&&(r=n.splice(0,o),this._removeLayers(r)));e>-1&&(a=n.indexOf(i),(o=n.length-a-e-1)>0&&(r=n.splice(a+e+1,o),this._removeLayers(r)))},_showLayer:function(e,t){this._currentLayer&&this._currentLayer!==e&&this._currentLayer.hide(),e.show(),this._currentLayer&&this._currentLayer===e||(this._currentLayer=e,this._currentTime=t,this._evictCachedTimes(this._timeCacheForward,this._timeCacheBackward))},_getLayerForTime:function(e){if(0==e||e==this._defaultTime||null==e||!this._loaded)return this._baseLayer;if(this._layers.hasOwnProperty(e))return this._layers[e];var t=this._getNearestTime(e);if(this._layers.hasOwnProperty(t))return this._layers[t];if(!this._frames.hasOwnProperty(t))return this._baseLayer;var o=this._createLayerForTime(t);return this._layers[e]=o,o.on("load",function(e,t){e.setLoaded(!0),this._layers[t]||(this._layers[t]=e),this._timeDimension&&t==this._timeDimension.getCurrentTime()&&!this._timeDimension.isLoading()&&this._showLayer(e,t),this.fire("timeload",{time:t})}.bind(this,o,e)),o.onAdd=function(e){Object.getPrototypeOf(this).onAdd.call(this,e),this.hide()}.bind(o),o},_createLayerForTime:function(e){var t=this.options,o=this._metadata.host;let n=2;return"satellite"==this._type&&(n=0),new L.TileLayer(o+this._frames[e].path+"/256/{z}/{x}/{y}/"+n+"/1_1.png",t)},_getLoadedTimes:function(){var e=[];for(var t in this._layers)this._layers.hasOwnProperty(t)&&e.push(t);return e.sort((function(e,t){return e-t}))},_removeLayers:function(e){for(var t=0,o=e.length;t<o;t++)this._map&&this._map.removeLayer(this._layers[e[t]]),delete this._layers[e[t]]},setMinimumForwardCache:function(e){e>this._timeCacheForward&&(this._timeCacheForward=e)},_getNearestTime:function(e){if(this._layers.hasOwnProperty(e))return e;if(0==this._availableTimes.length)return e;for(var t=0,o=this._availableTimes.length;t<o&&!(e<this._availableTimes[t]);t++);return t>0&&t--,e!=this._availableTimes[t]&&(console.log("Search layer time: "+new Date(e).toISOString()),console.log("Return layer time: "+new Date(this._availableTimes[t]).toISOString())),this._availableTimes[t]}}),L.timeDimension.layer.rainviewer=function(e,t){return new L.TimeDimension.Layer.Rainviewer(e,t)};const H=new(o(8766).A)({url:`${window.location.origin}/auth`,realm:"master",clientId:"xcmaps-client"});let B=!1,q=null;const X=async()=>{if(console.log("Logout clicked - attempting to save preferences..."),B&&H.hasRealmRole("user")){console.log("User is authenticated and has 'user' role. Saving preferences.");try{const e=function(e){if(!e||!e.getContainer)return console.warn("Layer control not available for getting map state."),{selectedBaseLayer:null,selectedOverlays:[]};const t=e.getContainer();let o=null;const n=[];return t.querySelectorAll('.leaflet-control-layers-base input[type="radio"]').forEach((e=>{if(e.checked){let t=e.closest("label")||e.parentElement.querySelector("span");t&&t.textContent.trim()&&(o=t.textContent.trim(),console.log("Found selected base layer label:",o))}})),t.querySelectorAll('.leaflet-control-layers-overlays input[type="checkbox"]').forEach((e=>{if(e.checked){let t=e.closest("label")||e.parentElement.querySelector("span");if(t&&t.textContent.trim()){const e=t.textContent.trim();["Rain Viewer","Thermals","Spots"].includes(e)?console.log("Skipping potential parent label:",e):(console.log("Found checked overlay layer label:",e),n.push(e))}}})),console.log("Current map state:",{selectedBaseLayer:o,selectedOverlays:n}),{selectedBaseLayer:o,selectedOverlays:n}}(window.treeLayersControl),t={selectedBaseLayer:e.selectedBaseLayer,selectedOverlays:e.selectedOverlays};console.log("Sending preferences to save:",t);const o=await fetch("/api/user/preferences",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${H.token}`},body:JSON.stringify(t)});o.ok?console.log("Preferences saved successfully (including empty state if applicable)."):console.error(`Failed to save preferences: ${o.status} ${o.statusText}`)}catch(e){console.error("Error saving user preferences:",e)}}else console.log("User not logged in or does not have 'user' role. Skipping preference saving.");console.log("Proceeding with Keycloak logout...");try{const e=window.location.origin;B=!1,q=null,H.logout({redirectUri:e})}catch(e){console.error("Error during logout:",e),B=!1,q=null,Z(!1);const t=document.getElementById("profile-badge");t&&t.remove()}},Z=e=>{console.log("Updating user icon, authenticated:",e),setTimeout((()=>{const t=document.querySelector(".user-icon-container");t?(console.log("Found user icon container, updating image"),e?(t.innerHTML='\n          <img id="user-control-icon" src="/assets/images/user-active.svg" width="30" height="30" alt="User (logged in)" />\n        ',console.log("Set active user icon")):(t.innerHTML='\n          <svg id="user-control-icon" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 256 256" xml:space="preserve">\n            <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">\n              <path d="M 45 0 C 20.147 0 0 20.147 0 45 c 0 24.853 20.147 45 45 45 s 45 -20.147 45 -45 C 90 20.147 69.853 0 45 0 z M 45 22.007 c 8.899 0 16.14 7.241 16.14 16.14 c 0 8.9 -7.241 16.14 -16.14 16.14 c -8.9 0 -16.14 -7.24 -16.14 -16.14 C 28.86 29.248 36.1 22.007 45 22.007 z M 45 83.843 c -11.135 0 -21.123 -4.885 -27.957 -12.623 c 3.177 -5.75 8.144 -10.476 14.05 -13.341 c 2.009 -0.974 4.354 -0.958 6.435 0.041 c 2.343 1.126 4.857 1.696 7.473 1.696 c 2.615 0 5.13 -0.571 7.473 -1.696 c 2.083 -1 4.428 -1.015 6.435 -0.041 c 5.906 2.864 10.872 7.591 14.049 13.341 C 66.123 78.957 56.135 83.843 45 83.843 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/>\n            </g>\n          </svg>\n        ',console.log("Set default user icon"))):console.error("User icon container not found")}),500)},V=()=>{try{if(console.log("Creating user control..."),!window.map)return console.error("Map not initialized yet, cannot add user control"),void setTimeout(V,1e3);if(document.getElementById("user-control"))return void console.log("User control already exists, not creating again");L.Control.UserControl=L.Control.extend({onAdd:function(e){console.log("Adding user control to map");const t=L.DomUtil.create("div","leaflet-control-user");return t.id="user-control",t.innerHTML='<div class="user-icon-container"></div>',Z(B),L.DomEvent.on(t,"click",(function(e){L.DomEvent.stopPropagation(e),B?Y(t):(()=>{console.log("Login clicked - redirecting to Keycloak login");try{H.onAuthSuccess=function(){console.log("Authentication successful"),B=!0,H.loadUserProfile().then((e=>{q=e,Z(!0)}))},H.login()}catch(e){console.error("Error during login:",e),alert("Error during login. Please try again later.")}})()})),t}}),L.control.userControl=function(e){return new L.Control.UserControl(e)};const e=L.control.userControl({position:"topright"});return e.addTo(window.map),console.log("User control added to map"),e}catch(e){console.error("Error creating user control:",e)}},Y=e=>{const t=document.getElementById("profile-badge");if(t)return void t.remove();const o=document.createElement("div");o.id="profile-badge",o.className="profile-badge",o.innerHTML=`\n    <div class="profile-info">\n      <div class="profile-name">${q?q.username:"User"}</div>\n      ${q&&q.email?`<div class="profile-email">${q.email}</div>`:""}\n    </div>\n    <div class="profile-actions">\n      <button id="logout-button" class="logout-button">Logout</button>\n    </div>\n  `,e.appendChild(o);const n=document.getElementById("logout-button");n&&L.DomEvent.on(n,"click",(function(e){L.DomEvent.stopPropagation(e),X()}));const i=e=>{const t=document.getElementById("profile-badge"),o=document.getElementById("user-control");t&&o&&!o.contains(e.target)&&(t.remove(),document.removeEventListener("click",i))};setTimeout((()=>{document.addEventListener("click",i)}),100)},K=async()=>{if(B&&H.hasRealmRole("user")){console.log("User is authenticated 'user'. Loading preferences...");try{const e=await fetch("/api/user/preferences",{method:"GET",headers:{Authorization:`Bearer ${H.token}`}});if(!e.ok)return 404===e.status?void console.log("No preferences found for user."):void console.error(`Failed to load preferences: ${e.status} ${e.statusText}`);const t=await e.json();console.log("Received preferences:",t);let o=!1;return t&&window.treeLayersControl?(console.log("Applying preferences to layer control:",t),o=function(e,t){if(!t||!t.getContainer)return console.warn("Layer control not available for applying preferences."),!1;const o=t.getContainer(),{selectedBaseLayer:n=null,selectedOverlays:i=[]}=e,a=new Set(i);let r=!1;console.log("Applying Base Layer:",n),console.log("Applying Overlays:",i);o.querySelectorAll('.leaflet-control-layers-base input[type="radio"]').forEach((e=>{let t=e.closest("label")||e.parentElement.querySelector("span");if(t){t.textContent.trim()===n&&(e.checked?console.log(`Base layer already selected: ${n}`):(console.log(`Clicking base layer radio: ${n}`),e.click()),r=!0)}})),n&&!r&&console.warn(`Could not find base layer radio button for label: ${n}`);return o.querySelectorAll('.leaflet-control-layers-overlays input[type="checkbox"]').forEach((e=>{let t=e.closest("label")||e.parentElement.querySelector("span");if(t){const o=t.textContent.trim(),n=a.has(o);e.checked!==n?(console.log(`Clicking overlay checkbox for: ${o} (Should be checked: ${n})`),e.click()):console.log(`Overlay checkbox already in correct state for: ${o} (Checked: ${e.checked})`)}})),console.log("Finished applying preferences."),r}(t,window.treeLayersControl)):console.log("No preferences found or layer control not ready."),o}catch(e){console.error("Error loading user preferences:",e)}}else console.log("User not logged in or not 'user' role. Skipping preference loading.")};function J(){window.map=L.map("map",{center:[50,6],zoom:9,zoomControl:!1,layers:[],timeDimension:!0}),L.control.zoom({position:"bottomright"}).addTo(window.map);var e=L.tileLayer("https://tile.jawg.io/jawg-terrain/{z}/{x}/{y}{r}.png?access-token=qBDXRu1KSlZGhx4ROlceBD9hcxmrumL34oj29tUkzDVkafqx08tFWPeRNb0KSoKa",{attribution:"Jawg.io"}),t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}),o=L.tileLayer("https://topo.xcontest.app/elev/{z}/{x}/{y}.jpg",{attribution:'XContest&copy; <a href="https://www.xcontest.org">XContest</a>',className:"xcontest-layer"});window.map.on("popupopen",(function(e){const t=document.getElementById("fullScreenInfo"),o=e.popup.getElement();function n(e){console.log("Attempting to show content in fullscreen modal."),window.map.closePopup();try{const o='<div id="default-fullscreen-close-btn" style="position: absolute; top: 10px; right: 10px;"><button onclick="closeFullscreenInfo()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button></div>',n='<div id="default-fullscreen-footer" style="text-align: right; padding: 10px;"><button class="btn btn-dark btn-sm" onclick="closeFullscreenInfo()">Close</button></div>';let i="";"string"==typeof e?i=e:e instanceof Node&&"string"==typeof e.outerHTML?i=e.outerHTML:(console.warn("Popup content is neither string nor DOM node, cannot display in fullscreen."),i="Error: Invalid popup content."),t.innerHTML=o+`<div id="fullscreen-content-area">${i}</div>`+n,t.classList.add("visible"),t.style.display="block",t.style.zIndex="10000",document.getElementById("map").classList.add("map-covered")}catch(e){console.error("Error processing content for fullscreen:",e),t.innerHTML='<div style="padding: 20px;">Error displaying popup content.</div><div style="text-align: right; padding: 10px;"><button class="btn btn-dark btn-sm" onclick="closeFullscreenInfo()">Close</button></div>',t.classList.add("visible"),t.style.display="block",t.style.zIndex="10000",document.getElementById("map").classList.add("map-covered")}}if(window.innerWidth<768){if(o&&o.classList.contains("info-popup")){console.log("Opening Info Popup in fullscreen mode."),window.map.closePopup();try{const o=e.popup.getContent();if("object"!=typeof o||!o.querySelector)return void console.error("Info popup content is not a valid DOM element.");t.innerHTML="",t.appendChild(o);const n=o.querySelector(".info-popup-close"),i=o.querySelector(".info-popup-footer-close");n&&L.DomEvent.on(n,"click",window.closeFullscreenInfo),i&&L.DomEvent.on(i,"click",window.closeFullscreenInfo),t.classList.add("visible"),t.style.display="block",t.style.zIndex="10000",document.getElementById("map").classList.add("map-covered")}catch(e){console.error("Error processing info popup for fullscreen:",e)}return}if(o&&(o.classList.contains("obstacle-popup")||o.classList.contains("airspace-popup")))return void console.log("Skipping fullscreen for obstacle/airspace popup.");if(o&&o.querySelector(".wind-station-popup-content"))return console.log("Opening Wind Station popup in fullscreen mode."),void n(e.popup.getContent());window.appConfig&&!0===window.appConfig.fullSpotsPopoup?(console.log("Opening generic popup in fullscreen mode (config enabled)."),n(e.popup.getContent())):console.log("Skipping fullscreen for generic popup (config disabled).")}})),window.closeFullscreenInfo=function(){var e=document.getElementById("fullScreenInfo");e.classList.remove("visible"),e.innerHTML="",document.getElementById("map").classList.remove("map-covered"),window.map.closePopup()};var n=L.mapboxGL({style:"/assets/maps/maptiler_terrain_wob_testxc.json",apiKey:"c49iG8J3xvAkgCSZ8M8v",className:"xcmap-layer",attribution:"MapTiler Terrain"}),r=L.tileLayer("http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",{attribution:"Map data: Google",maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]}),s=(L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"¬© Esri",id:"MapID"}),L.mapboxGL({style:"/assets/maps/maptiler_terrain_wob_testxc.json",apiKey:"c49iG8J3xvAkgCSZ8M8v",className:"xcmap-layer satellite-overlay",attribution:"MapTiler Terrain"}),L.tileLayer("/api/kk7thermals/{z}/{x}/{y}.png",{attribution:'<a href="https://thermal.kk7.ch">thermal.kk7.ch</a>',maxNativeZoom:12,tms:!0}));L.tileLayer("https://api.maptiler.com/tiles/contours/{z}/{x}/{y}.pbf?key=c49iG8J3xvAkgCSZ8M8v",{attribution:"MapTiler",opacity:.8,className:"contour-overlay",style:{color:"#ffffff",weight:1,opacity:.8}});window.windLayer=L.layerGroup().addTo(window.map),window.oaipMap=L.tileLayer("https://a.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey=171189a4d43c6578ce63758f28363cb3",{attribution:'OpenAIP&copy; <a href="https://www.openaip.net">OpenAIP</a>',className:"oaip-layer"});try{window.rainviewerRadarLayer=L.timeDimension.layer.rainviewer("https://api.rainviewer.com/public/weather-maps.json",{opacity:.7,cache:5,refreshInterval:3e5}).addTo(window.map),window.rainviewerSatelliteLayer=L.timeDimension.layer.rainviewer("https://api.rainviewer.com/public/weather-maps.json",{type:"satellite",opacity:.7,cache:5,refreshInterval:3e5}),console.log("RainViewer layers initialized successfully"),setTimeout((()=>{u()}),500)}catch(e){console.error("Error initializing RainViewer layers:",e),window.rainviewerRadarLayer=L.layerGroup(),window.rainviewerSatelliteLayer=L.layerGroup()}try{window.timeDimensionControl=L.control.timeDimension({position:"bottomleft",playerOptions:{transitionTime:1e3,loop:!0,buffer:2},timeZones:["Local"],autoPlay:!0,speedSlider:!1}),console.log("TimeDimension control initialized successfully")}catch(e){console.error("Error initializing TimeDimension control:",e),window.timeDimensionControl={addTo:function(){console.log("Using dummy TimeDimension control")}}}window.isTimeDimensionControlAdded=!1,window.airspaceGliding=L.layerGroup([],{attribution:'OpenAIP&copy; <a href="https://www.openaip.net">OpenAIP</a>'}),window.airspaceNotam=L.layerGroup([],{attribution:'OpenAIP&copy; <a href="https://www.openaip.net">OpenAIP</a>'}),window.airspaceXC=L.layerGroup([],{attribution:'XContest&copy; <a href="https://xcontest.org">XContest</a>'}),window.placesLayerPG=L.layerGroup([],{attribution:'&copy; <a href="https://paraglidingspots.com">paraglidingspots.com</a>'}),window.placesLayerHG=L.layerGroup([],{attribution:'&copy; <a href="https://paraglidingspots.com">paraglidingspots.com</a>'}),window.placesLayerLZ=L.layerGroup([],{attribution:'&copy; <a href="https://paraglidingspots.com">paraglidingspots.com</a>'});const l=(()=>{let e="";for(let t=0;t<=6;t++){const o=a().add(t,"days"),n=o.format("ddd");e+=`<option value="${o.format("YYYY-MM-DD")}" ${0===t?"selected":""}>${0===t?"Today":n}</option>`}return e})();var c={label:"Base Maps",collapsed:!0,children:[{label:"Terrain",layer:e},{label:"XContest",layer:L.layerGroup([o,n])},{label:"OpenStreetMap",layer:t},{label:"Satellite",layer:r}]},d={label:"Overlays",children:[{label:"Weather Stations",children:[{label:"Weather Stations",layer:window.windLayer,checked:!0}]},{html:'<hr class="leaflet-control-layers-separator">'},{label:"Rain Viewer",children:[{label:"Radar",layer:window.rainviewerRadarLayer,checked:!0},{label:"Satellite",layer:window.rainviewerSatelliteLayer}]},{html:'<hr class="leaflet-control-layers-separator">'},{label:"Thermals",children:[{label:"kk7 Thermals",layer:s}]},{html:'<hr class="leaflet-control-layers-separator">'},{label:"Spots",children:[{label:"Take-off PG",layer:window.placesLayerPG},{label:"Take-off HG",layer:window.placesLayerHG},{label:"Landing Zones",layer:window.placesLayerLZ}]},{html:'<hr class="leaflet-control-layers-separator">'},{label:"Airspaces",children:[{html:`\n                            <div class="airspace-time-control">\n                                Active:\n                                <select class="airspace-time-select" id="airspaceTime">\n                                    ${l}\n                                </select>\n                            </div>\n                        `},{html:'\n                            <div class="airspace-limit-control">\n                                ‚Üß below:\n                                <select class="lower-limit-select" id="airspaceLowerLimit">\n                                    <option value="2000">2000m</option>\n                                    <option value="2500">2500m</option>\n                                    <option value="3000" selected>3000m</option>\n                                    <option value="3500">3500m</option>\n                                    <option value="4000">4000m</option>\n                                    <option value="4500">4500m</option>\n                                </select>\n                            </div>\n                        '},{label:"Airspaces",layer:window.airspaceXC},{label:"Obstacles",layer:window.obstacleLayer},{label:"OpenAIP Map",layer:window.oaipMap}]}]};new i({position:"bottomright"}).addTo(window.map),L.Control.Logo=L.Control.extend({onAdd:function(e){const t=L.DomUtil.create("div","leaflet-control-logo"),o=L.DomUtil.create("img","logo-image",t);return o.src="/assets/images/XCmapsLogo.png",o.alt="XCmaps Logo",o.style.width="120px",o.style.height="auto",L.DomEvent.disableClickPropagation(t),t}}),L.control.logo=function(e){return new L.Control.Logo(e)},L.control.logo({position:"topleft"}).addTo(window.map);var p;L.control.locate({drawCircle:!1,keepCurrentZoomLevel:!0,position:"bottomright",icon:"locate",iconLoading:"loading",iconElementTag:"div",setView:"always",flyTo:!0}).addTo(window.map);window.treeLayersControl=L.control.layers.tree(c,d,{namedToggle:!1,collapsed:!0}).addTo(window.map),treeLayersControl.collapseTree(!1).expandSelected(!0),(p=window.map)?(p.on("zoomend",(function(){window.airspaceXC&&p.hasLayer(window.airspaceXC)&&(console.log("[AirspaceXC] Map zoom ended, re-fetching airspaces based on new zoom level."),clearTimeout(w),w=setTimeout((()=>{_()}),150))})),console.log("[AirspaceXC] zoomend listener attached to map."),p.on("popupopen",b),console.log("[AirspaceXC] popupopen listener attached to MAP via initializer.")):console.error("[AirspaceXC] Invalid map instance provided to initializeAirspaceXCMapListeners.");const m=treeLayersControl.getContainer(),h=m.querySelector(".leaflet-control-layers-toggle");function u(){if(console.log("Updating TimeDimension control visibility"),window.isUpdatingTimeDimensionControl)console.log("Already updating TimeDimension control, skipping");else{window.isUpdatingTimeDimensionControl=!0;try{const e=function(){const e=window.map.hasLayer(window.rainviewerRadarLayer),t=window.map.hasLayer(window.rainviewerSatelliteLayer);return console.log("RainViewer layer check - Radar:",e,"Satellite:",t),e||t}();if(console.log("Should TimeDimension control be visible?",e),console.log("Is TimeDimension control currently added?",window.isTimeDimensionControlAdded),e)if(window.isTimeDimensionControlAdded)console.log("TimeDimension control already added, no action needed");else try{console.log("Adding TimeDimension control to map");const e=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Adding TimeDimension control timed out"))),5e3)})),t=new Promise((e=>{window.timeDimensionControl.addTo(window.map),e()}));return void Promise.race([t,e]).then((()=>{window.isTimeDimensionControlAdded=!0,console.log("TimeDimension control added to map successfully")})).catch((e=>{console.error("Error adding TimeDimension control:",e)})).finally((()=>{window.isUpdatingTimeDimensionControl=!1}))}catch(e){console.error("Error adding TimeDimension control:",e)}else if(window.isTimeDimensionControlAdded)try{console.log("Removing TimeDimension control from map"),window.map.removeControl(window.timeDimensionControl),window.isTimeDimensionControlAdded=!1,console.log("TimeDimension control removed from map successfully")}catch(e){console.error("Error removing TimeDimension control:",e)}else console.log("TimeDimension control already removed, no action needed")}catch(e){console.error("Error in updateTimeDimensionControlVisibility:",e)}window.isUpdatingTimeDimensionControl=!1}}("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&(L.DomEvent.on(h,"click",(function(e){L.DomEvent.stopPropagation(e),L.DomUtil.hasClass(m,"leaflet-control-layers-expanded")?L.DomUtil.removeClass(m,"leaflet-control-layers-expanded"):L.DomUtil.addClass(m,"leaflet-control-layers-expanded")})),L.DomEvent.on(document,"click",(function(){L.DomUtil.hasClass(m,"leaflet-control-layers-expanded")&&L.DomUtil.removeClass(m,"leaflet-control-layers-expanded")})),L.DomEvent.on(m,"click",(function(e){L.DomEvent.stopPropagation(e)}))),window.map.on("moveend",(function(){console.log("Map moveend event triggered"),window.map.hasLayer(window.windLayer)&&"function"==typeof window.fetchWindStations&&(console.log("Fetching wind stations after map move..."),window.fetchWindStations()),window.map.hasLayer(window.placesLayerPG)&&window.fetchPlacesPG&&(console.log("Fetching PG spots after map move..."),window.fetchPlacesPG()),window.map.hasLayer(window.placesLayerHG)&&window.fetchPlacesHG&&(console.log("Fetching HG spots after map move..."),window.fetchPlacesHG()),window.map.hasLayer(window.placesLayerLZ)&&window.fetchPlacesLZ&&(console.log("Fetching LZ spots after map move..."),window.fetchPlacesLZ()),window.map.hasLayer(window.airspaceGliding)&&"function"==typeof window.fetchAirspacesGliding&&(console.log("Fetching airspaces after map move..."),window.fetchAirspacesGliding()),window.map.hasLayer(window.airspaceNotam)&&"function"==typeof window.fetchAirspacesNotam&&(console.log("Fetching airspaces after map move..."),window.fetchAirspacesNotam()),window.map.hasLayer(window.airspaceXC)&&"function"==typeof window.fetchAirspacesXC&&(window.map._popup?console.log("Skipping XC airspace fetch on moveend because popup is open."):(console.log("Fetching XC airspaces after map move (no popup open)..."),window.fetchAirspacesXC())),window.map.hasLayer(window.obstacleLayer)&&"function"==typeof window.fetchObstacles&&(console.log("Fetching airspaces after map move..."),window.fetchObstacles())})),document.addEventListener("change",(function(e){e.target&&"airspaceLowerLimit"===e.target.id&&console.log("Selected limit:",e.target.value),e.target&&"airspaceTime"===e.target.id&&console.log("Selected airspace date:",e.target.value)})),window.map.on("layeradd",(function(e){const t=e.layer;t===window.windLayer&&"function"==typeof window.fetchWindStations?window.fetchWindStations():t===window.placesLayerPG&&window.fetchPlacesPG?window.fetchPlacesPG():t===window.placesLayerHG&&window.fetchPlacesHG?window.fetchPlacesHG():t===window.placesLayerLZ&&window.fetchPlacesLZ?window.fetchPlacesLZ():t===window.airspaceGliding&&"function"==typeof window.fetchAirspacesGliding?window.fetchAirspacesGliding():t===window.airspaceNotam&&"function"==typeof window.fetchAirspacesNotam?window.fetchAirspacesNotam():t===window.airspaceXC&&"function"==typeof window.fetchAirspacesXC?window.fetchAirspacesXC():t===window.obstacleLayer&&"function"==typeof window.fetchObstacles?window.fetchObstacles():t===window.rainviewerRadarLayer?(console.log("RainViewer Radar layer added via layeradd"),u()):t===window.rainviewerSatelliteLayer&&(console.log("RainViewer Satellite layer added via layeradd"),u())}));let f=null;function y(){try{document.querySelectorAll(".leaflet-control-timecontrol.timecontrol-date").forEach((e=>{const t=(e.textContent||e.innerText).match(/(\d{1,2}):(\d{2}):\d{2}\s*(AM|PM)?/i);if(t){let o=parseInt(t[1]);const n=t[2],i=t[3]?t[3].toUpperCase():null;"PM"===i&&o<12?o+=12:"AM"===i&&12===o&&(o=0);const a=`${o.toString().padStart(2,"0")}:${n}`;e.textContent=a}}))}catch(e){console.error("Error updating time display:",e)}}function g(){f&&clearTimeout(f),f=setTimeout((()=>{try{u(),setTimeout(y,500)}catch(e){console.error("Error in debouncedUpdateTimeDimensionControl:",e)}}),100)}document.addEventListener("map_initialized",(function(){try{new MutationObserver((function(e){y()})).observe(document.body,{childList:!0,subtree:!0}),y(),setInterval(y,1e3)}catch(e){console.error("Error setting up time control observer:",e)}})),document.addEventListener("map_initialized",(function(){window.rainviewerRefreshInterval||(window.rainviewerRefreshInterval=setInterval((()=>{try{const e=window.map.hasLayer(window.rainviewerRadarLayer),t=window.map.hasLayer(window.rainviewerSatelliteLayer);(e||t)&&(console.log("Refreshing RainViewer data..."),e&&fetchRainviewerMetadata("https://api.rainviewer.com/public/weather-maps.json").then((e=>{window.rainviewerRadarLayer._metadata=e,window.rainviewerRadarLayer._loaded=!0,window.map.hasLayer(window.rainviewerRadarLayer)&&window.rainviewerRadarLayer._setAvailableTimes()})).catch((e=>console.error("Error refreshing radar data:",e))),t&&fetchRainviewerMetadata("https://api.rainviewer.com/public/weather-maps.json").then((e=>{window.rainviewerSatelliteLayer._metadata=e,window.rainviewerSatelliteLayer._loaded=!0,window.map.hasLayer(window.rainviewerSatelliteLayer)&&window.rainviewerSatelliteLayer._setAvailableTimes()})).catch((e=>console.error("Error refreshing satellite data:",e))))}catch(e){console.error("Error in RainViewer refresh:",e)}}),6e4))})),window.map.on("overlayadd",(function(e){try{console.log("overlayadd event triggered for layer:",e.name),e.layer===window.rainviewerRadarLayer?(console.log("RainViewer Radar layer added"),g()):e.layer===window.rainviewerSatelliteLayer&&(console.log("RainViewer Satellite layer added"),g())}catch(e){console.error("Error in overlayadd event handler:",e)}})),window.map.on("overlayremove",(function(e){try{console.log("overlayremove event triggered for layer:",e.name),e.layer===window.rainviewerRadarLayer?(console.log("RainViewer Radar layer removed"),g()):e.layer===window.rainviewerSatelliteLayer&&(console.log("RainViewer Satellite layer removed"),g())}catch(e){console.error("Error in overlayremove event handler:",e)}})),window.map.on("baselayerchange",(function(e){console.log("baselayerchange event triggered for layer:",e.name)})),window.mapInitialized=!0,console.log("Map initialization complete");const v=new Event("map_initialized");return document.dispatchEvent(v),console.log("Map initialized event dispatched"),(console.log("Initializing Keycloak..."),new Promise(((e,t)=>{try{H.init({onLoad:"check-sso",silentCheckSsoRedirectUri:null,checkLoginIframe:!1}).then((t=>{if(console.log("Keycloak initialized, authenticated:",t),B=t,t)return H.loadUserProfile();e(t)})).then((t=>{t&&(q=t,Z(!0)),e(B)})).catch((t=>{console.error("Failed to initialize Keycloak:",t),e(!1)}))}catch(t){console.error("Error in initKeycloak:",t),e(!1)}}))).then((async t=>{console.log("Keycloak initialized, authenticated:",t),V();if(!await K()&&window.map&&!window.map.hasLayer(e)){console.log("No base layer preference found or applied, adding default Terrain layer."),e.addTo(window.map);const t=window.treeLayersControl?.getContainer();if(t){const e=t.querySelector('.leaflet-control-layers-base input[type="radio"]');e&&!e.checked&&(e.checked=!0)}}})).catch((t=>{if(console.error("Failed to initialize Keycloak:",t),V(),window.map&&!window.map.hasLayer(e)){console.log("Keycloak failed, adding default Terrain layer."),e.addTo(window.map);const t=window.treeLayersControl?.getContainer();if(t){const e=t.querySelector('.leaflet-control-layers-base input[type="radio"]');e&&!e.checked&&(e.checked=!0)}}})),window.map}window.appConfig={fullSpotsPopoup:!1},document.addEventListener("DOMContentLoaded",(async function(){console.log("DOM content loaded, fetching config..."),await async function(){try{const e=await fetch("/api/config");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();window.appConfig={...window.appConfig,...t},console.log("App configuration loaded:",window.appConfig)}catch(e){console.error("Failed to fetch app configuration:",e)}}(),console.log("Config fetched, initializing map...");const e=J();navigator.geolocation.getCurrentPosition((t=>{console.log("Geolocation received");const o=t.coords.latitude,n=t.coords.longitude;e.setView([o,n],10);const i=new CustomEvent("user_location_ready",{detail:{lat:o,lng:n}});document.dispatchEvent(i),console.log("User location event dispatched")}))})),document.addEventListener("user_location_ready",(function(e){console.log("Handling user location ready event"),setTimeout((()=>{if("function"==typeof window.fetchWindStations&&window.mapInitialized&&window.map.hasLayer(window.windLayer))try{console.log("Fetching wind stations"),window.fetchWindStations(e.detail.lat,e.detail.lng)}catch(e){console.error("Error fetching wind stations:",e)}if("function"==typeof window.fetchAirspacesGliding&&window.mapInitialized&&window.map.hasLayer(window.airspaceGliding))try{console.log("Fetching airspaces"),window.fetchAirspacesGliding()}catch(e){console.error("Error fetching airspaces:",e)}if("function"==typeof window.fetchAirspacesNotam&&window.mapInitialized&&window.map.hasLayer(window.airspaceNotam))try{console.log("Fetching airspaces"),window.fetchAirspacesNotam()}catch(e){console.error("Error fetching airspaces:",e)}if("function"==typeof window.fetchAirspacesXC&&window.mapInitialized&&window.map.hasLayer(window.airspaceXC))try{console.log("Fetching airspaces"),window.fetchAirspacesXC()}catch(e){console.error("Error fetching airspaces:",e)}if("function"==typeof window.fetchObstacles&&window.mapInitialized&&window.map.hasLayer(window.obstacleLayer))try{console.log("Fetching obstacles"),window.fetchObstacles()}catch(e){console.error("Error fetching obstacles:",e)}}),500)}))}},o={};function n(e){var i=o[e];if(void 0!==i)return i.exports;var a=o[e]={id:e,loaded:!1,exports:{}};return t[e].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}n.m=t,n.amdO={},e=[],n.O=(t,o,i,a)=>{if(!o){var r=1/0;for(d=0;d<e.length;d++){for(var[o,i,a]=e[d],s=!0,l=0;l<o.length;l++)(!1&a||r>=a)&&Object.keys(n.O).every((e=>n.O[e](o[l])))?o.splice(l--,1):(s=!1,a<r&&(r=a));if(s){e.splice(d--,1);var c=i();void 0!==c&&(t=c)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[o,i,a]},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={792:0};n.O.j=t=>0===e[t];var t=(t,o)=>{var i,a,[r,s,l]=o,c=0;if(r.some((t=>0!==e[t]))){for(i in s)n.o(s,i)&&(n.m[i]=s[i]);if(l)var d=l(n)}for(t&&t(o);c<r.length;c++)a=r[c],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(d)},o=self.webpackChunkXCmaps=self.webpackChunkXCmaps||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))})();var i=n.O(void 0,[96],(()=>n(8109)));i=n.O(i)})();
//# sourceMappingURL=main.bd25c73fce17a2fe685f.js.map