let airspaceDebounceTimer,airspaceClickHandler=null,currentLowerLimit=3e3;function convertToMeters(e,i){switch(i){case 1:return.3048*e;case 2:return e;case 6:return 100*e*.3048;default:return null}}function fetchAirspaces(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getCenter(),i=`/api/airspaces?lat=${e.lat.toFixed(6)}&lng=${e.lng.toFixed(6)}&dist=200000&types=${encodeURIComponent([0,1,3,4,5,7,26,28].join(","))}`;fetch(i).then((e=>e.json())).then((e=>{window.airspaceEFG.clearLayers();const i=[];e.items.forEach((e=>{if(0===e.type&&4===e.icaoClass)return;const n=parseInt(document.getElementById("airspaceLowerLimit").value,10),a=e.lowerLimit;if(!a)return;const r=convertToMeters(a.value,a.unit);if(!(null===r||r>=n)&&e.geometry&&"Polygon"===e.geometry.type){const n=e.geometry.coordinates[0].map((e=>[e[1],e[0]])),a=0===e.lowerLimit.value?"red":"blue",r=(airspaceTypes[e.type],icaoClasses[e.icaoClass],L.polygon(n,{color:a,weight:2,fillOpacity:.3}));i.push({polygon:r,data:e}),window.airspaceEFG.addLayer(r)}})),console.log(`Added ${i.length} airspaces to the map`),airspaceClickHandler&&window.map.off("click",airspaceClickHandler),airspaceClickHandler=function(e){if(!window.map.hasLayer(window.airspaceEFG))return;const n=e.latlng,a=[];if(i.forEach((({polygon:e,data:i})=>{e.getBounds().contains(n)&&a.push(i)})),a.length>0){const e=a.map((e=>`\n            <b>${e.name}</b><br>\n            Type: ${airspaceTypes[e.type]||"Unknown"}<br>\n            ICAO Class: ${icaoClasses[e.icaoClass]||"Unknown"}<br>\n            ID: ${e._id}<br>\n            ↧${e.lowerLimit.value} ${getUnit(e.lowerLimit.unit)}  ↥${e.upperLimit.value} ${getUnit(e.upperLimit.unit)}<br>\n          `)).join("<hr>");L.popup().setLatLng(n).setContent(e).openOn(window.map)}},window.map.on("click",airspaceClickHandler)})).catch((e=>console.error("Error fetching airspaces:",e)))}const airspaceTypes={0:"Other",1:"Restricted",2:"Danger (D)",3:"Prohibited (Parc reserve)",4:"Controlled Tower Region (CTR)",5:"Transponder Mandatory Zone (TMZ)",6:"Radio Mandatory Zone (RMZ)",7:"Terminal Maneuvering Area (TMA)",8:"Temporary Reserved Area (TRA)",9:"Temporary Segregated Area (TSA)",10:"Flight Information Region (FIR)",11:"Upper Flight Information Region (UIR)",12:"Air Defense Identification Zone (ADIZ)",13:"Airport Traffic Zone (ATZ)",14:"Military Airport Traffic Zone (MATZ)",15:"Airway",16:"Military Training Route (MTR)",17:"Alert Area",18:"Warning Area",19:"Protected Area",20:"Helicopter Traffic Zone (HTZ)",21:"Gliding Sector",22:"Transponder Setting (TRP)",23:"Traffic Information Zone (TIZ)",24:"Traffic Information Area (TIA)",25:"Military Training Area (MTA)",26:"Control Area (CTA)",27:"ACC Sector (ACC)",28:"Aerial Sporting Or Recreational Activity",29:"Low Altitude Overflight Restriction",30:"Military Route (MRT)",31:"TSA/TRA Feeding Route (TFR)",32:"VFR Sector",33:"FIS Sector",34:"Lower Traffic Area (LTA)",35:"Upper Traffic Area (UTA)"},icaoClasses={0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",8:"Special Use Airspace (SUA)"};function getUnit(e){return{1:"ft",2:"m",6:"FL"}[e]||"Unknown"}window.fetchAirspaces=fetchAirspaces,document.addEventListener("map_initialized",(function(){console.log("Setting up airspace layer events"),window.map.on("overlayadd",(function(e){"Airspaces"!==e.name&&"Gliding"!==e.name&&"Notam"!==e.name||(console.log(`Overlay added: ${e.name}, fetching airspaces`),fetchAirspaces())})),document.addEventListener("DOMContentLoaded",(function(){document.body.addEventListener("change",(function(e){if(e.target&&"airspaceLowerLimit"===e.target.id){const i=parseInt(e.target.value,10);i!==currentLowerLimit&&(currentLowerLimit=i,clearTimeout(airspaceDebounceTimer),airspaceDebounceTimer=setTimeout((()=>{window.map.hasLayer(window.airspaceEFG)&&(console.log(`Lower limit changed to ${i}m, reloading airspaces`),fetchAirspaces())}),300))}}))})),window.map.on("moveend",(function(){window.map.hasLayer(window.airspaceEFG)&&(console.log("Map moved, refreshing airspaces"),fetchAirspaces())}))}));