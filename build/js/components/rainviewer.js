async function fetchRainviewerMetadata(e){let i=await fetch(e);return await i.json()}L.TimeDimension.Layer.Rainviewer=L.TimeDimension.Layer.extend({initialize:function(e,i={}){i.attribution=i.attribution||"<a href='https://www.rainviewer.com/api.html' rel='noopener noreferrer' target='_blank'>RainViewer</a>",L.TimeDimension.Layer.prototype.initialize.call(this,L.tileLayer(""),i),this._metadata={},this._frames={},this._layers={},this._defaultTime=12,this._availableTimes=[],this._timeCacheBackward=this.options.cacheBackward||this.options.cache||0,this._timeCacheForward=this.options.cacheForward||this.options.cache||0,this._updateTimeDimension=this.options.updateTimeDimension||!0,this._updateTimeDimensionMode=this.options.updateTimeDimensionMode||"union",this._type=this.options.type||"radar",this._loaded=!1,fetchRainviewerMetadata(e).then((e=>{this._metadata=e,this._loaded=!0,this._map&&this._map.hasLayer(this)&&this._setAvailableTimes()})),this._baseLayer.on("load",function(){this._baseLayer.setLoaded(!0),this.fire("timeload",{time:this._defaultTime})}.bind(this))},onAdd:function(e){L.TimeDimension.Layer.prototype.onAdd.call(this,e),this._loaded&&this._setAvailableTimes()},_setAvailableTimes(){if("radar"==this._type){[...this._metadata.radar.nowcast,...this._metadata.radar.past].forEach((e=>this._frames[1e3*e.time]=e))}else if("satellite"==this._type){this._metadata.satellite.infrared.forEach((e=>this._frames[1e3*e.time]=e))}this._availableTimes=L.TimeDimension.Util.sort_and_deduplicate(Object.keys(this._frames).map((e=>Number(e)))),this._updateCurrentTime=this._updateCurrentTime||this._timeDimension&&0==this._timeDimension.getAvailableTimes().length,this._timeDimension&&(this._updateTimeDimension||0==this._timeDimension.getAvailableTimes().length)&&this._timeDimension.setAvailableTimes(this._availableTimes,this._updateTimeDimensionMode),this._updateCurrentTime&&this._timeDimension&&this._availableTimes.length&&this._timeDimension.setCurrentTime(this._availableTimes[this._defaultTime])},eachLayer:function(e,i){for(var t in this._layers)this._layers.hasOwnProperty(t)&&e.call(i,this._layers[t]);return L.TimeDimension.Layer.prototype.eachLayer.call(this,e,i)},_onNewTimeLoading:function(e){var i=this._getLayerForTime(e.time);this._map.hasLayer(i)||this._map.addLayer(i)},isReady:function(e){var i=this._getLayerForTime(e),t=this._map.getZoom();return!!(i.options.minZoom&&t<i.options.minZoom)||(!!(i.options.maxZoom&&t>i.options.maxZoom)||i.isLoaded())},_update:function(){if(this._map){var e=this._timeDimension.getCurrentTime(),i=this._getLayerForTime(e);null==this._currentLayer&&(this._currentLayer=i),this._map.hasLayer(i)?this._showLayer(i,e):this._map.addLayer(i)}},setOpacity:function(e){for(var i in L.TimeDimension.Layer.prototype.setOpacity.apply(this,arguments),this._layers)this._layers.hasOwnProperty(i)&&this._layers[i].setOpacity&&this._layers[i].setOpacity(e)},setZIndex:function(e){for(var i in L.TimeDimension.Layer.prototype.setZIndex.apply(this,arguments),this._layers)this._layers.hasOwnProperty(i)&&this._layers[i].setZIndex&&this._layers[i].setZIndex(e)},_unvalidateCache:function(){var e=this._timeDimension.getCurrentTime();for(var i in this._layers)e!=i&&this._layers.hasOwnProperty(i)&&(this._layers[i].setLoaded(!1),this._layers[i].redraw())},_evictCachedTimes:function(e,i){var t,a=this._getLoadedTimes(),s=String(this._currentTime),r=a.indexOf(s),n=[];i>-1&&((t=r-i)>0&&(n=a.splice(0,t),this._removeLayers(n)));e>-1&&(r=a.indexOf(s),(t=a.length-r-e-1)>0&&(n=a.splice(r+e+1,t),this._removeLayers(n)))},_showLayer:function(e,i){this._currentLayer&&this._currentLayer!==e&&this._currentLayer.hide(),e.show(),this._currentLayer&&this._currentLayer===e||(this._currentLayer=e,this._currentTime=i,console.log("Show layer with time: "+new Date(i).toISOString()),this._evictCachedTimes(this._timeCacheForward,this._timeCacheBackward))},_getLayerForTime:function(e){if(0==e||e==this._defaultTime||null==e||!this._loaded)return this._baseLayer;if(this._layers.hasOwnProperty(e))return this._layers[e];var i=this._getNearestTime(e);if(this._layers.hasOwnProperty(i))return this._layers[i];if(!this._frames.hasOwnProperty(i))return this._baseLayer;var t=this._createLayerForTime(i);return this._layers[e]=t,t.on("load",function(e,i){e.setLoaded(!0),this._layers[i]||(this._layers[i]=e),this._timeDimension&&i==this._timeDimension.getCurrentTime()&&!this._timeDimension.isLoading()&&this._showLayer(e,i),this.fire("timeload",{time:i})}.bind(this,t,e)),t.onAdd=function(e){Object.getPrototypeOf(this).onAdd.call(this,e),this.hide()}.bind(t),t},_createLayerForTime:function(e){var i=this.options,t=this._metadata.host;let a=2;return"satellite"==this._type&&(a=0),new L.TileLayer(t+this._frames[e].path+"/256/{z}/{x}/{y}/"+a+"/1_1.png",i)},_getLoadedTimes:function(){var e=[];for(var i in this._layers)this._layers.hasOwnProperty(i)&&e.push(i);return e.sort((function(e,i){return e-i}))},_removeLayers:function(e){for(var i=0,t=e.length;i<t;i++)this._map&&this._map.removeLayer(this._layers[e[i]]),delete this._layers[e[i]]},setMinimumForwardCache:function(e){e>this._timeCacheForward&&(this._timeCacheForward=e)},_getNearestTime:function(e){if(this._layers.hasOwnProperty(e))return e;if(0==this._availableTimes.length)return e;for(var i=0,t=this._availableTimes.length;i<t&&!(e<this._availableTimes[i]);i++);return i>0&&i--,e!=this._availableTimes[i]&&(console.log("Search layer time: "+new Date(e).toISOString()),console.log("Return layer time: "+new Date(this._availableTimes[i]).toISOString())),this._availableTimes[i]}}),L.timeDimension.layer.rainviewer=function(e,i){return new L.TimeDimension.Layer.Rainviewer(e,i)};