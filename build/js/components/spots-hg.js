import{getAngleRange,loadPlaceDetails,showFeebackForm,cancelFeedback}from"./spots-helper.js";export function initSpotHG(){if(!window.map||!window.placesLayerHG)return console.error("Map or placesLayerHG is not defined. Retrying in 500ms..."),void setTimeout(initSpotHG,500);console.log("Initializing HG spots module..."),window.showFeebackForm=showFeebackForm,window.cancelFeedback=cancelFeedback;const e=L.markerClusterGroup({disableClusteringAtZoom:9,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,maxClusterRadius:250,iconCreateFunction:function(e){return L.divIcon({html:`<div class="cluster-marker">${e.getChildCount()}</div>`,className:"hg-cluster-icon",iconSize:L.point(30,30)})}});window.placesLayerHG.addLayer(e);let o=null,t=null;function n(){t&&clearTimeout(t),t=setTimeout((()=>{o&&o.abort(),o=new AbortController;const t=o.signal,n=window.map.getBounds(),i=n.getNorthWest().lat,a=n.getNorthWest().lng,r=n.getSouthEast().lat,l=n.getSouthEast().lng;fetch(`/api/places?nw_lat=${i}&nw_lng=${a}&se_lat=${r}&se_lng=${l}&type=TO-HG&type=TOW-HG`,{signal:t}).then((e=>e.json())).then((n=>{t.aborted||(e.clearLayers(),L.geoJSON(n,{pointToLayer:function(e,o){return L.marker(o,{icon:L.canvasIcon({iconSize:[50,50],iconAnchor:[15,15],drawIcon:function(o,t){if("icon"===t){var n=o.getContext("2d"),i=L.point(this.options.iconSize),a=L.point(i.x/2,i.y/2);n.clearRect(0,0,i.x,i.y);let t=e.properties.direction||"",r=getAngleRange(t);n.beginPath(),r.forEach((([e,o])=>{n.moveTo(a.x,a.y),n.arc(a.x,a.y,a.x,(e-90)*Math.PI/180,(o-90)*Math.PI/180,!1),n.lineTo(a.x,a.y)})),n.fillStyle="orange",n.fill(),n.closePath(),n.beginPath(),n.arc(a.x,a.y,a.x/4,0,2*Math.PI),n.fillStyle="green",n.fill(),n.closePath()}}})})},onEachFeature:function(o,t){if(o.properties){let e=`<b>${o.properties.name}</b><br>\n                                                    Type: ${o.properties.type}<br>\n                                                    Direction: ${o.properties.direction}<br>\n                                                    <i>Loading details...</i>`,n=L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:900,maxHeight:780}).setContent(e);t.bindPopup(n),t.on("popupopen",(async function(){await loadPlaceDetails(t,o.properties.id)}))}e.addLayer(t)}}),o=null)})).catch((e=>{"AbortError"!==e.name&&console.error("Error fetching HG places:",e)}))}),300)}window.fetchPlacesHG=n,window.map.hasLayer(window.placesLayerHG)&&n(),console.log("PG spots module initialized")}document.addEventListener("map_initialized",(function(){console.log("Map initialized event received in HG spots module"),setTimeout(initSpotHG,100)})),setTimeout((()=>{window.mapInitialized&&(console.log("Backup initialization for HG spots module"),initSpotHG())}),1e3);