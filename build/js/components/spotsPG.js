import{getAngleRange,loadPlaceDetails,showFeebackForm,cancelFeedback}from"./spotsHelper.js";export function initSpotPG(){if(!window.map||!window.placesLayerPG)return console.error("Map or placesLayerPG is not defined. Retrying in 500ms..."),void setTimeout(initSpotPG,500);console.log("Initializing PG spots module..."),window.showFeebackForm=showFeebackForm,window.cancelFeedback=cancelFeedback;const e=L.markerClusterGroup({disableClusteringAtZoom:9,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,maxClusterRadius:250,iconCreateFunction:function(e){return L.divIcon({html:`<div class="cluster-marker">${e.getChildCount()}</div>`,className:"pg-cluster-icon",iconSize:L.point(30,30)})}});function o(){const o=window.map.getBounds(),t=o.getNorthWest().lat,n=o.getNorthWest().lng,i=o.getSouthEast().lat,a=o.getSouthEast().lng;fetch(`http://localhost:3000/api/places?nw_lat=${t}&nw_lng=${n}&se_lat=${i}&se_lng=${a}&type=TO&type=TOW&type=TH`).then((e=>e.json())).then((o=>{e.clearLayers(),L.geoJSON(o,{pointToLayer:function(e,o){return L.marker(o,{icon:L.canvasIcon({iconSize:[50,50],iconAnchor:[15,15],drawIcon:function(o,t){if("icon"===t){var n=o.getContext("2d"),i=L.point(this.options.iconSize),a=L.point(i.x/2,i.y/2);n.clearRect(0,0,i.x,i.y);let t=e.properties.direction||"",r=getAngleRange(t);n.beginPath(),r.forEach((([e,o])=>{n.moveTo(a.x,a.y),n.arc(a.x,a.y,a.x,(e-90)*Math.PI/180,(o-90)*Math.PI/180,!1),n.lineTo(a.x,a.y)})),n.fillStyle="orange",n.fill(),n.closePath(),n.beginPath(),n.arc(a.x,a.y,a.x/4,0,2*Math.PI),n.fillStyle="green",n.fill(),n.closePath()}}})})},onEachFeature:function(o,t){if(o.properties){let e=`<b>${o.properties.name}</b><br>\n                                                Type: ${o.properties.type}<br>\n                                                Direction: ${o.properties.direction}<br>\n                                                <i>Loading details...</i>`,n=L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:900,maxHeight:780}).setContent(e);t.bindPopup(n),t.on("popupopen",(async function(){await loadPlaceDetails(t,o.properties.id)}))}e.addLayer(t)}})})).catch((e=>console.error("Error fetching PG places:",e)))}window.placesLayerPG.addLayer(e),window.map.on("moveend",o),o(),console.log("PG spots module initialized")}document.addEventListener("map_initialized",(function(){console.log("Map initialized event received in PG spots module"),setTimeout(initSpotPG,100)})),setTimeout((()=>{window.mapInitialized&&(console.log("Backup initialization for PG spots module"),initSpotPG())}),1e3);