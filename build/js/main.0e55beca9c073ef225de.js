(()=>{var e,t={625:(e,t,o)=>{"use strict";console.log("L.Control.Layers.Tree has been loaded!"),function(e){if(void 0===e)throw new Error("Leaflet must be included first");e.Control.Layers.Tree=e.Control.Layers.extend({options:{closedSymbol:"+",openedSymbol:"&minus;",spaceSymbol:" ",selectorBack:!1,namedToggle:!1,collapseAll:"",expandAll:"",labelIsSelector:"both"},_initClassesNames:function(){this.cls={children:"leaflet-layerstree-children",childrenNopad:"leaflet-layerstree-children-nopad",hide:"leaflet-layerstree-hide",closed:"leaflet-layerstree-closed",opened:"leaflet-layerstree-opened",space:"leaflet-layerstree-header-space",pointer:"leaflet-layerstree-header-pointer",header:"leaflet-layerstree-header",neverShow:"leaflet-layerstree-nevershow",node:"leaflet-layerstree-node",name:"leaflet-layerstree-header-name",label:"leaflet-layerstree-header-label",selAllCheckbox:"leaflet-layerstree-sel-all-checkbox"}},initialize:function(t,o,n){this._scrollTop=0,this._initClassesNames(),this._baseTree=null,this._overlaysTree=null,e.Util.setOptions(this,n),e.Control.Layers.prototype.initialize.call(this,null,null,n),this._setTrees(t,o)},setBaseTree:function(e){return this._setTrees(e)},setOverlayTree:function(e){return this._setTrees(void 0,e)},addBaseLayer:function(e,t){throw"addBaseLayer is disabled"},addOverlay:function(e,t){throw"addOverlay is disabled"},removeLayer:function(e){throw"removeLayer is disabled"},collapse:function(){return this._scrollTop=this._sect().scrollTop,e.Control.Layers.prototype.collapse.call(this)},expand:function(){e.Control.Layers.prototype.expand.call(this),this._sect().scrollTop=this._scrollTop},onAdd:function(t){function o(e){e._layersTreeName&&(i.innerHTML=e._layersTreeName)}var n=e.Control.Layers.prototype.onAdd.call(this,t);if(this.options.namedToggle){var i=this._container.getElementsByClassName("leaflet-control-layers-toggle")[0];e.DomUtil.addClass(i,"leaflet-layerstree-named-toggle"),t.eachLayer((function(e){o(e)})),t.on("baselayerchange",(function(e){o(e.layer)}),this)}return n},expandTree:function(e){var t=e?this._overlaysList:this._baseLayersList;return t&&this._applyOnTree(t,!1),this._localExpand()},collapseTree:function(e){var t=e?this._overlaysList:this._baseLayersList;return t&&this._applyOnTree(t,!0),this._localExpand()},expandSelected:function(t){function o(t){var i=t.parentElement;if(i){if(e.DomUtil.hasClass(i,n.cls.children)&&!e.DomUtil.hasClass(t,n.cls.childrenNopad)&&e.DomUtil.removeClass(i,a),e.DomUtil.hasClass(i,n.cls.node)){var r=i.getElementsByClassName(n.cls.header)[0];n._applyOnTree(r,!1)}o(i)}}var n=this,i=t?this._overlaysList:this._baseLayersList;if(!i)return this;for(var a=this.cls.hide,r=this._layerControlInputs||i.getElementsByTagName("input"),s=0;s<r.length;s++){var l=r[s];this._getLayer&&!!this._getLayer(l.layerId).overlay!=!!t||l.checked&&o(l.parentElement.parentElement.parentElement.parentElement)}return this._localExpand()},_sect:function(){return this._section||this._form},_setTrees:function(e,t){var o=0;function n(e,t,i){return e&&e.layer&&(i||(e.layer._layersTreeName=e.name||e.label),t[o++]=e.layer),e&&e.children&&e.children.length&&e.children.forEach((function(e){n(e,t,i)})),t}function i(e){return Array.isArray(e)?{noShow:!0,children:e}:e}this._layerControlInputs&&(this._layerControlInputs=[]);for(var a=0;a<this._layers.length;++a)this._layers[a].layer.off("add remove",this._onLayerChange,this);this._layers=[],void 0!==e&&(this._baseTree=i(e)),void 0!==t&&(this._overlaysTree=i(t));var r=n(this._baseTree,{});for(var s in r)this._addLayer(r[s],s);var l=n(this._overlaysTree,{},!0);for(var c in l)this._addLayer(l[c],c,!0);return this._map?this._update():this},_localExpand:function(){if(this._map&&e.DomUtil.hasClass(this._container,"leaflet-control-layers-expanded")){var t=this._sect().scrollTop;this.expand(),this._sect().scrollTop=t,this._scrollTop=t}return this},_applyOnTree:function(t,o){[{cls:this.cls.children,hide:o},{cls:this.cls.opened,hide:o},{cls:this.cls.closed,hide:!o}].forEach((function(o){for(var n=t.getElementsByClassName(o.cls),i=0;i<n.length;i++){var a=n[i];e.DomUtil.hasClass(a,this.cls.childrenNopad)||(o.hide?e.DomUtil.addClass(a,this.cls.hide):e.DomUtil.removeClass(a,this.cls.hide))}}),this)},_addItem:function(e){},_update:function(){return this._container?(e.Control.Layers.prototype._update.call(this),this._addTreeLayout(this._baseTree,!1),this._addTreeLayout(this._overlaysTree,!0),this._localExpand()):this},_addTreeLayout:function(e,t){if(e){var o=t?this._overlaysList:this._baseLayersList;this._expandCollapseAll(t,this.options.collapseAll,this.collapseTree),this._expandCollapseAll(t,this.options.expandAll,this.expandTree),this._iterateTreeLayout(e,o,t,[],e.noShow),this._checkDisabledLayers&&this._checkDisabledLayers()}},_expandCollapseAll:function(t,o,n,i){var a=t?this._overlaysList:this._baseLayersList;if(i=i||this,o){var r=document.createElement("div");r.className="leaflet-layerstree-expand-collapse",a.appendChild(r),r.innerHTML=o,r.tabIndex=0,e.DomEvent.on(r,"click keydown",(function(e){"keydown"===e.type&&32!==e.keyCode||(r.blur(),n.call(i,t),this._localExpand())}),this)}},_iterateTreeLayout:function(t,o,n,i,a){if(t)if(t.html){A("div","leaflet-layerstree-html-container",o).innerHTML=t.html}else{var r,s=A("div",this.cls.header,o),l=A("span"),c=A("span"),p=A("span",this.cls.closed,l,this.options.closedSymbol),d=A("span",this.cls.opened,l,this.options.openedSymbol),m=A("span",this.cls.space,null,this.options.spaceSymbol);this.options.selectorBack?(l.insertBefore(m,p),s.appendChild(c),s.appendChild(l)):(l.appendChild(m),s.appendChild(l),s.appendChild(c)),t.selectAllCheckbox&&((r=this._createCheckboxElement(!1)).className+=" "+this.cls.selAllCheckbox);var h=this.cls.hide;if(t.children){var u=A("div",this.cls.children,o),f=t.layer?l:s;e.DomUtil.addClass(f,this.cls.pointer),f.tabIndex=0,e.DomEvent.on(f,"click keydown",(function(t){this._preventClick||"keydown"===t.type&&32!==t.keyCode||(f.blur(),e.DomUtil.hasClass(d,h)?(e.DomUtil.addClass(p,h),e.DomUtil.removeClass(d,h),e.DomUtil.removeClass(u,h)):(e.DomUtil.removeClass(p,h),e.DomUtil.addClass(d,h),e.DomUtil.addClass(u,h)),this._localExpand())}),this),r&&i.splice(0,0,o),t.children.forEach((function(e){var t=A("div",this.cls.node,u);this._iterateTreeLayout(e,t,n,i)}),this),r&&i.splice(0,1)}else e.DomUtil.addClass(l,this.cls.neverShow);var g,w=A(t.layer&&("both"===this.options.labelIsSelector||n&&"overlay"===this.options.labelIsSelector||!n&&"base"===this.options.labelIsSelector)?"label":"span",this.cls.label,c);if(t.layer){var y,v=this._map.hasLayer(t.layer),b=n?t.radioGroup:"leaflet-base-layers_"+e.Util.stamp(this);b?y=this._createRadioElement(b,v):k(y=this._createCheckboxElement(v),this),this._layerControlInputs&&this._layerControlInputs.push(y),y.layerId=e.Util.stamp(t.layer),e.DomEvent.on(y,"click",this._onInputClick,this),w.appendChild(y)}t.selectAllCheckbox&&(w.appendChild(r),("string"==typeof(g=t.selectAllCheckbox)||g instanceof String)&&(r.title=t.selectAllCheckbox),e.DomEvent.on(r,"click",(function(e){e.stopPropagation(),E(r.checked,this)}),this),_(o),k(r,this)),A("span",this.cls.name,w,t.label),e.DomUtil.addClass(t.collapsed?d:p,h),t.collapsed&&u&&e.DomUtil.addClass(u,h),a&&(e.DomUtil.addClass(s,this.cls.neverShow),e.DomUtil.addClass(u,this.cls.childrenNopad));var L=t.eventedClasses;L instanceof Array||(L=[L]);for(var x=0;x<L.length;x++){var C=L[x];if(C&&C.className){var T=o.querySelector("."+C.className);T&&e.DomEvent.on(T,C.event||"click",function(e){return function(n){n.stopPropagation();var i,a=(i=e)&&"[object Function]"==={}.toString.call(i)?e(n,o,t,this._map):e;null!=a&&E(a,this)}}(C.selectAll),this)}}}function A(t,o,n,i){var a=e.DomUtil.create(t,o,n);return i&&(a.innerHTML=i),a}function _(e){var t=e.querySelector("input[type=checkbox]"),o=!0,n=!0,i=e.querySelectorAll("input[type=checkbox]");[].forEach.call(i,(function(e){e===t||(e.indeterminate?(o=!1,n=!1):e.checked?n=!1:e.checked||(o=!1))})),o?(t.indeterminate=!1,t.checked=!0):n?(t.indeterminate=!1,t.checked=!1):(t.indeterminate=!0,t.checked=!1)}function k(t,o){i.forEach((function(n){e.DomEvent.on(t,"click",(function(e){_(n)}),o)}),o)}function E(e,t){for(var n=o.getElementsByTagName("input"),i=0;i<n.length;i++){var a=n[i];"checkbox"===a.type&&(a.checked=e,a.indeterminate=!1)}t._onInputClick()}},_createCheckboxElement:function(e){var t=document.createElement("input");return t.type="checkbox",t.className="leaflet-control-layers-selector",t.defaultChecked=e,t}}),e.control.layers.tree=function(t,o,n){return new e.Control.Layers.Tree(t,o,n)}}(L),console.log("L.Control.Layers.Tree has been loaded!"),L.ResponsivePopup=L.Popup.extend({options:{hasTip:!0},_initLayout:function(){var e="leaflet-popup",t=this._container=L.DomUtil.create("div",e+" "+(this.options.className||"")+" leaflet-zoom-animated"),o=this._wrapper=L.DomUtil.create("div",e+"-content-wrapper",t);if(this._contentNode=L.DomUtil.create("div",e+"-content",o),L.DomEvent.disableClickPropagation(t),L.DomEvent.disableScrollPropagation(this._contentNode),L.DomEvent.on(t,"contextmenu",L.DomEvent.stopPropagation),this._tipContainer=L.DomUtil.create("div",e+"-tip-container",t),this.options.hasTip||(this._tipContainer.style.visibility="hidden"),this._tip=L.DomUtil.create("div",e+"-tip",this._tipContainer),this.options.closeButton){var n=this._closeButton=L.DomUtil.create("a",e+"-close-button",t);n.setAttribute("role","button"),n.setAttribute("aria-label","Close popup"),n.href="#close",n.innerHTML='<span aria-hidden="true">&#215;</span>',L.DomEvent.on(n,"click",(function(e){L.DomEvent.preventDefault(e),this.close()}),this)}},_updatePosition:function(){if(this._map){var e=this._map.latLngToLayerPoint(this._latlng),t=this._map.layerPointToContainerPoint(e),o=this._container.offsetWidth,n=this._container.offsetHeight,i=L.point(this.options.autoPanPadding),a=L.point(this.options.autoPanPaddingTopLeft||i),r=L.point(this.options.autoPanPaddingBottomRight||i),s=this._map.getSize(),l=this._getAnchor(),c=L.point(this.options.offset),p=12,d=Math.abs(c.x),m=Math.abs(c.y);this.options.hasTip&&(d+=11,m+=11,L.DomUtil.removeClass(this._container,"leaflet-resp-popup-north"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-south"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-east"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-west"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-north-east"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-north-west"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-south-east"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-south-west"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-east-north"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-east-south"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-west-north"),L.DomUtil.removeClass(this._container,"leaflet-resp-popup-west-south"));var h=!0,u=!0,f=!0,g=!0,w=!1;t.y+l.y-m-n-Math.abs(a.y)<0&&(h=!1),t.y+l.y+m+n+Math.abs(r.y)>s.y&&(u=!1),t.x+l.x-d-o-Math.abs(a.x)<0&&(f=!1),t.x+l.x+d+o+Math.abs(r.x)>s.x&&(g=!1);var y=o/2-l.x,v=n/2-l.y;if(h||u){var b=t.x+l.x-o/2,x=t.x+l.x+o/2;b<Math.abs(a.x)&&(y=o/2-l.x-Math.abs(a.x)+b),x>s.x-Math.abs(r.x)&&(y=o/2-l.x+x-s.x+Math.abs(r.x))}if(f||g){var C=t.y+l.y-n/2,T=t.y+l.y+n/2;C<Math.abs(a.y)&&(v=n/2-l.y-Math.abs(a.y)+C),T>s.y-Math.abs(r.y)&&(v=n/2-l.y+T-s.y+Math.abs(r.y))}if(h)w=e.subtract(L.point(y,-l.y+n+m,!0)),this.options.hasTip&&(t.x+l.x<a.x+p+11?(w.x=e.x+l.x,L.DomUtil.addClass(this._container,"leaflet-resp-popup-north-east"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left="0px"):t.x+l.x>s.x-r.x-p-11?(w.x=e.x+l.x-o,L.DomUtil.addClass(this._container,"leaflet-resp-popup-north-west"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left=o+"px"):(L.DomUtil.addClass(this._container,"leaflet-resp-popup-north"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left=e.x+l.x-w.x+"px"));else if(f)w=e.subtract(L.point(-l.x+o+d,v,!0)),this.options.hasTip&&(t.y+l.y<a.y+p+11?(w.y=e.y+l.y,L.DomUtil.addClass(this._container,"leaflet-resp-popup-west-south"),this._tipContainer.style.top="0px",this._tipContainer.style.left=o+"px"):t.y+l.y>s.y-r.y-p-11?(w.y=e.y+l.y-n,L.DomUtil.addClass(this._container,"leaflet-resp-popup-west-north"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left=o+"px"):(L.DomUtil.addClass(this._container,"leaflet-resp-popup-west"),this._tipContainer.style.top=e.y+l.y-w.y+"px",this._tipContainer.style.left=o+"px"));else if(u)w=e.subtract(L.point(y,-l.y-m,!0)),this.options.hasTip&&(t.x+l.x<a.x+p+11?(w.x=e.x+l.x,L.DomUtil.addClass(this._container,"leaflet-resp-popup-south-east"),this._tipContainer.style.top="0px",this._tipContainer.style.left="0px"):t.x+l.x>s.x-r.x-p-11?(w.x=e.x+l.x-o,L.DomUtil.addClass(this._container,"leaflet-resp-popup-south-west"),this._tipContainer.style.top="0px",this._tipContainer.style.left=o+"px"):(L.DomUtil.addClass(this._container,"leaflet-resp-popup-south"),this._tipContainer.style.top="0px",this._tipContainer.style.left=e.x+l.x-w.x+"px"));else if(g)w=e.subtract(L.point(-l.x-d,v,!0)),this.options.hasTip&&(t.y+l.y<a.y+p+11?(w.y=e.y+l.y,L.DomUtil.addClass(this._container,"leaflet-resp-popup-east-south"),this._tipContainer.style.top="0px",this._tipContainer.style.left="0px"):t.y+l.y>s.y-r.y-p-11?(w.y=e.y+l.y-n,L.DomUtil.addClass(this._container,"leaflet-resp-popup-east-north"),this._tipContainer.style.top=n+"px",this._tipContainer.style.left="0px"):(L.DomUtil.addClass(this._container,"leaflet-resp-popup-east"),this._tipContainer.style.top=e.y+l.y-w.y+"px",this._tipContainer.style.left="0px"));else{w=(e=this._map.latLngToLayerPoint(this._map.getCenter())).subtract(L.point(o/2,n/2)),this.options.hasTip}t.x<0||t.y<0||t.x>s.x||(t.y,s.y),o-Math.abs(a.x)-Math.abs(r.x)>s.x||(Math.abs(a.y),Math.abs(r.y),s.y),L.DomUtil.setPosition(this._container,w)}}}),L.responsivePopup=function(e,t){return new L.ResponsivePopup(e,t)},"object"==typeof exports&&"undefined"!=typeof module&&(exports.responsivePopup=L.responsivePopup,exports.ResponsivePopup=L.ResponsivePopup);const n=L.Control.extend({onAdd:function(e){var t=L.DomUtil.create("div","info-control leaflet-bar leaflet-control"),o=L.DomUtil.create("a","leaflet-control-button",t);o.href="#";var n=L.DomUtil.create("img","info-control-icon",o);return n.src="assets/images/info.png",n.alt="Information",n.style.width="24px",n.style.height="24px",n.style.padding="4px",L.DomEvent.disableClickPropagation(t),L.DomEvent.on(o,"click",(function(t){L.DomEvent.stop(t);L.popup({className:"info-popup",autoPan:!0,maxWidth:700,offset:[0,300]}).setLatLng(e.getCenter()).setContent('<div class="info-popup-content" style="padding: 10px;"><h3>About XCmaps</h3><p>XCmaps combines various data sources for aerial sports navigation.</p><p>You can contact us by <a href="mailto:info@XCmaps.com" target="_blank">email</a>, or report any issue on github.</p><p><strong>Credits:</strong></p><ul><li>Terrain tiles by <a href="https://www.jawg.io" target="_blank"></a></li><li>OpenStreetMap</li><li>XContest terrain data</li><li>MapTiler for GL layer</li><li>Airspaces: Airspaces are imported from openaip:"OpenAIP data is not certified and must not be used for primary navigation or flight planning. Never rely on openAIP data! OpenAIP data contains errors. Using openAIP data may result in serious injury or death."</li><li>Wind Stations: based on <a href="https://github.com/winds-mobi/" target="_blank">winds.mobi</a> by Yann Savary and additional data sources</li><li>Spots: © <a href="https://paraglidingspots.com" target="_blank">paraglidingspots.com</a> by Karsten Ehlers</li><li>and many more open source libraries, projects, and artwork</li></ul><p>This map combines various data sources for aerial sports navigation.</p></div>').openOn(e)})),t}});var i=o(5093);o(4837);let a,r=null,s=3e3;function l(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getCenter(),t=`/api/airspaces?lat=${e.lat.toFixed(6)}&lng=${e.lng.toFixed(6)}&dist=200000&types=${encodeURIComponent([0,1,3,4,5,7,26,28].join(","))}`;fetch(t).then((e=>e.json())).then((e=>{window.airspaceEFG.clearLayers();const t=[];e.items.forEach((e=>{if(0===e.type&&4===e.icaoClass)return;const o=parseInt(document.getElementById("airspaceLowerLimit").value,10),n=e.lowerLimit;if(!n)return;const i=function(e,t){switch(t){case 1:return.3048*e;case 2:return e;case 6:return 100*e*.3048;default:return null}}(n.value,n.unit);if(!(null===i||i>=o)&&e.geometry&&"Polygon"===e.geometry.type){const o=e.geometry.coordinates[0].map((e=>[e[1],e[0]])),n=0===e.lowerLimit.value?"red":"blue",i=(c[e.type],p[e.icaoClass],L.polygon(o,{color:n,weight:2,fillOpacity:.3}));t.push({polygon:i,data:e}),window.airspaceEFG.addLayer(i)}})),console.log(`Added ${t.length} airspaces to the map`),r&&window.map.off("click",r),r=function(e){if(!window.map.hasLayer(window.airspaceEFG))return;const o=e.latlng,n=[];if(t.forEach((e=>{let{polygon:t,data:i}=e;t.getBounds().contains(o)&&n.push(i)})),n.length>0){const e=n.map((e=>`\n            <b>${e.name}</b><br>\n            Type: ${c[e.type]||"Unknown"}<br>\n            ICAO Class: ${p[e.icaoClass]||"Unknown"}<br>\n            ID: ${e._id}<br>\n            ↧${e.lowerLimit.value} ${d(e.lowerLimit.unit)}  ↥${e.upperLimit.value} ${d(e.upperLimit.unit)}<br>\n          `)).join("<hr>");L.popup().setLatLng(o).setContent(e).openOn(window.map)}},window.map.on("click",r)})).catch((e=>console.error("Error fetching airspaces:",e)))}const c={0:"Other",1:"Restricted",2:"Danger (D)",3:"Prohibited (Parc reserve)",4:"Controlled Tower Region (CTR)",5:"Transponder Mandatory Zone (TMZ)",6:"Radio Mandatory Zone (RMZ)",7:"Terminal Maneuvering Area (TMA)",8:"Temporary Reserved Area (TRA)",9:"Temporary Segregated Area (TSA)",10:"Flight Information Region (FIR)",11:"Upper Flight Information Region (UIR)",12:"Air Defense Identification Zone (ADIZ)",13:"Airport Traffic Zone (ATZ)",14:"Military Airport Traffic Zone (MATZ)",15:"Airway",16:"Military Training Route (MTR)",17:"Alert Area",18:"Warning Area",19:"Protected Area",20:"Helicopter Traffic Zone (HTZ)",21:"Gliding Sector",22:"Transponder Setting (TRP)",23:"Traffic Information Zone (TIZ)",24:"Traffic Information Area (TIA)",25:"Military Training Area (MTA)",26:"Control Area (CTA)",27:"ACC Sector (ACC)",28:"Aerial Sporting Or Recreational Activity",29:"Low Altitude Overflight Restriction",30:"Military Route (MRT)",31:"TSA/TRA Feeding Route (TFR)",32:"VFR Sector",33:"FIS Sector",34:"Lower Traffic Area (LTA)",35:"Upper Traffic Area (UTA)"},p={0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",8:"Special Use Airspace (SUA)"};function d(e){return{1:"ft",2:"m",6:"FL"}[e]||"Unknown"}window.fetchAirspaces=l,document.addEventListener("map_initialized",(function(){console.log("Setting up airspace layer events"),window.map.on("overlayadd",(function(e){"Airspaces"!==e.name&&"Gliding"!==e.name&&"Notam"!==e.name||(console.log(`Overlay added: ${e.name}, fetching airspaces`),l())})),document.addEventListener("DOMContentLoaded",(function(){document.body.addEventListener("change",(function(e){if(e.target&&"airspaceLowerLimit"===e.target.id){const t=parseInt(e.target.value,10);t!==s&&(s=t,clearTimeout(a),a=setTimeout((()=>{window.map.hasLayer(window.airspaceEFG)&&(console.log(`Lower limit changed to ${t}m, reloading airspaces`),l())}),300))}}))})),window.map.on("moveend",(function(){window.map.hasLayer(window.airspaceEFG)&&(console.log("Map moved, refreshing airspaces"),l())}))}));let m=null;function h(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getCenter(),t=`https://xcmaps.com:2000/api/airspaces?lat=${e.lat.toFixed(6)}&lng=${e.lng.toFixed(6)}&dist=200000&types=${encodeURIComponent([21].join(","))}`;fetch(t).then((e=>e.json())).then((e=>{window.airspaceGliding.clearLayers();const t=[];e.items.forEach((e=>{if((0!==e.type||4!==e.icaoClass)&&e.geometry&&"Polygon"===e.geometry.type){const o=e.geometry.coordinates[0].map((e=>[e[1],e[0]])),n=0===e.lowerLimit.value?"red":"green",i=(u[e.type],f[e.icaoClass],L.polygon(o,{color:n,weight:2,fillOpacity:.3}));t.push({polygon:i,data:e}),window.airspaceGliding.addLayer(i)}})),console.log(`Added ${t.length} airspaces to the map`),m&&window.map.off("click",m),m=function(e){if(!window.map.hasLayer(window.airspaceGliding))return;const o=e.latlng,n=[];if(t.forEach((e=>{let{polygon:t,data:i}=e;t.getBounds().contains(o)&&n.push(i)})),n.length>0){const e=n.map((e=>`\n            <b>${e.name}</b><br>\n            Type: ${u[e.type]||"Unknown"}<br>\n            ICAO Class: ${f[e.icaoClass]||"Unknown"}<br>\n            ↧${e.lowerLimit.value} ${g(e.lowerLimit.unit)}  ↥${e.upperLimit.value} ${g(e.upperLimit.unit)}<br>\n          `)).join("<hr>");L.popup().setLatLng(o).setContent(e).openOn(window.map)}},window.map.on("click",m)})).catch((e=>console.error("Error fetching airspaces:",e)))}const u={0:"Other",1:"Restricted",2:"Danger (D)",3:"Prohibited (Parc reserve)",4:"Controlled Tower Region (CTR)",5:"Transponder Mandatory Zone (TMZ)",6:"Radio Mandatory Zone (RMZ)",7:"Terminal Maneuvering Area (TMA)",8:"Temporary Reserved Area (TRA)",9:"Temporary Segregated Area (TSA)",10:"Flight Information Region (FIR)",11:"Upper Flight Information Region (UIR)",12:"Air Defense Identification Zone (ADIZ)",13:"Airport Traffic Zone (ATZ)",14:"Military Airport Traffic Zone (MATZ)",15:"Airway",16:"Military Training Route (MTR)",17:"Alert Area",18:"Warning Area",19:"Protected Area",20:"Helicopter Traffic Zone (HTZ)",21:"Gliding Sector",22:"Transponder Setting (TRP)",23:"Traffic Information Zone (TIZ)",24:"Traffic Information Area (TIA)",25:"Military Training Area (MTA)",26:"Control Area (CTA)",27:"ACC Sector (ACC)",28:"Aerial Sporting Or Recreational Activity",29:"Low Altitude Overflight Restriction",30:"Military Route (MRT)",31:"TSA/TRA Feeding Route (TFR)",32:"VFR Sector",33:"FIS Sector",34:"Lower Traffic Area (LTA)",35:"Upper Traffic Area (UTA)"},f={0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",8:"Special Use Airspace (SUA)"};function g(e){return{1:"ft",6:"FL"}[e]||"Unknown"}window.fetchAirspacesGliding=h,document.addEventListener("map_initialized",(function(){console.log("Setting up airspace layer events"),window.map.on("overlayadd",(function(e){"Airspaces"!==e.name&&"Gliding"!==e.name&&"Notam"!==e.name||(console.log(`Overlay added: ${e.name}, fetching airspaces`),h())})),window.map.on("moveend",(function(){window.map.hasLayer(window.airspaceGliding)&&(console.log("Map moved, refreshing airspaces"),h())}))}));let w=null;function y(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getCenter(),t=`https://xcmaps.com:2000/api/airspaces?lat=${e.lat.toFixed(6)}&lng=${e.lng.toFixed(6)}&dist=200000&types=${encodeURIComponent([8,9].join(","))}`;fetch(t).then((e=>e.json())).then((e=>{window.airspaceNotam.clearLayers();const t=[];e.items.forEach((e=>{if((0!==e.type||4!==e.icaoClass)&&e.geometry&&"Polygon"===e.geometry.type){const o=e.geometry.coordinates[0].map((e=>[e[1],e[0]])),n=0===e.lowerLimit.value?"red":"blue",i=(v[e.type],b[e.icaoClass],L.polygon(o,{color:n,weight:2,fillOpacity:.3}));t.push({polygon:i,data:e}),window.airspaceNotam.addLayer(i)}})),console.log(`Added ${t.length} airspaces to the map`),w&&window.map.off("click",w),w=function(e){if(!window.map.hasLayer(window.airspaceNotam))return;const o=e.latlng,n=[];if(t.forEach((e=>{let{polygon:t,data:i}=e;t.getBounds().contains(o)&&n.push(i)})),n.length>0){const e=n.map((e=>`\n            <b>${e.name}</b><br>\n            Type: ${v[e.type]||"Unknown"}<br>\n            ICAO Class: ${b[e.icaoClass]||"Unknown"}<br>\n            ↧${e.lowerLimit.value} ${x(e.lowerLimit.unit)}  ↥${e.upperLimit.value} ${x(e.upperLimit.unit)}<br>\n          `)).join("<hr>");L.popup().setLatLng(o).setContent(e).openOn(window.map)}},window.map.on("click",w)})).catch((e=>console.error("Error fetching airspaces:",e)))}const v={0:"Other",1:"Restricted",2:"Danger (D)",3:"Prohibited (Parc reserve)",4:"Controlled Tower Region (CTR)",5:"Transponder Mandatory Zone (TMZ)",6:"Radio Mandatory Zone (RMZ)",7:"Terminal Maneuvering Area (TMA)",8:"Temporary Reserved Area (TRA)",9:"Temporary Segregated Area (TSA)",10:"Flight Information Region (FIR)",11:"Upper Flight Information Region (UIR)",12:"Air Defense Identification Zone (ADIZ)",13:"Airport Traffic Zone (ATZ)",14:"Military Airport Traffic Zone (MATZ)",15:"Airway",16:"Military Training Route (MTR)",17:"Alert Area",18:"Warning Area",19:"Protected Area",20:"Helicopter Traffic Zone (HTZ)",21:"Gliding Sector",22:"Transponder Setting (TRP)",23:"Traffic Information Zone (TIZ)",24:"Traffic Information Area (TIA)",25:"Military Training Area (MTA)",26:"Control Area (CTA)",27:"ACC Sector (ACC)",28:"Aerial Sporting Or Recreational Activity",29:"Low Altitude Overflight Restriction",30:"Military Route (MRT)",31:"TSA/TRA Feeding Route (TFR)",32:"VFR Sector",33:"FIS Sector",34:"Lower Traffic Area (LTA)",35:"Upper Traffic Area (UTA)"},b={0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",8:"Special Use Airspace (SUA)"};function x(e){return{1:"ft",6:"FL"}[e]||"Unknown"}window.fetchAirspacesNotam=y,document.addEventListener("map_initialized",(function(){console.log("Setting up airspace layer events"),window.map.on("overlayadd",(function(e){"Airspaces"!==e.name&&"Gliding"!==e.name&&"Notam"!==e.name||(console.log(`Overlay added: ${e.name}, fetching airspaces`),y())})),window.map.on("moveend",(function(){window.map.hasLayer(window.airspaceNotam)&&(console.log("Map moved, refreshing airspaces"),y())}))}));var C=o(278),T=o(3807);let A,_=null,k=3e3,E=function(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}();function S(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getCenter(),t=(e.lat.toFixed(6),e.lng.toFixed(6),window.map.getBounds()),o=t.getNorthWest(),n=t.getSouthEast(),a=`/api/airspacesXCdb?startDate=${E}&nw_lat=${o.lat.toFixed(6)}&nw_lng=${o.lng.toFixed(6)}&se_lat=${n.lat.toFixed(6)}&se_lng=${n.lng.toFixed(6)}`;fetch(a).then((e=>e.json())).then((e=>{window.airspaceXC.clearLayers();const t=[];_&&(window.map.off("click",_),_=null);const o=e.features||[];let n=[],a=[];const r=Intl.DateTimeFormat().resolvedOptions().timeZone,s=i.tz(E,"YYYY-MM-DD",r).startOf("day").utc().toDate();o.forEach((e=>{if(e.geometry&&"Polygon"===e.geometry.type){if(e.properties.name&&e.properties.name.startsWith("V00"))return;const o=function(e){if(!e)return null;switch(e.type){case"FL":case"AMSL":case"AGL":return.3048*e.height;default:return null}}(e.properties.airlower_j);if(null===o||o>k)return void n.push({name:e.properties.name,limit:o});a.push({name:e.properties.name,limit:o});let r=!1;if(e.properties.descriptions&&Array.isArray(e.properties.descriptions))for(const t of e.properties.descriptions){const e=(t.airdescription||"").match(/C\)\s*(\d{10})/);if(e&&e[1]){const t=e[1];try{const e=2e3+parseInt(t.substring(0,2)),o=parseInt(t.substring(2,4))-1,n=parseInt(t.substring(4,6)),i=parseInt(t.substring(6,8)),a=parseInt(t.substring(8,10));if(new Date(Date.UTC(e,o,n,i,a))<s){r=!0;break}}catch(e){console.error("Error parsing expiration date:",e)}}}if(r)return;let l=!1;if(e.properties.activations&&Array.isArray(e.properties.activations)&&e.properties.activations.length>0){const t=Intl.DateTimeFormat().resolvedOptions().timeZone,o=i.tz(E,"YYYY-MM-DD",t).endOf("day").utc().toDate();for(const t of e.properties.activations){const e=new Date(t[0]),n=new Date(t[1]);if(e<=o&&n>=s){l=!0;break}}if(!l)return}if("R"===e.properties.airspaceClass){let t=!1;if(e.properties.descriptions&&Array.isArray(e.properties.descriptions))for(const o of e.properties.descriptions){if((o.airdescription||"").match(/C\)\s*(\d{10})/)){t=!0;break}}if(!t&&!l)return}const c=e.geometry.coordinates[0].map((e=>[e[1],e[0]])),p=L.polygon(c,{color:e.properties.strokeColor||"blue",weight:e.properties.strokeWeight||2,fillColor:e.properties.fillColor||"blue",fillOpacity:e.properties.fillOpacity||.3});p.bindPopup((()=>{const t=i.tz.guess(),o=`<div class="timezone-info" style="margin-top: 5px; font-size: 0.85em;">Local timezone: ${i.tz(t).zoneAbbr()} (UTC${i.tz(t).format("Z")})</div>`;let n="";if(e.properties.descriptions&&Array.isArray(e.properties.descriptions)&&e.properties.descriptions.length>0){const t=e=>e?e.replace(/([ABCDEFGQ]\))/g,"<br>$1"):"";n=`\n                  <div class="airspace-descriptions" style="font-size: 0.8em;">\n                      ${e.properties.descriptions.map((e=>`${t(e.airdescription||"")} ${e.airlanguage?`(${e.airlanguage})`:""}`)).join("")}\n                  </div>\n                `}let a="";e.properties.activations&&Array.isArray(e.properties.activations)&&e.properties.activations.length>0&&(a=`\n                  <div class="airspace-activations">\n                    <b>Activations:</b><br>\n                    ${e.properties.activations.map((e=>{const o=i.utc(e[0]).tz(t),n=i.utc(e[1]).tz(t);return`${o.format("MMM D, HH:mm z")} - ${n.format("MMM D, HH:mm z")}`})).join("<br>")}\n                  </div>\n                `);const r=(e,t)=>{if(!e)return t||"N/A";const o=e.type,n=e.height;if("FL"===o){return`${Math.round(.3048*n)}m (FL${n/100})`}if("AMSL"===o||"AGL"===o){return`${Math.round(.3048*n)}m`}return t||"N/A"},s=r(e.properties.airlower_j,e.properties.lowerLimit),l=r(e.properties.airupper_j,e.properties.upperLimit);return`\n              <b>${e.properties.name} (${e.properties.airspaceClass})</b><br>\n              <b>↧ </b>${s} - <b>↥ </b>${l}<br>\n              ${n}\n              ${a}\n              ${o}\n              `}),{className:"airspace-popup"}),t.push({polygon:p,data:e.properties,geometry:e.geometry}),window.airspaceXC.addLayer(p)}})),_=function(e){if(!window.map.hasLayer(window.airspaceXC))return;const o=e.latlng,n=[],a=C.zx([o.lng,o.lat]);if(t.forEach((e=>{let{polygon:t,data:o,geometry:i}=e;try{const e=C.n1(i.coordinates);T.m(a,e)&&n.push(o)}catch(e){console.error("Error checking point in polygon:",e)}})),n.length>0){const e=i.tz.guess(),t=(i.tz(e).zoneAbbr(),i.tz(e).format("Z"),n.map((t=>{let o="";if(t.descriptions&&Array.isArray(t.descriptions)&&t.descriptions.length>0){const e=e=>e?e.replace(/([ABCDEFGQ]\))/g,"<br>$1"):"";o=`\n                  <div class="airspace-descriptions" style="font-size: 0.8em;">\n                      ${t.descriptions.map((t=>`${e(t.airdescription||"")} ${t.airlanguage?`(${t.airlanguage})`:""}`)).join("")}\n                  </div>\n                `}let n="";t.descriptions&&Array.isArray(t.descriptions)&&t.descriptions.length,t.activations&&Array.isArray(t.activations)&&t.activations.length>0&&(n=`\n                  <div class="airspace-activations">\n                    <b>Activations:</b><br>\n                    ${t.activations.map((t=>{const o=i.utc(t[0]).tz(e),n=i.utc(t[1]).tz(e);return`${o.format("MMM D, HH:mm z")} - ${n.format("MMM D, HH:mm z")}`})).join("<br>")}\n                  </div>\n                `);const a=(e,t)=>{if(!e)return t||"N/A";const o=e.type,n=e.height;if("FL"===o){return`${Math.round(.3048*n)}m (FL${n/100})`}if("AMSL"===o||"AGL"===o){return`${Math.round(.3048*n)}m`}return t||"N/A"},r=a(t.airlower_j,t.lowerLimit),s=a(t.airupper_j,t.upperLimit);return`\n              <b>${t.name} (${t.airspaceClass})</b><br>\n              <b>↧ </b>${r} - <b>↥ </b>${s}<br>\n              </div>\n                ${o}\n                ${n}\n              </div>\n              `})).join("<hr style='margin: 3px 0;'>"));L.popup({className:"airspace-popup",closeOnClick:!1,autoClose:!1,tap:!1,closeButton:!0}).setLatLng(o).setContent(t).openOn(window.map)}},window.map.on("click",_)})).catch((e=>console.error("Error fetching airspaces:",e)))}document.addEventListener("change",(function(e){if(!e.target||"airspaceLowerLimit"!==e.target.id&&"airspaceTime"!==e.target.id||window.map&&window.map._popup&&window.map.closePopup(),e.target&&"airspaceLowerLimit"===e.target.id){const t=parseInt(e.target.value,10);console.log(`Dropdown changed: old limit=${k}m, new limit=${t}m`),t!==k&&(k=t,console.log(`Current limit updated to ${k}m`),clearTimeout(A),A=setTimeout((()=>{window.map.hasLayer(window.airspaceXC)&&(console.log(`Triggering XC airspaces reload with limit=${k}m`),S())}),300))}if(e.target&&"airspaceTime"===e.target.id){const t=e.target.value;console.log("Selected airspace date:",t),t!==E&&(E=t,clearTimeout(A),A=setTimeout((()=>{window.map.hasLayer(window.airspaceXC)&&(console.log("Refetching airspaces with new date:",E),S())}),300))}})),window.fetchAirspacesXC=S;function j(e){return["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"][Math.round(e/22.5)%16]}function M(e){return e>=7&&e<=14?"LimeGreen":e>=15&&e<=24?"yellow":e>=25&&e<=30?"orange":e>=31&&e<=36?"red":e>36?"black":"Aquamarine"}function D(e){return e>=15&&e<=24?"LimeGreen":e>=25&&e<=32?"yellow":e>=33&&e<=38?"orange":e>=39&&e<=44?"red":e>44?"black":"Aquamarine"}function I(e){return"black"===e?"white":"black"}window.showTab=function(e,t){console.log("Switching to tab:",e),document.querySelectorAll(".tab-content").forEach((e=>{e.style.display="none"})),document.querySelectorAll(".tab").forEach((e=>{e.classList.remove("active")}));const o=document.getElementById(e);if(o?o.style.display="block":console.error("Tab not found:",e),t?t.classList.add("active"):console.error("Element is null or undefined"),e.startsWith("chart-")){const t=e.split("chart-")[1];console.log("Station ID:",t);const o=document.getElementById(`canvas-${t}`);o&&o.chartInstance&&o.chartInstance.resize()}},window.fetchWindStations=function(){if(!window.map||"function"!=typeof window.map.getBounds)return void console.error("Map not properly initialized");const e=window.map.getBounds(),t=e.getNorthWest().lat,o=e.getNorthWest().lng,n=e.getSouthEast().lat,i=e.getSouthEast().lng;fetch(`/api/wind-data-getCurrent?nwLat=${t}&nwLng=${o}&seLat=${n}&seLng=${i}`).then((e=>e.json())).then((e=>{if(!Array.isArray(e))throw new Error("Invalid data format received from API");windLayer.clearLayers(),console.log("Wind layers cleared"),e.forEach((e=>{const[t,o]=e.loc.coordinates,n=e.last["w-dir"],i=e.last["w-avg"],a=e.last["w-max"],r=(e.last.temp,j(n)),s=new Date(1e3*e.last._id).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),l=M(i),c=D(a),p=e.peak?"▲":"▼",d=e._id.includes("holfuy");let m="";d&&(m=e._id.split("-")[1]);const h=`\n          <svg width="30" height="30" viewBox="0 0 800 900" xmlns="http://www.w3.org/2000/svg">\n            <g transform="rotate(${n+90}, 400, 400)" stroke="${c}" stroke-width="60">\n              <path d="M203,391 L75,144 L738,391 L75,637 L203,391 Z" fill="${l}"/>\n            </g>\n            <text x="330" y="850" font-size="220" text-anchor="middle" fill="black" font-weight="bold">\n              ${p}${Math.round(i)} / ${Math.round(a)}\n            </text>\n          </svg>`,u=L.divIcon({className:"wind-arrow",html:h,iconSize:[30,30],iconAnchor:[12,15]}),f=L.marker([o,t],{icon:u}).addTo(windLayer);fetch(`https://winds.mobi/api/2.3/stations/${e._id}/historic/?duration=21000&keys=w-dir&keys=w-avg&keys=w-max&keys=temp`).then((e=>e.json())).then((t=>{const o=function(e){const t={};e.forEach((e=>{const o=new Date(1e3*e._id);o.setMinutes(10*Math.floor(o.getMinutes()/10)),o.setSeconds(0),o.setMilliseconds(0);const n=o.getTime();t[n]||(t[n]={count:0,wAvgSum:0,wMaxSum:0,wDirSum:0,tempSum:0,tempCount:0}),t[n].count++,t[n].wAvgSum+=e["w-avg"],t[n].wMaxSum+=e["w-max"],t[n].wDirSum+=e["w-dir"],void 0!==e.temp&&(t[n].tempSum+=e.temp,t[n].tempCount++)}));const o=Object.keys(t).map((e=>({_id:parseInt(e)/1e3,"w-avg":t[e].wAvgSum/t[e].count,"w-max":t[e].wMaxSum/t[e].count,"w-dir":t[e].wDirSum/t[e].count,temp:t[e].tempCount>0?t[e].tempSum/t[e].tempCount:void 0})));return o.sort(((e,t)=>t._id-e._id)),o}(t),l=Date.now()-18e6,c=o.filter((e=>1e3*e._id>=l)).slice(0,24);let p='<div class="table-responsive"><table class="wind-data-table table">\n              <thead>\n                <tr>\n                  <th>Wind (m/s)</th>\n                  <th>Gusts (m/s)</th>\n                  <th>Direction</th>\n                  <th>Temp C°</th>\n                  <th>Time</th>\n                </tr>\n              </thead>\n              <tbody>';c.forEach((e=>{const t=new Date(1e3*e._id).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),o=j(e["w-dir"]);p+=`<tr>\n                <td class="wind-avg-cell" style="color: ${I(M(e["w-avg"]))}; background-color: ${M(e["w-avg"])};">\n                  ${e["w-avg"].toFixed(1)}\n                </td>\n                <td class="wind-max-cell" style="color: ${I(D(e["w-max"]))}; background-color: ${D(e["w-max"])};">\n                  ${e["w-max"].toFixed(1)}\n                </td>\n                <td>\n                  <span class="wind-direction-arrow" style="transform: rotate(${e["w-dir"]+180}deg);">\n                      <i class="fa fa-long-arrow-up"></i>\n                  </span>\n                  &nbsp;${o}\n                </td>\n                <td>${void 0!==e.temp?e.temp.toFixed(1):"N/A"}</td>\n                <td>${t}</td>\n              </tr>`})),p+="</tbody></table></div>";const h=o.slice().reverse(),u=`\n              <div style="display: flex; gap: 1px; align-items: flex-end; max-width: 700px">\n                <div style="flex: 1;" class="wind-station-popup-content">\n                  <strong>${e.short}</strong><br><br>\n                  <tag-name>Wind Speed:&#9;&#9;${i} km/h<br></tag-name>\n                  <tag-name>Max Wind:&#9;&#9;${a} km/h<br></tag-name>\n                  <tag-name>Wind Direction:&#9;${n}° (${r})<br></tag-name>\n                  <tag-name>Last Update:&#9;&#9;${s}<br><br></tag-name>\n                </div>\n                ${d?`\n                  <div style="flex: 0 0 auto; width: 110px; margin-right: 15px;">\n                    <iframe src="https://widget.holfuy.com/?station=${m}&su=km/h&t=C&lang=en&mode=rose&size=110"\n                      width="110"\n                      height="110"\n                      frameborder="0"\n                      scrolling="no">\n                    </iframe>\n                  </div>\n                `:""}\n              </div>\n              \n              <div class="tab-container">\n                <div class="tab active" onclick="showTab('table-${e._id}', this)">Table</div>\n                <div class="tab" onclick="showTab('chart-${e._id}', this)">Chart</div>\n                <div class="tab" id="camera-tab-${e._id}" style="display: none;" onclick="showTab('camera-${e._id}', this)">Camera</div>\n              </div>\n              <div id="table-${e._id}" class="tab-content">\n                ${p}\n              </div>\n              <div id="chart-${e._id}" class="tab-content" style="display: none;">\n                <canvas id="canvas-${e._id}" width="400" height="200"></canvas>\n              </div>\n              <div id="camera-${e._id}" class="tab-content" style="display: none;">\n                <img id="camera-image-${e._id}" src="" alt="Camera Image" class="camera-image">\n              </div>\n            `;f.bindPopup(L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:700,minWidth:400,maxHeight:800}).setContent(u)),f.on("popupopen",(()=>{setTimeout((()=>{const t=document.getElementById(`canvas-${e._id}`);if(t){t.style.height="300px";const e=t.getContext("2d");if(e){const o=h.map((e=>({x:1e3*e._id,y:e["w-avg"]}))),n=h.map((e=>({x:1e3*e._id,y:e["w-max"]}))),i=new Chart(e,{type:"line",data:{datasets:[{label:"Wind Avg (km/h)",data:o,borderColor:"blue",fill:!1,pointRadius:3},{label:"Wind Max (km/h)",data:n,borderColor:"red",fill:!1,pointRadius:3}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{bottom:5}},scales:{x:{type:"time",time:{unit:"hour",displayFormats:{hour:"HH:mm"},tooltipFormat:"HH:mm"},grid:{drawBorder:!0},ticks:{autoSkip:!0,maxRotation:0,minRotation:0,padding:30}},y:{beginAtZero:!0,ticks:{stepSize:10,maxTicksLimit:10,font:{size:14}}}},plugins:{legend:{display:!1}}},plugins:[{id:"windDirectionArrows",afterDraw:e=>{const t=e.ctx,o=e.scales.x;t.save();const n=o.top+20;t.textAlign="center",t.textBaseline="middle",h.forEach((e=>{const i=o.getPixelForValue(1e3*e._id);t.save(),t.translate(i,n),t.rotate((e["w-dir"]+180)*Math.PI/180),t.font="18px 'Roboto', sans-serif",t.fillText("↑",0,0),t.restore()})),t.restore()}}]});t.chartInstance=i}else console.error("Failed to get 2D context from canvas.")}else console.error("Canvas element not found.");const o=document.getElementById(`camera-tab-${e._id}`),n=document.getElementById(`camera-image-${e._id}`);if("holfuy-361"===e._id||"holfuy-363"===e._id){console.log(`Handling special case for ${e._id}`);const t=document.createElement("div");t.classList.add("holfuy-container");const i=document.createElement("div");if(i.textContent="Loading webcam image...",i.classList.add("loading-text"),t.appendChild(i),!n.parentNode)return console.error("Cannot find parent of image element for replacement"),void(o.style.display="none");n.parentNode.replaceChild(t,n),o.style.display="block",console.log("Successfully replaced image with container");const a=document.createElement("div");a.textContent="Loading webcam image...",a.classList.add("loading-text"),t.innerHTML="",t.appendChild(a);let r="https://www.moselfalken.de/zeltingen-rachtig";"holfuy-363"===e._id&&(r="https://www.moselfalken.de/meerfeld");const s=`/api/proxy?imageUrl=${r}`;console.log(`[${e._id}] Fetching website HTML from: ${s}`),fetch(s).then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.text()})).then((o=>{const n=(new DOMParser).parseFromString(o,"text/html").querySelectorAll("picture");if(0===n.length)throw new Error("No picture elements found in HTML");let i=null;for(const e of n){const t=e.querySelector("img");if(t&&(t.src.includes("cam")||t.alt&&t.alt.includes("Webcam"))){i=e;break}}i||(i=n[0]);const a=i.querySelectorAll("source"),r=i.querySelector("img");let s="";if(a.length>0){const e=a[a.length-1].getAttribute("srcset");e&&(s=e.split(" ")[0])}if(!s&&r&&(s=r.getAttribute("src")),!s)throw new Error("Could not extract image URL from HTML");s.startsWith("/")?s="https://www.moselfalken.de"+s:s.startsWith("http")||(s="https://www.moselfalken.de/"+s),console.log(`[${e._id}] Extracted image URL: ${s}`);const l=`/api/proxy?imageUrl=${s}`,c=document.createElement("img");c.alt="Moselfalken Webcam",c.classList.add("webcam-image"),console.log(`[${e._id}] Setting image src to proxy: ${l}`),c.src=l,t.innerHTML="",t.appendChild(c)})).catch((t=>{console.error(`[${e._id}] Error fetching/parsing website or extracting image URL:`,t),o.style.display="none"}))}else{const e=`https://holfuy.com/en/takeit/cam/s${m}.jpg`,t=new Image;t.onload=function(){n.src=e,o.style.display="block"},t.onerror=function(){o.style.display="none"},t.src=e,setTimeout((()=>{t.complete&&0!==t.naturalWidth||(o.style.display="none")}),2e3)}}),500)}))})).catch((e=>console.error("Error fetching historical wind data:",e)))}))})).catch((e=>console.error("Error fetching wind station data:",e)))};let P=null,z=null;function F(){"undefined"!=typeof swiperc&&(window.innerWidth<576?($(".swiper2").css("height",""),$(".swiper2").css("width","320px"),$(".swiper2").css("padding-left",""),$(".swiper2").css("padding-top","30px"),$(".swiper2 > .swiper-wrapper").css("width",""),$(".swiper2 > .swiper-wrapper").css("height","100px"),swiperc.changeDirection("horizontal",!0)):(window.innerWidth<840?($(".swiper2").css("width",""),$(".swiper2").css("height","320px")):($(".swiper2").css("width",""),$(".swiper2").css("height","460px")),$(".swiper2").css("padding-top",""),$(".swiper2").css("padding-left","30px"),$(".swiper2 > .swiper-wrapper").css("height",""),$(".swiper2 > .swiper-wrapper").css("width","100px"),swiperc.changeDirection("vertical",!0)))}function U(e){const t={N:0,NNE:22.5,NE:45,ENE:67.5,E:90,ESE:112.5,SE:135,SSE:157.5,S:180,SSW:202.5,SW:225,WSW:247.5,W:270,WNW:292.5,NW:315,NNW:337.5};let o=[];return e.split(",").map((e=>e.trim())).forEach((e=>{let n=e.split("-").map((e=>e.trim()));if(1===n.length){let e=t[n[0]];void 0!==e&&o.push([e-22.5,e+22.5])}else if(2===n.length){let e=t[n[0]],i=t[n[1]];void 0!==e&&void 0!==i&&(i<e&&([e,i]=[i,e]),i-e>180&&([e,i]=[i,e]),o.push([e,i]))}})),o}async function G(e,t){try{const o=await fetch(`/api/places/${t}`),n=await o.json();if(n.error)return void console.error("Error fetching place details:",n.error);let i=/<center><b><a href="http:\/\/www\.paraglidingearth\.com\/index\.php\?site=\d+">More information on ParaglidingEarth<\/a><\/b><\/center>\n?/g,a=/<br>\n<b>Take off : <\/b><br>\n?/g,r=/H \d+(-\d+)? m(?:, |<br>)/g,s=/HD \d+ m(?:<br>| \/)/g,l=/\nrating \d+\/\d+(?:\n|<br>)*/gi,c=(n.properties.description||"").replace(i,"").replace(a,"").replace(r,"").replace(s,"").replace(l,"").trim();window.currentPlaceName=n.properties.name,window.currentPlaceId=n.properties.id,window.currentStrPlacemarkId=n.properties.strPlacemarkId;let p=`<span style="color: #0087F7;"><h5>${n.properties.name}</h5></span>\n                            <table style="border-collapse: collapse; width: 70%;">\n                            <tr>\n                                <th style="text-align: left; vertical-align: top;">Type:</th>\n                                <td style="text-align: left; vertical-align: top;">${n.properties.type}</td>\n                            </tr>\n                            <tr>\n                                <th style="text-align: left; vertical-align: top;">Direction:</th>\n                                <td style="text-align: left; vertical-align: top;">${n.properties.direction}</td>\n                            </tr>\n                            <tr>\n                                <th style="text-align: left; vertical-align: top;">Rating:</th>\n                                <td style="text-align: left; vertical-align: top;">${null!=n.properties.rating?n.properties.rating+"/6":" -"}</td>\n                            </tr>\n                            <tr>\n                                <th style="text-align: left; vertical-align: top;">Height:</th>\n                                <td style="text-align: left; vertical-align: top;">${null!=n.properties.height?n.properties.height:" -"}</td>\n                            </tr>\n                            <tr>\n                                <th style="text-align: left; vertical-align: top;">Height difference:</th>\n                                <td style="text-align: left; vertical-align: top;">${null!=n.properties.heightdifference?n.properties.heightdifference:" -"}</td>\n                            </tr>\n                            <tr>\n                                <th style="text-align: left; vertical-align: top;">Last Update:</th>\n                                <td style="text-align: left; vertical-align: top;">${n.properties.lastupdate}</td>\n                            </tr>\n                            </table><br>\n                            <b>Description:</b> <div class="spot-description">${c}</div><br>\n                            <b>© <a href="https://paraglidingspots.com" target="_blank">paraglidingspots.com</a></b>\n                            <div class="modal-footer d-flex justify-content-between">\n                            <div id="feedback-message" class="text-start"></div> \x3c!-- Message on the left --\x3e\n                            <div class="d-flex ms-auto">\n                                <button class="btn btn-primary btn-sm me-2" onclick="showFeebackForm()">Feedback/Correction</button>\n                                <button class="btn btn-dark btn-sm close-popup">Close</button>\n                            </div>\n                            </div>\n                            `;p+="<style>\n        /* Limit the height of the Swiper container */\n        .swiper-container {\n            max-height: 460px !important;\n            height: 460px !important;\n            overflow: hidden !important;\n        }\n\n        /* Ensure individual Swipers don't expand beyond this height */\n        .swiper, .swiper1, .swiper2 {\n            max-height: 460px !important;\n            height: 460px !important;\n            overflow: hidden !important;\n        }\n\n        /* Limit Swiper wrapper height */\n        .swiper-wrapper {\n            max-height: 460px !important;\n        }\n\n        /* Ensure Swiper slides don't stretch */\n        .swiper-slide {\n            max-height: 460px !important;\n            display: flex !important;\n            align-items: center !important; /* Keep images centered */\n            justify-content: center !important;\n        }\n\n        /* Prevent images from exceeding the swiper height */\n        .swiper-slide img {\n            max-height: 100% !important;\n            width: auto !important;\n        }\n        \n        /* Keep the overall popup size unchanged */\n        .leaflet-popup-content {\n            max-height: 780px !important; /* Keep original popup height */\n            overflow-y: auto; /* Allow scrolling inside the popup if needed */\n        }\n\n        .swiper-clear {\n            clear: both;\n            margin-bottom: 1px;\n        }\n        </style>";const d=document.getElementById("fullScreenInfo"),m=document.getElementById("fullscreen-content-area");if(d&&d.classList.contains("visible")&&m){console.log("Updating fullscreen info content area for spot");const e=d.querySelector("#default-fullscreen-close-btn"),t=d.querySelector("#default-fullscreen-footer");e&&e.remove(),t&&t.remove(),m.innerHTML=p}e.setPopupContent(p),setTimeout((()=>{let e=document.querySelector(".swiper1 .swiper-slide img");if(e){!function(e){let t,o;var n=!(e<4),i=!(e<5);t=new Swiper(".swiper1",{autoHeight:!0,direction:"horizontal",allowTouchMove:!1,mousewheel:!1,slidesPerView:1,loop:!1}),o=new Swiper(".swiper2",{direction:"vertical",allowTouchMove:!0,mousewheel:!0,slidesPerView:3,spaceBetween:10,loop:n,breakpoints:{840:{slidesPerView:4,loop:i}},scrollbar:{el:".swiper-scrollbar",hide:!1,draggable:!0},on:{click:function(){let e=this.clickedSlide.firstChild.id.substring(3)-1;t.slideTo(e,1)},transitionEnd:function(){let e=this.realIndex;t.slideTo(e,1)}}}),F()}(parseInt(e.id.replace(/\D/g,""),10)||1)}}),300),setTimeout((()=>{const t=document.getElementById("fullScreenInfo");let o=null;if(t&&t.classList.contains("visible"))o=t.querySelector("#fullscreen-content-area .close-popup"),o?(o.replaceWith(o.cloneNode(!0)),o=t.querySelector("#fullscreen-content-area .close-popup"),o.addEventListener("click",(function(){console.log("Fullscreen close button clicked"),window.closeFullscreenInfo()}))):console.error("Close button not found in fullscreen view");else{const t=e.getPopup().getElement();t&&(o=t.querySelector(".close-popup"),o?(o.replaceWith(o.cloneNode(!0)),o=t.querySelector(".close-popup"),o.addEventListener("click",(function(){console.log("Standard popup close button clicked"),window.map&&window.map.closePopup()}))):console.error("Close button not found in standard popup"))}}),350)}catch(e){console.error("Error fetching place details:",e)}}function N(){z&&(z.remove(),z=null),P&&(P.destroy(),P=null);const e=document.getElementById("feedback-message");e&&(e.textContent="",e.classList.remove("text-success","text-danger"));const t=document.getElementById("fullScreenInfo"),o=t&&t.classList.contains("visible")?t.querySelector("#fullscreen-content-area"):document.querySelector(".leaflet-popup-content");if(!o)return void console.error("Could not find context element for feedback form.");let n=o.querySelector(".modal-footer");n&&(n.style.display="none");const i=`\n        <div id="feedbackFormHtml">\n            <div class="feedback-modal">\n                <span style="color: #0087F7;"><h5>Feedback for ${window.currentPlaceName}</h5></span>\n                <form id="feedbackForm">\n                    <div class="form-group">\n                        <label for="feedbackText">Feedback / Correction / Comment:</label>\n                        <textarea id="feedbackText" class="form-control" required style="height: 130px;"></textarea>\n                    </div>\n                    <div class="form-group">\n                        <label>Upload Images (optional):</label>\n                        <div id="dropzoneFeedback" class="dropzone mt-4 border-dashed rounded-2 min-h-0"></div>\n                    </div>\n                    <div class="form-group d-flex justify-content-between">\n                        <div style="width: 48%;">\n                            <label for="userName">Name:</label>\n                            <input type="text" id="userName" class="form-control" required>\n                        </div>\n                        <div style="width: 48%;">\n                            <label for="userEmail">E-Mail:</label>\n                            <input type="email" id="userEmail" class="form-control" required>\n                            <small class="text-danger d-none" id="emailError">Please enter a valid email address.</small>\n                        </div>\n                    </div>\n                    <button type="submit" class="btn btn-sm btn-success">Submit</button>\n                    <button type="button" class="btn btn-sm btn-secondary" onclick="cancelFeedback()">Cancel</button>\n                </form>\n            </div>\n        </div>\n    `;o?(o.insertAdjacentHTML("beforeend",i),z=o.querySelector("#feedbackFormHtml"),setTimeout((()=>{o&&o.scrollTo({top:o.scrollHeight,behavior:"smooth"})}),50),P=new Dropzone("#dropzoneFeedback",{url:"/upload",autoProcessQueue:!1,maxFiles:5,maxFilesize:100,acceptedFiles:"image/*",addRemoveLinks:!1,dictDefaultMessage:"Drag & drop files here or click to upload",clickable:!0,init:function(){const e=this;this.on("addedfile",(function(t){const o=t.previewElement,n=document.createElement("img");n.src="/assets/images/imgdelete.png",n.alt="Delete",n.classList.add("delete-icon"),o.querySelector(".dz-image").appendChild(n),n.addEventListener("click",(function(o){o.preventDefault(),o.stopPropagation(),e.removeFile(t)}))})),this.on("removedfile",(function(e){console.log("File removed:",e.name)}))}}),document.getElementById("userEmail").addEventListener("input",(function(){const e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value);document.getElementById("emailError").classList.toggle("d-none",e)})),document.getElementById("feedbackForm").addEventListener("submit",(async function(e){e.preventDefault();const t=new FormData;t.append("name",window.currentPlaceName),t.append("id",window.currentPlaceId),t.append("strPlacemarkId",window.currentStrPlacemarkId),t.append("feedbackText",document.getElementById("feedbackText").value),t.append("userName",document.getElementById("userName").value),t.append("userEmail",document.getElementById("userEmail").value),P.files.forEach((e=>{t.append("images",e)}));try{const e=await fetch("/api/send-feedback",{method:"POST",body:t}),n=await e.json();z&&(z.remove(),z=null),P&&(P.destroy(),P=null);const i=o?o.querySelector("#feedback-message"):document.getElementById("feedback-message"),a=o?o.querySelector(".modal-footer"):document.querySelector(".modal-footer");i?n.success?(i.textContent=n.message||"Feedback submitted successfully!",i.classList.remove("text-danger"),i.classList.add("text-success")):(i.textContent=n.error||"An error occurred.",i.classList.remove("text-success"),i.classList.add("text-danger")):console.error("Feedback message div not found in context."),a?a.style.display="flex":console.error("Modal footer not found in context.")}catch(e){console.error("Submission error:",e);const t=o?o.querySelector(".modal-footer"):document.querySelector(".modal-footer");t&&(t.style.display="flex")}}))):console.error("Popup content not found!")}function O(){z&&(z.remove(),z=null),P&&(P.destroy(),P=null);const e=document.getElementById("fullScreenInfo"),t=e&&e.classList.contains("visible")?e.querySelector("#fullscreen-content-area"):document.querySelector(".leaflet-popup-content");if(t){let e=t.querySelector(".modal-footer");e&&(e.style.display="flex")}else{let e=document.querySelector(".modal-footer");e&&(e.style.display="flex")}}function R(){if(!window.map||!window.placesLayerPG)return console.error("Map or placesLayerPG is not defined. Retrying in 500ms..."),void setTimeout(R,500);console.log("Initializing PG spots module..."),window.showFeebackForm=N,window.cancelFeedback=O;const e=L.markerClusterGroup({disableClusteringAtZoom:9,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,maxClusterRadius:250,iconCreateFunction:function(e){return L.divIcon({html:`<div class="cluster-marker">${e.getChildCount()}</div>`,className:"pg-cluster-icon",iconSize:L.point(30,30)})}});window.placesLayerPG.addLayer(e);let t=null,o=null;function n(){window.map.hasLayer(window.placesLayerPG)?(o&&clearTimeout(o),o=setTimeout((()=>{t&&t.abort(),t=new AbortController;const o=t.signal,n=window.map.getBounds(),i=n.getNorthWest().lat,a=n.getNorthWest().lng,r=n.getSouthEast().lat,s=n.getSouthEast().lng;fetch(`/api/places?nw_lat=${i}&nw_lng=${a}&se_lat=${r}&se_lng=${s}&type=TO&type=TOW&type=TH`,{signal:o}).then((e=>e.json())).then((n=>{o.aborted||(e.clearLayers(),L.geoJSON(n,{pointToLayer:function(e,t){return L.marker(t,{icon:L.canvasIcon({iconSize:[50,50],iconAnchor:[15,15],drawIcon:function(t,o){if("icon"===o){var n=t.getContext("2d"),i=L.point(this.options.iconSize),a=L.point(i.x/2,i.y/2);n.clearRect(0,0,i.x,i.y);let o=U(e.properties.direction||"");n.beginPath(),o.forEach((e=>{let[t,o]=e;n.moveTo(a.x,a.y),n.arc(a.x,a.y,a.x,(t-90)*Math.PI/180,(o-90)*Math.PI/180,!1),n.lineTo(a.x,a.y)})),n.fillStyle="orange",n.fill(),n.closePath(),n.beginPath(),n.arc(a.x,a.y,a.x/4,0,2*Math.PI),n.fillStyle="green",n.fill(),n.closePath()}}})})},onEachFeature:function(t,o){if(t.properties){let e=`<b>${t.properties.name}</b><br>\n                                                    Type: ${t.properties.type}<br>\n                                                    Direction: ${t.properties.direction}<br>\n                                                    <i>Loading details...</i>`,n=L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:900,maxHeight:780}).setContent(e);o.bindPopup(n),o.on("popupopen",(async function(){await G(o,t.properties.id)}))}e.addLayer(o)}}),t=null)})).catch((e=>{"AbortError"!==e.name&&console.error("Error fetching PG places:",e)}))}),300)):console.log("PG layer not visible, skipping fetch")}window.fetchPlacesPG=n,window.map.hasLayer(window.placesLayerPG)&&n(),console.log("PG spots module initialized")}function Z(){if(!window.map||!window.placesLayerHG)return console.error("Map or placesLayerHG is not defined. Retrying in 500ms..."),void setTimeout(Z,500);console.log("Initializing HG spots module..."),window.showFeebackForm=N,window.cancelFeedback=O;const e=L.markerClusterGroup({disableClusteringAtZoom:9,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,maxClusterRadius:250,iconCreateFunction:function(e){return L.divIcon({html:`<div class="cluster-marker">${e.getChildCount()}</div>`,className:"hg-cluster-icon",iconSize:L.point(30,30)})}});window.placesLayerHG.addLayer(e);let t=null,o=null;function n(){o&&clearTimeout(o),o=setTimeout((()=>{t&&t.abort(),t=new AbortController;const o=t.signal,n=window.map.getBounds(),i=n.getNorthWest().lat,a=n.getNorthWest().lng,r=n.getSouthEast().lat,s=n.getSouthEast().lng;fetch(`/api/places?nw_lat=${i}&nw_lng=${a}&se_lat=${r}&se_lng=${s}&type=TO-HG&type=TOW-HG`,{signal:o}).then((e=>e.json())).then((n=>{o.aborted||(e.clearLayers(),L.geoJSON(n,{pointToLayer:function(e,t){return L.marker(t,{icon:L.canvasIcon({iconSize:[50,50],iconAnchor:[15,15],drawIcon:function(t,o){if("icon"===o){var n=t.getContext("2d"),i=L.point(this.options.iconSize),a=L.point(i.x/2,i.y/2);n.clearRect(0,0,i.x,i.y);let o=U(e.properties.direction||"");n.beginPath(),o.forEach((e=>{let[t,o]=e;n.moveTo(a.x,a.y),n.arc(a.x,a.y,a.x,(t-90)*Math.PI/180,(o-90)*Math.PI/180,!1),n.lineTo(a.x,a.y)})),n.fillStyle="orange",n.fill(),n.closePath(),n.beginPath(),n.arc(a.x,a.y,a.x/4,0,2*Math.PI),n.fillStyle="green",n.fill(),n.closePath()}}})})},onEachFeature:function(t,o){if(t.properties){let e=`<b>${t.properties.name}</b><br>\n                                                    Type: ${t.properties.type}<br>\n                                                    Direction: ${t.properties.direction}<br>\n                                                    <i>Loading details...</i>`,n=L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:900,maxHeight:780}).setContent(e);o.bindPopup(n),o.on("popupopen",(async function(){await G(o,t.properties.id)}))}e.addLayer(o)}}),t=null)})).catch((e=>{"AbortError"!==e.name&&console.error("Error fetching HG places:",e)}))}),300)}window.fetchPlacesHG=n,window.map.hasLayer(window.placesLayerHG)&&n(),console.log("PG spots module initialized")}function H(){if(!window.map||!window.placesLayerLZ)return void setTimeout(H,500);console.log("Initializing LZ spots module...");const e=L.markerClusterGroup({disableClusteringAtZoom:9,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,maxClusterRadius:250,iconCreateFunction:function(e){return L.divIcon({html:`<div class="cluster-marker">${e.getChildCount()}</div>`,className:"lz-cluster-icon",iconSize:L.point(30,30)})}});window.placesLayerLZ.addLayer(e);let t=null,o=null;function n(){o&&clearTimeout(o),o=setTimeout((()=>{t&&t.abort(),t=new AbortController;const o=t.signal,n=window.map.getBounds(),i=n.getNorthWest().lat,a=n.getNorthWest().lng,r=n.getSouthEast().lat,s=n.getSouthEast().lng;fetch(`/api/places?nw_lat=${i}&nw_lng=${a}&se_lat=${r}&se_lng=${s}&type=LZ`,{signal:o}).then((e=>e.json())).then((n=>{o.aborted||(e.clearLayers(),L.geoJSON(n,{pointToLayer:function(e,t){return L.marker(t,{icon:L.icon({iconUrl:"../assets/images/windsock.png",iconSize:[20,20],iconAnchor:[20,20]})})},onEachFeature:function(t,o){if(t.properties){let e=`<b>${t.properties.name}</b><br>\n                                                    Type: ${t.properties.type}<br>\n                                                    Direction: ${t.properties.direction}<br>\n                                                    <i>Loading details...</i>`,n=L.responsivePopup({hasTip:!0,autoPan:!1,offset:[15,25],maxWidth:900,maxHeight:780}).setContent(e);o.bindPopup(n),o.on("popupopen",(async function(){await G(o,t.properties.id)}))}e.addLayer(o)}}),t=null)})).catch((e=>{"AbortError"!==e.name&&console.error("Error fetching LZ places:",e)}))}),300)}window.fetchPlacesLZ=n,window.map.hasLayer(window.placesLayerLZ)&&n(),console.log("PG spots module initialized")}document.addEventListener("map_initialized",(function(){console.log("Map initialized event received in PG spots module"),setTimeout(R,100)})),setTimeout((()=>{window.mapInitialized&&(console.log("Backup initialization for PG spots module"),R())}),1e3),document.addEventListener("map_initialized",(function(){console.log("Map initialized event received in HG spots module"),setTimeout(Z,100)})),setTimeout((()=>{window.mapInitialized&&(console.log("Backup initialization for HG spots module"),Z())}),1e3),document.addEventListener("map_initialized",(function(){console.log("Map initialized event received in LZ spots module"),setTimeout(H,100)})),setTimeout((()=>{window.mapInitialized&&(console.log("Backup initialization for LZ spots module"),H())}),1e3);let W=null,B=L.layerGroup({attribution:'XContest&copy; <a href="https://xcontest.org">XContest</a>'});window.obstacleLayer=B,window.fetchObstacles=function(){if(!window.map)return void console.error("Map not initialized yet");const e=window.map.getBounds(),t=e.getNorthWest(),o=e.getSouthEast(),n=`/api/obstacles?nw_lat=${t.lat}&nw_lng=${t.lng}&se_lat=${o.lat}&se_lng=${o.lng}`;B.clearLayers(),fetch(n).then((e=>e.json())).then((e=>{const t=[];e.features.forEach((e=>{if("LineString"===e.geometry.type){const o=e.geometry.coordinates.map((e=>[e[1],e[0]])),n=L.polyline(o,{color:e.properties.strokeColor||"#ff0000",weight:e.properties.strokeWeight||2});t.push({polyline:n,data:e.properties}),n.addTo(B),n.bindPopup((()=>{const t=[];return e.properties.name&&t.push(`<b>${e.properties.name}</b>`),e.properties.type&&t.push(`Type: ${e.properties.type}`),e.properties.description&&t.push(`Description: ${e.properties.description}`),e.properties.maxAgl&&t.push(`Max AG: ${e.properties.maxAgl}m`),t.join("<br>")}),{className:"obstacle-popup"})}})),console.log(`Added ${t.length} obstacles to the map`),W&&window.map.off("click",W),W=function(e){if(!window.map.hasLayer(B))return;const o=e.latlng,n=[];if(t.forEach((e=>{let{polyline:t,data:i}=e;t.getBounds().contains(o)&&n.push(i)})),n.length>0){const e=n.map((e=>`\n            ${e.name?`<b>${e.name}</b><br>`:""}\n            ${e.type?`Type: ${e.type}<br>`:""}\n            ${e.description?`Description: ${e.description}<br>`:""}\n            ${e.maxAgl?`Max AG: ${e.maxAgl}m<br>`:""}\n          `)).join("<hr>");L.popup({className:"obstacle-popup"}).setLatLng(o).setContent(e).openOn(window.map)}},window.map.on("click",W)})).catch((e=>console.error("Error fetching obstacles:",e)))},document.addEventListener("DOMContentLoaded",(function(){console.log("DOM content loaded, initializing map");const e=function(){window.map=L.map("map",{center:[50,6],zoom:9,zoomControl:!1,layers:[]}),L.control.zoom({position:"bottomright"}).addTo(window.map);var e=L.tileLayer("https://tile.jawg.io/jawg-terrain/{z}/{x}/{y}{r}.png?access-token=qBDXRu1KSlZGhx4ROlceBD9hcxmrumL34oj29tUkzDVkafqx08tFWPeRNb0KSoKa",{attribution:"Jawg.io terrain"}).addTo(window.map),t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}),o=L.tileLayer("https://topo.xcontest.app/elev/{z}/{x}/{y}.jpg",{attribution:'XContest&copy; <a href="https://www.xcontest.org">XContest</a>',className:"xcontest-layer"});window.map.on("popupopen",(function(e){var t=document.getElementById("fullScreenInfo");if(window.innerWidth<768){const n=e.popup.getElement();if(n&&(n.classList.contains("obstacle-popup")||n.classList.contains("airspace-popup")))return;window.map.closePopup();try{var o=e.popup.getContent();t.innerHTML=`<div id="default-fullscreen-close-btn" style="position: absolute; top: 10px; right: 10px;"><button onclick="closeFullscreenInfo()" style="background: none; border: none; font-size: 20px; cursor: pointer;">✕</button></div><div id="fullscreen-content-area">${o}</div><div id="default-fullscreen-footer" style="text-align: right; padding: 10px;"><button class="btn btn-dark btn-sm" onclick="closeFullscreenInfo()">Close</button></div>`,t.classList.add("visible"),t.style.display="block",t.style.zIndex="10000",document.getElementById("map").classList.add("map-covered")}catch(e){console.error("Error in popupopen handler:",e)}}})),window.closeFullscreenInfo=function(){var e=document.getElementById("fullScreenInfo");e.classList.remove("visible"),e.innerHTML="",document.getElementById("map").classList.remove("map-covered"),window.map.closePopup()};var a=L.mapboxGL({style:"/assets/maps/maptiler_terrain_wob_testxc.json",apiKey:"c49iG8J3xvAkgCSZ8M8v",className:"xcmap-layer",attribution:"MapTiler Terrain"}),r=L.tileLayer("http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",{attribution:"Map data: Google",maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]});L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"© Esri",id:"MapID"}),L.mapboxGL({style:"/assets/maps/maptiler_terrain_wob_testxc.json",apiKey:"c49iG8J3xvAkgCSZ8M8v",className:"xcmap-layer satellite-overlay",attribution:"MapTiler Terrain"}),L.tileLayer("https://api.maptiler.com/tiles/contours/{z}/{x}/{y}.pbf?key=c49iG8J3xvAkgCSZ8M8v",{attribution:"MapTiler",opacity:.8,className:"contour-overlay",style:{color:"#ffffff",weight:1,opacity:.8}}),window.windLayer=L.layerGroup().addTo(window.map),window.oaipMap=L.tileLayer("https://a.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey=171189a4d43c6578ce63758f28363cb3",{attribution:'OpenAIP&copy; <a href="https://www.openaip.net">OpenAIP</a>',className:"oaip-layer"}),window.airspaceEFG=L.layerGroup([],{attribution:'OpenAIP&copy; <a href="https://www.openaip.net">OpenAIP</a>'}),window.airspaceGliding=L.layerGroup([],{attribution:'OpenAIP&copy; <a href="https://www.openaip.net">OpenAIP</a>'}),window.airspaceNotam=L.layerGroup([],{attribution:'OpenAIP&copy; <a href="https://www.openaip.net">OpenAIP</a>'}),window.airspaceXC=L.layerGroup([],{attribution:'XContest&copy; <a href="https://xcontest.org">XContest</a>'}),window.placesLayerPG=L.layerGroup([],{attribution:'&copy; <a href="https://paraglidingspots.com">paraglidingspots.com</a>'}),window.placesLayerHG=L.layerGroup([],{attribution:'&copy; <a href="https://paraglidingspots.com">paraglidingspots.com</a>'}),window.placesLayerLZ=L.layerGroup([],{attribution:'&copy; <a href="https://paraglidingspots.com">paraglidingspots.com</a>'});const s=(()=>{let e="";for(let t=0;t<=6;t++){const o=i().add(t,"days"),n=o.format("ddd");e+=`<option value="${o.format("YYYY-MM-DD")}" ${0===t?"selected":""}>${0===t?"Today":n}</option>`}return e})();var l={label:"Base Maps",children:[{label:"Terrain",layer:e},{label:"XContest",layer:L.layerGroup([o,a])},{label:"OpenStreetMap",layer:t},{label:"Satellite",layer:r}]},c={label:"Overlays",children:[{label:"Weather Stations",children:[{label:"Weather Stations",layer:window.windLayer,checked:!0}]},{label:"Spots",children:[{label:"Take-off PG",layer:window.placesLayerPG},{label:"Take-off HG",layer:window.placesLayerHG},{label:"Landing Zones",layer:window.placesLayerLZ}]},{label:"Airspaces",children:[{html:`\n                            <div class="airspace-time-control">\n                                Active:\n                                <select class="airspace-time-select" id="airspaceTime">\n                                    ${s}\n                                </select>\n                                          </div>\n                                      `},{html:'\n                          <div class="airspace-limit-control">\n                              ↧ below:\n                              <select class="lower-limit-select" id="airspaceLowerLimit">\n                                  <option value="2000">2000m</option>\n                                  <option value="2500">2500m</option>\n                                  <option value="3000" selected>3000m</option>\n                                  <option value="3500">3500m</option>\n                                  <option value="4000">4000m</option>\n                                  <option value="4500">4500m</option>\n                              </select>\n                          </div>\n                      '},{label:"Airspaces",layer:window.airspaceXC},{label:"Obstacles",layer:window.obstacleLayer},{label:"OpenAIP Map",layer:window.oaipMap}]}]};new n({position:"bottomright"}).addTo(window.map),L.Control.Logo=L.Control.extend({onAdd:function(e){const t=L.DomUtil.create("div","leaflet-control-logo"),o=L.DomUtil.create("img","logo-image",t);return o.src="/assets/images/XCmapsLogo.png",o.alt="XCmaps Logo",o.style.width="120px",o.style.height="auto",L.DomEvent.disableClickPropagation(t),t}}),L.control.logo=function(e){return new L.Control.Logo(e)},L.control.logo({position:"topleft"}).addTo(window.map),L.control.locate({drawCircle:!1,keepCurrentZoomLevel:!0,position:"bottomright",icon:"locate",iconLoading:"loading",iconElementTag:"div"}).addTo(window.map);var p=L.control.layers.tree(l,c,{namedToggle:!1,collapsed:!0}).addTo(window.map);p.collapseTree().expandSelected();const d=p.getContainer(),m=d.querySelector(".leaflet-control-layers-toggle");("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&(L.DomEvent.on(m,"click",(function(e){L.DomEvent.stopPropagation(e),L.DomUtil.hasClass(d,"leaflet-control-layers-expanded")?L.DomUtil.removeClass(d,"leaflet-control-layers-expanded"):L.DomUtil.addClass(d,"leaflet-control-layers-expanded")})),L.DomEvent.on(document,"click",(function(){L.DomUtil.hasClass(d,"leaflet-control-layers-expanded")&&L.DomUtil.removeClass(d,"leaflet-control-layers-expanded")})),L.DomEvent.on(d,"click",(function(e){L.DomEvent.stopPropagation(e)}))),window.map.on("moveend",(function(){console.log("Map moveend event triggered"),window.map.hasLayer(window.windLayer)&&"function"==typeof window.fetchWindStations&&(console.log("Fetching wind stations after map move..."),window.fetchWindStations()),window.map.hasLayer(window.placesLayerPG)&&window.fetchPlacesPG&&(console.log("Fetching PG spots after map move..."),window.fetchPlacesPG()),window.map.hasLayer(window.placesLayerHG)&&window.fetchPlacesHG&&(console.log("Fetching HG spots after map move..."),window.fetchPlacesHG()),window.map.hasLayer(window.placesLayerLZ)&&window.fetchPlacesLZ&&(console.log("Fetching LZ spots after map move..."),window.fetchPlacesLZ()),window.map.hasLayer(window.airspaceEFG)&&"function"==typeof window.fetchAirspaces&&(console.log("Fetching airspaces after map move..."),window.fetchAirspaces()),window.map.hasLayer(window.airspaceGliding)&&"function"==typeof window.fetchAirspacesGliding&&(console.log("Fetching airspaces after map move..."),window.fetchAirspacesGliding()),window.map.hasLayer(window.airspaceNotam)&&"function"==typeof window.fetchAirspacesNotam&&(console.log("Fetching airspaces after map move..."),window.fetchAirspacesNotam()),window.map.hasLayer(window.airspaceXC)&&"function"==typeof window.fetchAirspacesXC&&(console.log("Fetching airspaces after map move..."),window.fetchAirspacesXC()),window.map.hasLayer(window.obstacleLayer)&&"function"==typeof window.fetchObstacles&&(console.log("Fetching airspaces after map move..."),window.fetchObstacles())})),document.addEventListener("change",(function(e){e.target&&"airspaceLowerLimit"===e.target.id&&console.log("Selected limit:",e.target.value),e.target&&"airspaceTime"===e.target.id&&console.log("Selected airspace date:",e.target.value)})),window.map.on("layeradd",(function(e){const t=e.layer;t===window.windLayer&&"function"==typeof window.fetchWindStations?window.fetchWindStations():t===window.placesLayerPG&&window.fetchPlacesPG?window.fetchPlacesPG():t===window.placesLayerHG&&window.fetchPlacesHG?window.fetchPlacesHG():t===window.placesLayerLZ&&window.fetchPlacesLZ?window.fetchPlacesLZ():t===window.airspaceEFG&&"function"==typeof window.fetchAirspaces?window.fetchAirspaces():t===window.airspaceGliding&&"function"==typeof window.fetchAirspacesGliding?window.fetchAirspacesGliding():t===window.airspaceNotam&&"function"==typeof window.fetchAirspacesNotam?window.fetchAirspacesNotam():t===window.airspaceXC&&"function"==typeof window.fetchAirspacesXC?window.fetchAirspacesXC():t===window.obstacleLayer&&"function"==typeof window.fetchObstacles&&window.fetchObstacles()})),window.mapInitialized=!0,console.log("Map initialization complete");const h=new Event("map_initialized");return document.dispatchEvent(h),console.log("Map initialized event dispatched"),window.map}();navigator.geolocation.getCurrentPosition((t=>{console.log("Geolocation received");const o=t.coords.latitude,n=t.coords.longitude;e.setView([o,n],10);const i=new CustomEvent("user_location_ready",{detail:{lat:o,lng:n}});document.dispatchEvent(i),console.log("User location event dispatched")}))})),document.addEventListener("user_location_ready",(function(e){console.log("Handling user location ready event"),setTimeout((()=>{if("function"==typeof window.fetchWindStations&&window.mapInitialized&&window.map.hasLayer(window.windLayer))try{console.log("Fetching wind stations"),window.fetchWindStations(e.detail.lat,e.detail.lng)}catch(e){console.error("Error fetching wind stations:",e)}if("function"==typeof window.fetchAirspaces&&window.mapInitialized&&window.map.hasLayer(window.airspaceEFG))try{console.log("Fetching airspaces"),window.fetchAirspaces()}catch(e){console.error("Error fetching airspaces:",e)}if("function"==typeof window.fetchAirspacesGliding&&window.mapInitialized&&window.map.hasLayer(window.airspaceGliding))try{console.log("Fetching airspaces"),window.fetchAirspacesGliding()}catch(e){console.error("Error fetching airspaces:",e)}if("function"==typeof window.fetchAirspacesNotam&&window.mapInitialized&&window.map.hasLayer(window.airspaceNotam))try{console.log("Fetching airspaces"),window.fetchAirspacesNotam()}catch(e){console.error("Error fetching airspaces:",e)}if("function"==typeof window.fetchAirspacesXC&&window.mapInitialized&&window.map.hasLayer(window.airspaceXC))try{console.log("Fetching airspaces"),window.fetchAirspacesXC()}catch(e){console.error("Error fetching airspaces:",e)}if("function"==typeof window.fetchObstacles&&window.mapInitialized&&window.map.hasLayer(window.obstacleLayer))try{console.log("Fetching obstacles"),window.fetchObstacles()}catch(e){console.error("Error fetching obstacles:",e)}}),500)}))},5358:(e,t,o)=>{var n={"./af":5177,"./af.js":5177,"./ar":1509,"./ar-dz":1488,"./ar-dz.js":1488,"./ar-kw":8676,"./ar-kw.js":8676,"./ar-ly":2353,"./ar-ly.js":2353,"./ar-ma":4496,"./ar-ma.js":4496,"./ar-ps":6947,"./ar-ps.js":6947,"./ar-sa":2682,"./ar-sa.js":2682,"./ar-tn":9756,"./ar-tn.js":9756,"./ar.js":1509,"./az":5533,"./az.js":5533,"./be":8959,"./be.js":8959,"./bg":7777,"./bg.js":7777,"./bm":4903,"./bm.js":4903,"./bn":1290,"./bn-bd":7357,"./bn-bd.js":7357,"./bn.js":1290,"./bo":1545,"./bo.js":1545,"./br":1470,"./br.js":1470,"./bs":4429,"./bs.js":4429,"./ca":7306,"./ca.js":7306,"./cs":6464,"./cs.js":6464,"./cv":3635,"./cv.js":3635,"./cy":4226,"./cy.js":4226,"./da":3601,"./da.js":3601,"./de":7853,"./de-at":6111,"./de-at.js":6111,"./de-ch":4697,"./de-ch.js":4697,"./de.js":7853,"./dv":708,"./dv.js":708,"./el":4691,"./el.js":4691,"./en-au":3872,"./en-au.js":3872,"./en-ca":8298,"./en-ca.js":8298,"./en-gb":6195,"./en-gb.js":6195,"./en-ie":6584,"./en-ie.js":6584,"./en-il":5543,"./en-il.js":5543,"./en-in":9033,"./en-in.js":9033,"./en-nz":9402,"./en-nz.js":9402,"./en-sg":3004,"./en-sg.js":3004,"./eo":2934,"./eo.js":2934,"./es":7650,"./es-do":838,"./es-do.js":838,"./es-mx":7730,"./es-mx.js":7730,"./es-us":6575,"./es-us.js":6575,"./es.js":7650,"./et":3035,"./et.js":3035,"./eu":3508,"./eu.js":3508,"./fa":119,"./fa.js":119,"./fi":527,"./fi.js":527,"./fil":5995,"./fil.js":5995,"./fo":2477,"./fo.js":2477,"./fr":5498,"./fr-ca":6435,"./fr-ca.js":6435,"./fr-ch":7892,"./fr-ch.js":7892,"./fr.js":5498,"./fy":7071,"./fy.js":7071,"./ga":1734,"./ga.js":1734,"./gd":217,"./gd.js":217,"./gl":7329,"./gl.js":7329,"./gom-deva":2124,"./gom-deva.js":2124,"./gom-latn":3383,"./gom-latn.js":3383,"./gu":5050,"./gu.js":5050,"./he":1713,"./he.js":1713,"./hi":3861,"./hi.js":3861,"./hr":6308,"./hr.js":6308,"./hu":609,"./hu.js":609,"./hy-am":7160,"./hy-am.js":7160,"./id":4063,"./id.js":4063,"./is":9374,"./is.js":9374,"./it":8383,"./it-ch":1827,"./it-ch.js":1827,"./it.js":8383,"./ja":3827,"./ja.js":3827,"./jv":9722,"./jv.js":9722,"./ka":1794,"./ka.js":1794,"./kk":7088,"./kk.js":7088,"./km":6870,"./km.js":6870,"./kn":4451,"./kn.js":4451,"./ko":3164,"./ko.js":3164,"./ku":8174,"./ku-kmr":6181,"./ku-kmr.js":6181,"./ku.js":8174,"./ky":8474,"./ky.js":8474,"./lb":9680,"./lb.js":9680,"./lo":5867,"./lo.js":5867,"./lt":5766,"./lt.js":5766,"./lv":9532,"./lv.js":9532,"./me":8076,"./me.js":8076,"./mi":1848,"./mi.js":1848,"./mk":306,"./mk.js":306,"./ml":3739,"./ml.js":3739,"./mn":9053,"./mn.js":9053,"./mr":6169,"./mr.js":6169,"./ms":3386,"./ms-my":2297,"./ms-my.js":2297,"./ms.js":3386,"./mt":7075,"./mt.js":7075,"./my":2264,"./my.js":2264,"./nb":2274,"./nb.js":2274,"./ne":8235,"./ne.js":8235,"./nl":2572,"./nl-be":3784,"./nl-be.js":3784,"./nl.js":2572,"./nn":4566,"./nn.js":4566,"./oc-lnc":9330,"./oc-lnc.js":9330,"./pa-in":9849,"./pa-in.js":9849,"./pl":4418,"./pl.js":4418,"./pt":9834,"./pt-br":8303,"./pt-br.js":8303,"./pt.js":9834,"./ro":4457,"./ro.js":4457,"./ru":2271,"./ru.js":2271,"./sd":1221,"./sd.js":1221,"./se":3478,"./se.js":3478,"./si":7538,"./si.js":7538,"./sk":5784,"./sk.js":5784,"./sl":6637,"./sl.js":6637,"./sq":6794,"./sq.js":6794,"./sr":5719,"./sr-cyrl":3322,"./sr-cyrl.js":3322,"./sr.js":5719,"./ss":6e3,"./ss.js":6e3,"./sv":1011,"./sv.js":1011,"./sw":748,"./sw.js":748,"./ta":1025,"./ta.js":1025,"./te":1885,"./te.js":1885,"./tet":8861,"./tet.js":8861,"./tg":6571,"./tg.js":6571,"./th":5802,"./th.js":5802,"./tk":9527,"./tk.js":9527,"./tl-ph":9231,"./tl-ph.js":9231,"./tlh":1052,"./tlh.js":1052,"./tr":5096,"./tr.js":5096,"./tzl":9846,"./tzl.js":9846,"./tzm":1765,"./tzm-latn":7711,"./tzm-latn.js":7711,"./tzm.js":1765,"./ug-cn":8414,"./ug-cn.js":8414,"./uk":6618,"./uk.js":6618,"./ur":158,"./ur.js":158,"./uz":7609,"./uz-latn":2475,"./uz-latn.js":2475,"./uz.js":7609,"./vi":1135,"./vi.js":1135,"./x-pseudo":4051,"./x-pseudo.js":4051,"./yo":2218,"./yo.js":2218,"./zh-cn":2648,"./zh-cn.js":2648,"./zh-hk":1632,"./zh-hk.js":1632,"./zh-mo":1541,"./zh-mo.js":1541,"./zh-tw":304,"./zh-tw.js":304};function i(e){var t=a(e);return o(t)}function a(e){if(!o.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}i.keys=function(){return Object.keys(n)},i.resolve=a,e.exports=i,i.id=5358}},o={};function n(e){var i=o[e];if(void 0!==i)return i.exports;var a=o[e]={id:e,loaded:!1,exports:{}};return t[e].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}n.m=t,e=[],n.O=(t,o,i,a)=>{if(!o){var r=1/0;for(p=0;p<e.length;p++){for(var[o,i,a]=e[p],s=!0,l=0;l<o.length;l++)(!1&a||r>=a)&&Object.keys(n.O).every((e=>n.O[e](o[l])))?o.splice(l--,1):(s=!1,a<r&&(r=a));if(s){e.splice(p--,1);var c=i();void 0!==c&&(t=c)}}return t}a=a||0;for(var p=e.length;p>0&&e[p-1][2]>a;p--)e[p]=e[p-1];e[p]=[o,i,a]},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={792:0};n.O.j=t=>0===e[t];var t=(t,o)=>{var i,a,[r,s,l]=o,c=0;if(r.some((t=>0!==e[t]))){for(i in s)n.o(s,i)&&(n.m[i]=s[i]);if(l)var p=l(n)}for(t&&t(o);c<r.length;c++)a=r[c],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(p)},o=self.webpackChunkXCmaps=self.webpackChunkXCmaps||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))})();var i=n.O(void 0,[96],(()=>n(625)));i=n.O(i)})();
//# sourceMappingURL=main.0e55beca9c073ef225de.js.map