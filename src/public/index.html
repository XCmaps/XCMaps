<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XCmaps - Open Data for Gliders</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="./assets/js/L.Control.Layers.Tree.css" />
    <script src="./assets/js/L.Control.Layers.Tree.js"></script>
    <style>
        html, body { height: 100%; margin: 0; }
        #map { width: 100%; height: 100%; }
    </style>
    <style>
        .leaflet-popup-content {
            min-width: 500px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>

    <!-- Mapbox GL -->
    // <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.css" rel='stylesheet' />
    // <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.js"></script>

    <script src="https://unpkg.com/maplibre-gl@^5.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@^5.1.0/dist/maplibre-gl.css" rel="stylesheet" />

    <script src="https://unpkg.com/leaflet-responsive-popup@1.0.0/leaflet.responsive.popup.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-responsive-popup@1.0.0/leaflet.responsive.popup.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://sashakavun.github.io/leaflet-canvasicon/leaflet-canvasicon.js"></script>

        <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <link rel="stylesheet" href="https://paraglidingspots.com/online/css/libs/nouislider.css">
    <link rel="stylesheet" type="text/css" media="screen" href="https://paraglidingspots.com/online/css/pgs.css">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- Dropzone -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/min/dropzone.min.css" rel="stylesheet" type="text/css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/min/dropzone.min.js"></script>

    <style>
            /* Prevent default browser behavior for drag-and-drop */
        .leaflet-popup-content {
            pointer-events: auto !important;
        }

        .leaflet-layerstree-header-label {
            margin-bottom: 0px;
        }

        .leaflet-control-layers-selector {
            margin-right: 4px;
        }

        .leaflet-layerstree-header-pointer {
            font-weight: bold;
        }

        /* Dropzone styling fixes */
        #feedbackDropzone {
            border: 2px dashed #0087F7;
            padding: 20px;
            margin: 10px 0;
            min-height: 100px;
        }

        .dz-message {
            text-align: center;
            margin: 2em 0;
        }

        .dz-progress {
        /* progress bar covers file name */
        display: none !important;
        }

        .dz-button {
            background: none;
            border: none;
            color: #0087F7;
            cursor: pointer;
        }
        /* Add these if missing */
        .needsclick { cursor: pointer; }
        .dz-clickable { cursor: default; }

        .dropzone .dz-preview:hover .dz-image img {
            -webkit-transform: scale(1.05, 1.05);
            -moz-transform: scale(1.05, 1.05);
            -ms-transform: scale(1.05, 1.05);
            -o-transform: scale(1.05, 1.05);
            transform: scale(1.05, 1.05);
            -webkit-filter: blur(8px);
            filter: blur(0px);
        }

        .dz-preview:hover .dz-details {
            display: none !important; /* Hide file name and size on hover */
            transition: none !important; /* Disable unwanted hover effects */
        }
                
        .delete-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            padding: 4px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* Ensure it's above other elements */
            pointer-events: auto !important; /* Ensure clicks are detected */
        }


        
    </style>

    <style>
        .leaflet-control-locate a.leaflet-bar-part div {
            background-position: left 8px top 8px;
            background-repeat: no-repeat;
            width: 30px;
            height: 30px;
        }
        .leaflet-control-locate a.leaflet-bar-part div.loading {
            background-image: url(/assets/images/crosshair-3.svg);
        }
        .leaflet-control-locate a.leaflet-bar-part div.locate {
            background-image: url(/assets/images/crosshair-3.svg);
        }
    </style>
    <style>

        .leaflet-div-icon {
            margin: 0 !important;
            padding: 0 !important;
        }
        .dz-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
        }

        .dz-button:hover {
            background-color: #0056b3;
        }

        .dz-default.dz-message {
            padding-top: 20px;
            font-weight: bold;
            color: #007bff;  
        }

        .btn-primary.me-2 {margin-right: 5px;}

    </style>


    <style>
        /* Add this CSS to your stylesheet */
        .leaflet-popup-content img {
            max-width: 100%; /* Make sure images fit within the popup */
            height: auto;    /* Maintain aspect ratio */
        }
        /* Popup inner content styles */
        .tab-container {
        display: flex;
        border-bottom: 2px solid #ddd;
        }
        .tab {
        padding: 5px 20px;
        cursor: pointer;
        border: 1px solid #ddd;
        border-bottom: none;
        background: #f5f5f5;
        margin-right: 5px;
        }
        .tab.active {
        background: white;
        border-top: 2px solid blue;
        font-weight: bold;
        }
        .tab-content {
        padding: 5px;
        max-height: 800px;
        overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://unpkg.com/mapbox-gl-leaflet/leaflet-mapbox-gl.js"></script>
    <script>

        var map = L.map('map', {
            center: [50, 6],
            zoom: 11,
            zoomControl: false,
            layers: [] // Add windLayer here to activate it by default
        });
		
        L.control.zoom({
        position: 'bottomright',
        }).addTo(map);


        // Base Layers
        
		var awgTerrain = L.tileLayer('https://tile.jawg.io/jawg-terrain/{z}/{x}/{y}{r}.png?access-token=qBDXRu1KSlZGhx4ROlceBD9hcxmrumL34oj29tUkzDVkafqx08tFWPeRNb0KSoKa', {
            attribution: 'Jawg.io terrain'
        }).addTo(map);
		
		var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        });
        
        var xcontest = L.tileLayer('https://topo.xcontest.app/elev/{z}/{x}/{y}.jpg', {
            attribution: 'XContest&copy; <a href="https://www.xcontest.org">XContest</a>',
            className: 'xcontest-layer' // Add a class for CSS targeting
        });

        // MapLibre GL layer
        var mapTilerTerrain = L.mapboxGL({
            style: '/assets/maps/maptiler_terrain_wob_testxc.json', // Your MapLibre GL style URL
            apiKey: "c49iG8J3xvAkgCSZ8M8v",
            className: 'xcmap-layer' // Add a class for CSS targeting
        });
        var sat = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        });
         
        // Wind Stations Overlay
         var windLayer = L.layerGroup().addTo(map);

        // Airspaces Layer
        var oaipMap = L.tileLayer('https://a.api.tiles.openaip.net/api/data/openaip/{z}/{x}/{y}.png?apiKey=171189a4d43c6578ce63758f28363cb3');

        var airspaceEFG = L.layerGroup([]);

        var placesLayerPG = L.layerGroup(); 
        var placesLayerHG = L.layerGroup(); 
        var placesLayerLZ = L.layerGroup(); 

        // Tree structure
        var baseTree = {
            label: 'Base Maps',
                children: [
                    { label: 'Terrain', layer: awgTerrain },
                    { label: 'XContest', layer: L.layerGroup([xcontest, mapTilerTerrain])},
                    { label: 'OpenStreetMap', layer: osm },
                    //{ label: 'XContest + LibTerrain', layer: L.layerGroup([xcontest, mapTilerTerrain])}
                    { label: 'Satellite', layer: L.layerGroup([mapTilerTerrain, sat])}
                ]
        };

        var overlayTree = {
            label: 'Overlays',
            children: [
                { label: 'Wind Stations', layer: windLayer, checked: true },
                { label: 'Spots', 
                    children: [
                                { label: 'Take-off PG', layer: placesLayerPG },
                                { label: 'Take-off HG', layer: placesLayerHG },
                                { label: 'Landing Zones', layer: placesLayerLZ },
                            ]},
                { label: 'Airspaces', 
                  children: [
                            { label: 'Airspaces', layer: airspaceEFG },
                            { label: 'Gliding', layer: airspaceEFG },
                            { label: 'Notam', layer: airspaceEFG },
                            { label: 'OpenAIP Map', layer: oaipMap},
                        ]}
            ]
        };

        // Ensure the layer toggles visibility
            map.on('overlayadd', function (event) {
                if (event.name === "Places") {
                    map.addLayer(placesLayerPG);
                }
            });
            map.on('overlayremove', function (event) {
                if (event.name === "Places") {
                    map.removeLayer(placesLayerPG);
                }
            });
            map.on('overlayadd', function (event) {
                if (event.name === "Places") {
                    map.addLayer(placesLayerHG);
                }
            });
            map.on('overlayremove', function (event) {
                if (event.name === "Places") {
                    map.removeLayer(placesLayerHG);
                }
            });
            map.on('overlayadd', function (event) {
                if (event.name === "Places") {
                    map.addLayer(placesLayerLZ);
                }
            });
            map.on('overlayremove', function (event) {
                if (event.name === "Places") {
                    map.removeLayer(placesLayerLZ);
                }
            });

        // Add locate control 

        var lc = L.control
            .locate({  
                drawCircle: false, 
                keepCurrentZoomLevel:true,
                position: 'bottomright',
                icon: 'locate',
                iconLoading: 'loading',
                iconElementTag: 'div'
            }).addTo(map);

        // Add layer control tree
        var treeLayersControl = L.control.layers.tree(baseTree, overlayTree, {
            namedToggle: true,
            //collapseAll: 'Collapse all',
            //expandAll: 'Expand all',
            collapsed: false
        }).addTo(map);

        treeLayersControl.collapseTree().expandSelected();
		
        // Center map on user's location
		navigator.geolocation.getCurrentPosition(position => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            map.setView([userLat, userLng], 10);
            fetchWindStations(userLat, userLng);
        });

  // test

    </script>
    <script src="../components/windstations.js"></script>
    <script src="../components/airspaces.js"></script>
    <script src="../components/drop.js"></script>
    <script src="../components/spotsPG.js"></script>
    <script src="../components/spotsHG.js"></script>
    <script src="../components/spotsLZ.js"></script>

</body>
</html>
